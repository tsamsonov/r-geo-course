[
["circular.html", "Глава 8 Статистика направлений и времени 8.1 Предварительные требования 8.2 Статистика направлений 8.3 Статистика временных данных 8.4 Контрольные вопросы и упражнения", " Глава 8 Статистика направлений и времени 8.1 Предварительные требования Для работы по теме текущей лекции вам понадобятся пакеты из tidyverse. Помимо этого, необходимы методы круговой статистики из пакетов circular и NPCirc, и методы из пакета pracma. Для работы с временными данными мы воспользуемся пакетом lubridate, который входит в tidyverse, но автоматически не подключается в сессию. Мы также воспользуемся пакетом gganimate, который позволяет анимировать графики, построенные с помощью ggplot: library(tidyverse) library(circular) library(readxl) library(NPCirc) library(pracma) library(lubridate) library(gganimate) Пакет gganimate пока что не опубликован на CRAN, но доступен на GitHub. Для его установки последовательно выполните в консоли (не в скрипте!) следующие команды: install.packages(&#39;devtools&#39;) devtools::install_github(&#39;thomasp85/gganimate&#39;) После этого пакет можно подключать в привычном режиме: library(gganimate) 8.2 Статистика направлений 8.2.1 Теория 8.2.1.1 Распределение фон Мизеса В географии направления играют огромную роль. Ветер, морские течения, уличная сеть, перелеты птиц — все эти явления можно охарактеризовать их направленностью. Для того, чтобы эффективно анализировать такие данные, необходимо владеть специализированным математическим аппаратом. Обработкой данных о направлениях занимается особая область математической статистики — статистика направлений, или круговая (циркулярная) статистика (Mardia, Jupp, 2000; Pewsey et al., 2013). В круговой статистике каждое направление \\(\\theta \\in [0, 2\\pi)\\) представляется в виде вектора \\(x = (\\cos \\theta, sin \\theta)\\). Все операции производятся над подобными векторами и их координатами. Аналогом нормального распределения для круговой случайной величины является распределение фон Мизеса (von Mises, 1918), которое задается функцией плотности вероятности: \\[ f(θ)=\\frac{1}{2 \\pi I_0(\\kappa)} e^{\\kappa \\cos (\\theta - \\mu)}, \\] где \\(\\kappa \\geq 0\\) — параметр концентрации, \\(\\mu\\) — среднее значение (для \\(\\kappa &gt; 0\\)) и \\[ I_p(\\kappa) = \\frac{1}{2π} \\int_{0}^{2\\pi} \\cos (p \\theta) e^{\\kappa \\cos θ} d \\theta \\] есть модифицированная функция Бесселя первого рода и порядка \\(p\\). Из формул видно, что по своему эффекту параметр концентрации противоположен среднеквадратическому отклонению \\(\\sigma\\), которое является параметром нормального распределения. Чем больше значение \\(\\kappa\\), тем более сконцентрировано распределение относительно среднего значения — отсюда идет название этого параметра. Распределение фон Мизеса используется для построения ядра при аппроксимации плотности распределения направлений методом ядерной оценки (оценки по методу Парзена-Розенблатта). В метеорологии значения \\(\\cos \\theta\\) и \\(\\sin \\theta\\) определяют соотношение зональной и меридиональной составляющей скорости [ветра] (для получения самих составляющих их надо умножить на скорость ветра). 8.2.1.2 Вычисление статистических моментов Для вычисления статистических моментов круговой случайной величины требуется найти средний равнодействующий вектор первого порядка \\(R = (C, S)\\), где \\(C = \\frac{1}{n} \\sum_{j=1}^{n} \\cos \\theta_j\\), \\(S = \\frac{1}{n} \\sum_{j=1}^{n} \\sin \\theta_j\\). Данный вектор имеет направление \\(\\bar\\theta\\), которое является выборочным средним направлением исследуемой величины. Выборочная средняя равнодействующая длина \\(\\bar R = \\sqrt{C^2 + S^2}\\) принимает значения в диапазоне \\([0, 1]\\) и показывает меру концентрации направлений относительно \\(\\theta\\). \\(\\bar R = 1\\) означает, что все исходные направления совпадают, \\(\\bar R = 0\\) — что данные равномерно распределены по кругу, либо распределение имеет несколько мод, которые уравновешивают друг друга. Стандартное отклонение направлений \\(v\\) в радианах может быть найдено как \\(v=\\sqrt{-2 \\ln \\bar R}\\) (Mardia, Jupp, 2000). Величина \\(\\bar R\\) дает важную информацию для предварительной диагностики картины направлений. Если значение \\(\\bar R\\) близко к единице, это означает, что распределение является унимодальным и в качестве основного направления можно принять значение \\(\\bar θ\\). В ряде случаев противоположные направления считаются эквивалентными. Например, нельзя сказать, идет ли улица с юга на север или с севера на юг. Такие данные в теории круговой статистики называются аксиальными (Mardia, Jupp, 2000). Для аксиальных данных возможный диапазон значений лежит в интервале \\([0, \\pi)\\). Поскольку методы круговой статистики рассчитаны на круговое замыкание данных, стандартный подход к обработке аксиальных данных предполагает переход от направлений к их удвоенным значениям \\(\\theta&#39; = 2\\theta\\), обработку полученных значений стандартными методами и отображение полученных значение обратно на интервал \\([0, \\pi)\\). Для среднего, медианы и моды распределения это означает простое деление полученного значения пополам (Pewsey et al., 2013). 8.2.1.3 Определение модальных направлений Модальные направления могут быть определены как по гистограмме распределения, так и методом ядерной оценки. Основной вопрос поиска эффективного ядра заключается в параметризации функции \\(K\\). Для распределения фон Мизеса таким параметром является концентрация \\(\\kappa\\). Чем больше этот параметр, тем более локализованной будет оценка, тем сильнее будут проявляться в ней существующие моды распределения, но также будут и выделяться новые моды, которые на самом деле не значимы. Малые значения \\(\\kappa\\) приведут, наоборот, к «размыванию» плотности распределения в пределах полного круга. Как и в случае с количеством интервалов гистограммы, избыточно малые и большие значения κ нежелательны. Показано, что оптимальное значение κ может быть подобрано также для оценки распределений, являющихся конечной суммой \\(M\\) распределений фон Мизеса, то есть, мультимодальных распределений, имеющих плотность (Oliveira et al., 2012): \\[ g(\\theta)=\\sum_{i=1}^{M} \\alpha_i \\frac{\\exp\\lbrace{\\kappa_i \\cos(\\theta - \\mu_i)\\rbrace}}{2 \\pi I_0 (\\kappa_i)}, \\] где \\(\\sum_{i=1}^{M} = 1\\). Поскольку в результате подбора определяется не только параметр концентрации, но и число компонент в сумме распределений (Oliveira et al., 2014), его можно также использовать для определения количества искомых мод, если это необходимо. Когда подобрана функция ядра и ее параметры, оценка плотности распределения (вычисление функции \\(\\circ f _h (x)\\)) для круговых данных делается либо для исходных направлений \\(\\theta_j\\), либо с равным (достаточно малым) интервалом — например, через 1 градус (Pewsey et al., 2013). После того как произведена оценка, могут быть выбраны направления, в которых функция плотности распределения достигает локального максимума — первого и второго по величине. Эти направления и будут соответствовать первой и второй моде распределения направлений. 8.2.2 Практика В практической части данного раздела мы будем работать с массивом среднемесячных значений метеопараметров в пограничном слое атмосферы по полярным аэрологическим обсерваториям России. Массив данных ежемесячно обновляется на портале Аисори-М ВНИИГМИ-МЦД. В системе доступны данные по следующим обсерваториям: obs = readxl::read_excel(&#39;bound/scheme.xlsx&#39;, 2) Индекс Название Широта Долгота 20674 Остров Диксон 73.50 80.42 21824 Тикси 71.35 128.55 22113 Мурманск 68.59 33.07 22217 Кандалакша 67.09 32.21 22271 Шойна 67.53 44.09 23078 Норильск 69.20 88.18 23205 Нарьян-Мар 67.39 53.07 23330 Салехард 66.32 66.40 24125 Оленек 68.31 112.26 24266 Верхоянск 67.55 133.38 24343 Жиганск 66.46 123.21 89512 Новолазаревская -70.75 11.83 89592 Мирный -66.65 19.71 Для каждой обсерватории даны следующие параметры: Призначная часть/ метеоэлемент/число наблюдений Обозначение Число цифр Единицы измерения Константа отсутствия Индекс станции INDEX 5 - нет Год GGGG 5 - нет Месяц MM 3 - нет Срок HH 3 GMT нет Стандартное значение высоты Z 6 м нет Среднемесячные значения давления MP 6 10·гПа -9999 Среднеквадратические отклонения давления SP 6 10·гПа -9999 Число наблюдений для давления NP 3 - нет Среднемесячные значения температуры MT 6 10·°C -9999 Среднеквадратические отклонения температуры ST 6 10·°C -9999 Число наблюдений для температуры NT 3 - нет Среднемесячные значения дефицита точки росы MD 6 10·°C -9999 Среднеквадратические отклонения дефицита точки росы SD 6 10·°C -9999 Число наблюдений для дефицита точки росы ND 3 - нет Среднемесячные значения скалярной скорости ветра MS 6 10·м/с -9999 Среднеквадратические отклонения скалярной скорости ветра SS 6 10·м/с -9999 Число наблюдений для скалярной скорости ветра NS 3 - нет Среднемесячные значения зональной составляющей скорости ветра MU 6 10·м/с -9999 Среднеквадратические отклонения зональной составляющей скорости ветра SU 6 10·м/с -9999 Число наблюдений для зональной составляющей скорости ветра NU 3 - нет Среднемесячные значения меридиональной составляющей скорости ветра MV 6 10·м/с -9999 Среднеквадратические отклонения меридиональной составляющей скорости ветра SV 6 10·м/с -9999 Число наблюдений для меридиональной составляющей скорости ветра NV 3 - нет Загрузим данные по всем обсерваториям из текстовых файлов в папке bound: files = paste(&#39;bound&#39;, list.files(&#39;bound&#39;, &quot;*.txt&quot;), sep = &#39;/&#39;) (tab = lapply(files, function(X) readr::read_table(X, col_names = params$Обозначение)) %&gt;% bind_rows() %&gt;% left_join(obs, by = c(&#39;INDEX&#39; = &#39;Индекс&#39;))) # присоединим информацию о названиях станций ## # A tibble: 77,073 x 26 ## INDEX GGGG MM HH Z MP SP NP MT ST NT MD ## &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; ## 1 20674 2007 1 0 2000 7629 78 27 -187 35 27 53 ## 2 20674 2007 1 0 1900 7732 79 27 -182 36 27 52 ## 3 20674 2007 1 0 1800 7836 79 27 -178 36 27 51 ## 4 20674 2007 1 0 1700 7942 80 27 -173 36 27 49 ## 5 20674 2007 1 0 1600 8048 81 27 -168 36 27 48 ## 6 20674 2007 1 0 1500 8157 81 27 -164 38 27 47 ## 7 20674 2007 1 0 1400 8266 82 27 -160 39 27 45 ## 8 20674 2007 1 0 1300 8376 82 27 -156 39 27 43 ## 9 20674 2007 1 0 1200 8488 83 27 -152 40 27 40 ## 10 20674 2007 1 0 1100 8601 83 27 -148 41 27 37 ## # ... with 77,063 more rows, and 14 more variables: SD &lt;int&gt;, ND &lt;int&gt;, ## # MS &lt;int&gt;, SS &lt;int&gt;, NS &lt;int&gt;, MU &lt;int&gt;, SU &lt;int&gt;, NU &lt;int&gt;, MV &lt;int&gt;, ## # SV &lt;int&gt;, NV &lt;int&gt;, Название &lt;chr&gt;, Широта &lt;dbl&gt;, Долгота &lt;dbl&gt; Создадим объект типа circular (из пакета circular) с направлениями ветра для анализа, и запишем его в новую переменую таблицы. Предварительно определим вспомогательную функцию, вычисляющую географический азимут на основе компонент скорости: geo_azimuth = function(dx, dy) { a = atan2(dx, dy) ifelse(a &lt;= pi/2, pi/2 - a, 5*pi/2 - a) } (winds = tab %&gt;% mutate(wind = circular(geo_azimuth(MV, MU), template = &#39;geographics&#39;)) %&gt;% select(INDEX, name = Название, GGGG, MM, HH, Z, MU, MV, SS, wind)) ## # A tibble: 77,073 x 10 ## INDEX name GGGG MM HH Z MU MV SS wind ## &lt;dbl&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;S3: circul&gt; ## 1 20674 Остров Ди… 2007 1 0 2000 33 31 45 0.8166380 ## 2 20674 Остров Ди… 2007 1 0 1900 32 32 45 0.7853982 ## 3 20674 Остров Ди… 2007 1 0 1800 30 33 46 0.7378151 ## 4 20674 Остров Ди… 2007 1 0 1700 29 35 47 0.6919214 ## 5 20674 Остров Ди… 2007 1 0 1600 28 38 49 0.6350267 ## 6 20674 Остров Ди… 2007 1 0 1500 26 40 50 0.5763752 ## 7 20674 Остров Ди… 2007 1 0 1400 25 41 51 0.5475622 ## 8 20674 Остров Ди… 2007 1 0 1300 25 42 54 0.5369107 ## 9 20674 Остров Ди… 2007 1 0 1200 24 45 56 0.4899573 ## 10 20674 Остров Ди… 2007 1 0 1100 24 49 58 0.4554511 ## # ... with 77,063 more rows Выберем данные по высоте 0 метров за 12 часов дня для поселка Тикси, сохранив только составляющие скорости и ее скалярную величину: (tiksi_wind = winds %&gt;% filter(name == &#39;Тикси&#39;, HH == 12, Z == 0)) ## # A tibble: 136 x 10 ## INDEX name GGGG MM HH Z MU MV SS wind ## &lt;dbl&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;S3: circular&gt; ## 1 21824 Тикси 2007 1 12 0 36 35 48 0.7994817 ## 2 21824 Тикси 2007 2 12 0 16 11 27 0.9685090 ## 3 21824 Тикси 2007 3 12 0 23 22 34 0.8076167 ## 4 21824 Тикси 2007 4 12 0 17 9 30 1.0838971 ## 5 21824 Тикси 2007 5 12 0 -17 -3 34 4.5377168 ## 6 21824 Тикси 2007 6 12 0 -23 -25 27 3.8853482 ## 7 21824 Тикси 2007 7 12 0 -5 -11 27 3.5682201 ## 8 21824 Тикси 2007 8 12 0 4 5 25 0.6747409 ## 9 21824 Тикси 2007 9 12 0 24 14 34 1.0427219 ## 10 21824 Тикси 2007 10 12 0 41 47 40 0.7173217 ## # ... with 126 more rows Отобразим распределение направлений, розу-диаграмму и плотность распределения. Для построени графиков используем функции plot.circular() и rose.diag из пакета circular. Для аппроксимации плотности распределения направлений воспользуемся функцией kern.den.circ() из пакета NPCirc. Эта функция использует функцию плотности распределения фон Мизеса в качестве ядра и по умолчанию разбивает круг на 250 направлений, по которым производится оценка плотности (при необходимости это значение можно изменить в параметре len): plot.circular(tiksi_wind$wind, cex = 0.5, stack = TRUE, sep = 0.035, axes = FALSE, main = &#39;Среднемноголетняя роза ветров в Тикси&#39;, sub = &#39;Измерения за период с 2007 по 2018 г, высота 0 м&#39;) rose.diag(tiksi_wind$wind, bins = 8, col = &#39;gray70&#39;, border = &#39;gray30&#39;, prop = 1, add = TRUE, tick = FALSE, lwd = 0.5) kden = kern.den.circ(tiksi_wind$wind) lines(kden, shrink = 3, # параметр shrink отвечает за масштаб радиус-вектора join = F, col = &#39;steelblue&#39;) Параметр shrink отвечает за масштаб радиус-вектора на графиках из пакета circular. Чем больше его величина, тем сильнее будет сжат график относительно центра круга. Так же как и в случае с обычными данными, плотность распределения удобно использовать для определения модальных направлений, то есть наиболее часто встречающихся. Для этого воспользуемся функцией findpeaks() из пакета pracma: peak = findpeaks(kden$y, sortstr = T)[1,2] # находим индекс самого высокого пика плотности распределения (modal = kden$x[peak]) # извлекаем сам угол ## Circular Data: ## Type = angles ## Units = radians ## Template = geographics ## Modulo = asis ## Zero = 1.570796 ## Rotation = clock ## [1] 0.813786 # раскладываем на составляющие для отрисовки линии xp = sin(modal) yp = cos(modal) plot.circular(tiksi_wind$wind, cex = 0.5, stack = TRUE, sep = 0.035, axes = FALSE, main = &#39;Среднемноголетняя роза ветров в Тикси&#39;, sub = &#39;Измерения за период с 2007 по 2018 г, высота 0 м&#39;) rose.diag(tiksi_wind$wind, bins = 8, col = &#39;gray70&#39;, border = &#39;gray30&#39;, prop = 1, add = TRUE, tick = FALSE, lwd = 0.5) lines(kden, shrink = 3, join = F, col = &#39;steelblue&#39;) lines(c(0, xp), c(0, yp), lwd = 2, col = &#39;orangered&#39;) text(x = 1.4 * xp, y = 1.4 * yp, col = &#39;orangered&#39;, labels = paste0(round(180 * modal / pi, 0), &#39;°&#39;)) # приводим к целым градусам Проведем анализ направлений для всех станций. Для этого рассчитаем функции плотности распределения и разместим их в новом фрейме данных с лист-колонкой. Лист-колонка (list-column) позволяет хранить в ячейках таблицы данные произвольного типа. В частности, используя лист-колонку, вы можете хранить в каждой ячейке не один объект, а множество объектов, например записать в нее вектор. Лист-колонка имеет тип list, и каждая ячейка в этой колонке так же, соответственно, имеет тип list. Что (и в каком количестве) располагать внутри ячейки — уже ваше дело. Лист-колонки оказываются неожиданно удобны в самых разнообразных сценариях, в том числе для представления статистических моделей (соответствующих каждой строке таблицы) и для хранения пространственных данных (об этом — в следующей лекции). Вместо хранения этих данных в отдельных переменных вы можете записать их в ячейки. В приведенном ниже коде мы группируем все измерения по имени аэрологической обсерватории, вычисляем вектор плотности распределения, записываем его в список, и этот список уже помещается функцией summarise() в единственную ячейку столбца kden, соответствующую данной аэрологической станции. Далее полученная лист-колонка используется для нахождения модальных значений (тут оказывается полезно знание функционалов семейства apply): (dens = winds %&gt;% filter(HH == 12, Z == 0) %&gt;% group_by(name) %&gt;% summarise(kden = list(kern.den.circ(wind))) %&gt;% mutate(peak = sapply(kden, function(X) { peak = findpeaks(X$y, sortstr = T)[1,2] X$x[peak] }) ) ) ## # A tibble: 13 x 3 ## name kden peak ## &lt;chr&gt; &lt;list&gt; &lt;dbl&gt; ## 1 Верхоянск &lt;S3: density.circular&gt; -2.97 ## 2 Жиганск &lt;S3: density.circular&gt; -3.20 ## 3 Кандалакша &lt;S3: density.circular&gt; -0.347 ## 4 Мирный &lt;S3: density.circular&gt; -0.826 ## 5 Мурманск &lt;S3: density.circular&gt; 0.814 ## 6 Нарьян-Мар &lt;S3: density.circular&gt; 1.04 ## 7 Новолазаревская &lt;S3: density.circular&gt; -0.902 ## 8 Норильск &lt;S3: density.circular&gt; -0.877 ## 9 Оленек &lt;S3: density.circular&gt; -3.48 ## 10 Остров Диксон &lt;S3: density.circular&gt; -0.145 ## 11 Салехард &lt;S3: density.circular&gt; -2.82 ## 12 Тикси &lt;S3: density.circular&gt; 0.814 ## 13 Шойна &lt;S3: density.circular&gt; 0.561 После этого построим розы-диаграммы для всех станций. В данном случае оправдано использование обычного цикла, т.к. итераций немного: # устанавливаем параметры компоновки par(mar = c(1,1,1,1), mfrow = c(1,2)) # строим графики в цикле for (obs_name in dens$name) { wind_df = winds %&gt;% filter(name == obs_name, HH == 12, Z == 0) dens_df = dens %&gt;% filter(name == obs_name) modal = dens_df$peak xp = sin(modal) yp = cos(modal) plot.circular(wind_df$wind, shrink = 1.2, cex = 0.5, stack = TRUE, sep = 0.035, axes = FALSE, main = obs_name) rose.diag(wind_df$wind, bins = 8, col = &#39;gray70&#39;, border = &#39;gray30&#39;, prop = 1, add = TRUE, tick = FALSE, lwd = 0.5) lines(dens_df$kden[[1]], shrink = 3, join=F, col = &#39;steelblue&#39;) lines(c(0, xp), c(0, yp), lwd = 2, col = &#39;orangered&#39;) text(x = 1.4 * xp, y = 1.4 * yp, col = &#39;orangered&#39;, labels = paste0(round(180 * modal / pi, 0), &#39;°&#39;)) # приводим к целым градусам } Таким образом, мы провели графический и статистический анализ среднемноголетних направлений ветра по данным полярных аэрологических станций России. Выявлены модальные направлений, выполнена аппроксимация функции плотности вероятности направлений ветра. 8.3 Статистика временных данных 8.3.1 Работа с датами в lubridate 8.3.2 Проверка гипотез 8.3.3 Анимация 8.4 Контрольные вопросы и упражнения 8.4.1 Вопросы В каком виде направления рассматриваются в круговой статистике? Какое распределение является аналогом нормального распределения для круговых данных? Что означают параметры \\(\\kappa\\) и \\(\\mu\\) в функции этого распределения? Как вычисляется равнодействующий вектор первого порядка и выборочная средняя равнодействующая длина этого вектора для направлений? Чем аксиальные данные отличаются от круговых данных в общем случае? Какие преобразования осуществляются над такими данными для того чтобы применять к ним стандартные методы циркулярной статистики? Какой класс данных (и пакет) можно использовать в R для представления направлений? Как указать, что направления отсчитываются географическим методом, то есть, по часовой стрелки от направления на север? Какую функцию можно использовать для для оценки плотности распределения круговых данных? В каком пакете она находится? Какую функцию можно использовать для выявления модальных направлений по данным функции плотности вероятности? Какие функции позволяют строить диаграммы и розы-диаграммы по круговым данным в среде R? Какой параметр управляет масштабом радиус-вектора на круговых графиках? Что такое лист-колонка в фрейме данных, и какого типа данные можно в ней хранить? 8.4.2 Упражнения Самсонов Т.Е. Визуализация и анализ географических данных на языке R. М.: Географический факультет МГУ, 2017. DOI: 10.5281/zenodo.901911 "]
]
