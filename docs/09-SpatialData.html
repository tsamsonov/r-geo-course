<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.510">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Визуализация и анализ географических данных на языке R - 9&nbsp; Пространственные данные</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./10-Maps.html" rel="next">
<link href="./08-AdvStats.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./09-SpatialData.html">Пространственные данные и карты</a></li><li class="breadcrumb-item"><a href="./09-SpatialData.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Пространственные данные</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Визуализация и анализ географических данных на языке R</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Введение</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Основы</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-Basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Типы данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-DataStructures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Структуры данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Таблицы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Функции</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Графика и статистика</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-BaseGraphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Базовая графика</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-AdvGraphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Продвинутая графика</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-BaseStats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Основы статистики</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-AdvStats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Временные ряды</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Пространственные данные и карты</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-SpatialData.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Пространственные данные</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Основы картографии</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-ThematicMaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Тематические карты</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-3DModels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Трехмерные модели</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Пространственный анализ</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-VectorAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Векторный анализ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-RasterAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Растровый анализ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-Interpolation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Интерполяция геополей</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-NetworkAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Сетевой анализ</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Библиография</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#spatial_prerequisites" id="toc-spatial_prerequisites" class="nav-link active" data-scroll-target="#spatial_prerequisites"><span class="header-section-number">9.1</span> Предварительные требования</a></li>
  <li><a href="#spatial_models" id="toc-spatial_models" class="nav-link" data-scroll-target="#spatial_models"><span class="header-section-number">9.2</span> Модели пространственных данных</a></li>
  <li><a href="#vector_data_r" id="toc-vector_data_r" class="nav-link" data-scroll-target="#vector_data_r"><span class="header-section-number">9.3</span> Векторные данные</a>
  <ul class="collapse">
  <li><a href="#simple_features" id="toc-simple_features" class="nav-link" data-scroll-target="#simple_features"><span class="header-section-number">9.3.1</span> Simple Features</a></li>
  <li><a href="#vector_data_packages" id="toc-vector_data_packages" class="nav-link" data-scroll-target="#vector_data_packages"><span class="header-section-number">9.3.2</span> Базовые библиотеки</a></li>
  <li><a href="#vector_data_reading" id="toc-vector_data_reading" class="nav-link" data-scroll-target="#vector_data_reading"><span class="header-section-number">9.3.3</span> Чтение</a></li>
  <li><a href="#sf_structure" id="toc-sf_structure" class="nav-link" data-scroll-target="#sf_structure"><span class="header-section-number">9.3.4</span> Внутренняя структура</a></li>
  <li><a href="#sf_plotting" id="toc-sf_plotting" class="nav-link" data-scroll-target="#sf_plotting"><span class="header-section-number">9.3.5</span> Визуализация</a></li>
  <li><a href="#sf_attrs" id="toc-sf_attrs" class="nav-link" data-scroll-target="#sf_attrs"><span class="header-section-number">9.3.6</span> Атрибутивные операции</a></li>
  <li><a href="#sf_creation" id="toc-sf_creation" class="nav-link" data-scroll-target="#sf_creation"><span class="header-section-number">9.3.7</span> Создание пространственных объектов</a></li>
  <li><a href="#sf_geom_attrs" id="toc-sf_geom_attrs" class="nav-link" data-scroll-target="#sf_geom_attrs"><span class="header-section-number">9.3.8</span> Геометрические атрибуты</a></li>
  <li><a href="#sf_export" id="toc-sf_export" class="nav-link" data-scroll-target="#sf_export"><span class="header-section-number">9.3.9</span> Экспорт</a></li>
  </ul></li>
  <li><a href="#raster_data_r" id="toc-raster_data_r" class="nav-link" data-scroll-target="#raster_data_r"><span class="header-section-number">9.4</span> Растровые данные</a>
  <ul class="collapse">
  <li><a href="#raster_data" id="toc-raster_data" class="nav-link" data-scroll-target="#raster_data"><span class="header-section-number">9.4.1</span> Теоретические сведения</a></li>
  <li><a href="#raster_read" id="toc-raster_read" class="nav-link" data-scroll-target="#raster_read"><span class="header-section-number">9.4.2</span> Чтение</a></li>
  <li><a href="#stars_inner" id="toc-stars_inner" class="nav-link" data-scroll-target="#stars_inner"><span class="header-section-number">9.4.3</span> Внутренняя структура</a></li>
  <li><a href="#raster_viz" id="toc-raster_viz" class="nav-link" data-scroll-target="#raster_viz"><span class="header-section-number">9.4.4</span> Визуализация</a></li>
  <li><a href="#raster_crop" id="toc-raster_crop" class="nav-link" data-scroll-target="#raster_crop"><span class="header-section-number">9.4.5</span> Обрезка</a></li>
  <li><a href="#индексирование" id="toc-индексирование" class="nav-link" data-scroll-target="#индексирование"><span class="header-section-number">9.4.6</span> Индексирование</a></li>
  <li><a href="#манипуляции" id="toc-манипуляции" class="nav-link" data-scroll-target="#манипуляции"><span class="header-section-number">9.4.7</span> Манипуляции</a></li>
  <li><a href="#raster_export" id="toc-raster_export" class="nav-link" data-scroll-target="#raster_export"><span class="header-section-number">9.4.8</span> Экспорт</a></li>
  </ul></li>
  <li><a href="#spatref" id="toc-spatref" class="nav-link" data-scroll-target="#spatref"><span class="header-section-number">9.5</span> Пространственная привязка</a>
  <ul class="collapse">
  <li><a href="#spatref_components" id="toc-spatref_components" class="nav-link" data-scroll-target="#spatref_components"><span class="header-section-number">9.5.1</span> Компоненты пространственной привязки</a></li>
  <li><a href="#spatref_formats" id="toc-spatref_formats" class="nav-link" data-scroll-target="#spatref_formats"><span class="header-section-number">9.5.2</span> Форматы описания пространственной привязки</a></li>
  <li><a href="#spatref_transform" id="toc-spatref_transform" class="nav-link" data-scroll-target="#spatref_transform"><span class="header-section-number">9.5.3</span> Преобразование координат</a></li>
  <li><a href="#sf_crs" id="toc-sf_crs" class="nav-link" data-scroll-target="#sf_crs"><span class="header-section-number">9.5.4</span> Работа с пространственной привязкой в R</a></li>
  </ul></li>
  <li><a href="#temporal_review" id="toc-temporal_review" class="nav-link" data-scroll-target="#temporal_review"><span class="header-section-number">9.6</span> Краткий обзор</a></li>
  <li><a href="#questions_tasks_spatial" id="toc-questions_tasks_spatial" class="nav-link" data-scroll-target="#questions_tasks_spatial"><span class="header-section-number">9.7</span> Контрольные вопросы и упражнения</a>
  <ul class="collapse">
  <li><a href="#questions_spatial" id="toc-questions_spatial" class="nav-link" data-scroll-target="#questions_spatial"><span class="header-section-number">9.7.1</span> Вопросы</a></li>
  <li><a href="#tasks_spatial" id="toc-tasks_spatial" class="nav-link" data-scroll-target="#tasks_spatial"><span class="header-section-number">9.7.2</span> Упражнения</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./09-SpatialData.html">Пространственные данные и карты</a></li><li class="breadcrumb-item"><a href="./09-SpatialData.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Пространственные данные</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="spatial" class="quarto-section-identifier"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Пространственные данные</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="spatial_prerequisites" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="spatial_prerequisites"><span class="header-section-number">9.1</span> Предварительные требования</h2>
<p>Данный модуль посвящен введению в работу с пространственными данными в R. Рассмотрены общие вопросы моделирования реального мира средствами моделей пространственных данных. Рассматривается чтение векторных и растровых данных, их визуализация стандартными средствами.</p>
<p>Необходимые для работы пакеты:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="spatial_models" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="spatial_models"><span class="header-section-number">9.2</span> Модели пространственных данных</h2>
<p><strong>Пространственные данные</strong> (spatial data) — это данные о пространственных объектах и их наборах. В свою очередь, пространственный объект определяется как <em>цифровая модель материального или абстрактного объекта реального или виртуального мира с указанием его идентификатора, координатных и атрибутивных данных</em> <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>Если говорить по сути, то пространственные данные можно определить как <em>данные о географических объектах или явлениях, фиксирующие их местоположение и/или распределение в системе координат, привязанной к телу Земли или любого другого небесного тела</em>. Таким образом, отличительной особенностью пространственных данных перед непространственными является координатное описание местоположения. На профессиональном жаргоне пространственные данные также часто называют <strong>геоданными</strong>. Следует помнить, что этот термин не является научным, и его не следует использовать в публикациях и квалификационных работах.</p>
<p>Важно знать отличия между векторной и растровой моделью пространственных данных.</p>
<p><strong>Векторная модель</strong> пространственных данных включает описание координатных данных пространственных объектов и, опционально, топологических отношений между ними. Векторные данные фиксируют местоположение и форму объектов в виде геометрических примитивов, таких как точки, линии, полигоны, объемные тела. Выбор модели объекта (например, представить город точкой или полигоном) зависит от масштаба анализа и целей исследования. Векторная модель данных является объектно-ориентированной.</p>
<p><strong>Растровая модель</strong> описывает не объекты, а пространственное распределение некоторой (выбранной исследователем) характеристики. Пространство разбивается регулярной сеткой ячеек, в каждой ячейке фиксируется значение исследуемого параметра (путем статистического осреднения, семплирования в центре ячейки и т.п.). Растровые данные могут быть как количественными (например, поле температуры), так и качественными (например, растр классифицированного снимка, каждая ячейка которого фиксирует принадлежность к тому или иному типу объекта). Таким образом, растровая модель является пространственно-ориентированной (или феномен-ориентированной).</p>
<p>Существуют и другие модели пространственных данных, однако их рассмотрение выходит за рамки настоящей лекции.</p>
<p>В настоящей лекции мы познакомимся с чтением и визуализацией пространственных данных в векторном и растровом формате, а также рассмотрим вопросы связанные с использованием картографических проекций.</p>
</section>
<section id="vector_data_r" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="vector_data_r"><span class="header-section-number">9.3</span> Векторные данные</h2>
<section id="simple_features" class="level3" data-number="9.3.1">
<h3 data-number="9.3.1" class="anchored" data-anchor-id="simple_features"><span class="header-section-number">9.3.1</span> Simple Features</h3>
<p><strong>Simple Features</strong> (официально <em>Simple Features Access</em>) — это стандарт <a href="http://www.opengeospatial.org/standards/sfa">OGC 06-103</a>, разработанный Open Geospatial Consortium (OGC) и реализованный также в виде международного стандарта <a href="https://www.iso.org/standard/40114.html">ISO 19125</a>, который определяет общую модель хранения и доступа к векторным объектам (точка, линия, многоугольник, мульти точечные, мультилинии и т. д.), в географических информационных системах.</p>
<p>Геометрическое представление пространственных объектов базируется на следующих принципах:</p>
<ul>
<li>Все геометрии состоят из точек.</li>
<li>Точки являются координатами в 2-, 3- или 4-мерном пространстве.</li>
<li>Все точки в геометрии имеют одинаковую размерность.</li>
</ul>
<p>В дополнение к координатам <span class="math inline">\(X\)</span> и <span class="math inline">\(Y\)</span> имеются два дополнительных дополнительных параметра:</p>
<ul>
<li>координата <span class="math inline">\(Z\)</span>, обозначающая высоту</li>
<li>координата <span class="math inline">\(M\)</span>, обозначающая некоторую меру, связанную с точкой, а не с признаком в целом (в этом случае это будет атрибут объекта). Измерение <span class="math inline">\(M\)</span> может быть использовано, например, для представления времени или линейных координат (для маршрутов).</li>
</ul>
<p>Координаты простой геометрии всегда содержат компоненты <span class="math inline">\(X\)</span> и <span class="math inline">\(Y\)</span>, поэтому все разнообразие возможных представлений определяется наличием или отсутствием дополнительных измерений <span class="math inline">\(Z\)</span> и <span class="math inline">\(M\)</span>. Таким образом, получаем <strong>четыре</strong> варианта геометрии:</p>
<ul>
<li>двумерные точки <span class="math inline">\(XY\)</span></li>
<li>трехмерные точки <span class="math inline">\(XYZ\)</span></li>
<li>трехмерные точки <span class="math inline">\(XYM\)</span></li>
<li>четырехмерные точки <span class="math inline">\(XYZM\)</span></li>
</ul>
<p>В случае использования широт и долгот <span class="math inline">\(X\)</span> соответствует долготе, <span class="math inline">\(Y\)</span> соответствует широте.</p>
<p>Всего стандарт <strong>Simple Features</strong> включает в себя 17 типов геометрий. Из них наиболее употребительными являются следующие 7:</p>
<table class="table">
<colgroup>
<col style="width: 8%">
<col style="width: 91%">
</colgroup>
<thead>
<tr class="header">
<th>Тип</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>POINT</code></td>
<td>нуль-мерная геометрия, содержащая одну точку</td>
</tr>
<tr class="even">
<td><code>LINESTRING</code></td>
<td>последовательность точек, соединенных прямыми, несамопересекающимися отрезками; одномерная геометрия</td>
</tr>
<tr class="odd">
<td><code>POLYGON</code></td>
<td>геометрия с положительной площадью (двумерная); последовательность точек, отрезки между которыми формируют замкнутое кольцо без самопересечений; первое кольцо является внешним, ноль и более остальных колец представляют дырки внутри полигона</td>
</tr>
<tr class="even">
<td><code>MULTIPOINT</code></td>
<td>множество точек; геометрия типа <code>MULTIPOINT</code> называется <em>простой</em> если ни одна пара точек в <code>MULTIPOINT</code> не совпадает</td>
</tr>
<tr class="odd">
<td><code>MULTILINESTRING</code></td>
<td>множество линий</td>
</tr>
<tr class="even">
<td><code>MULTIPOLYGON</code></td>
<td>множество полигонов</td>
</tr>
<tr class="odd">
<td><code>GEOMETRYCOLLECTION</code></td>
<td>множество геометрий произвольного типа за исключением <code>GEOMETRYCOLLECTION</code></td>
</tr>
</tbody>
</table>
<p>Примеры различных видов геометрий представлены на рисунке ниже:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Оставшиеся виды геометрий <em>Simple Features</em> включают: <code>CIRCULARSTRING</code>, <code>COMPOUNDCURVE</code>, <code>CURVEPOLYGON</code>, <code>MULTICURVE</code>, <code>MULTISURFACE</code>, <code>CURVE</code>, <code>SURFACE</code>, <code>POLYHEDRALSURFACE</code>, <code>TIN</code>, <code>TRIANGLE</code>.</p>
<p>Существует два официально закрепленных формата представления SF: <em>Well-Known Text (WKT)</em> и <em>Well-Known Binary (WKB)</em>, которые необходимы для чтения таких данных человеком и машиной соответственно.</p>
<p><strong>Well-Known Text (WKT)</strong> — стандарт представления геометрии в виде множества списков координат, в которых координаты вершин разделены пробелами, вершины разделены запятыми, а компоненты полигонов и мультигеометрий заключены в круглые скобки и также разделены запятыми. Вышеприведенной картинке соответствуют следующие строки <em>WKT</em>:</p>
<div class="cell">
<pre><code>## POINT (0.5 0.5)
## LINESTRING (0 1, 0.5 1.5, 1.2 1.2, 2 1.3, 3 2)
## POLYGON ((0.5 0.5, 2 0, 3 2, 1.5 4, 0 3, 0.5 0.5), (1 1, 0.8 2, 2 2.2, 1.4 1.1, 1 1))
## MULTIPOINT ((0.5 0.5), (1 3), (2 1), (0.2 2), (2 3), (1.5 1.5))
## MULTILINESTRING ((0.5 1.5, 1.2 1.2, 2 1.3), (0 1.5, 0.5 2, 1.2 1.7), (2 1.8, 3 2.5))
## MULTIPOLYGON (((0.5 0.5, 2 0, 3 2, 1.5 4, 0 3, 0.5 0.5), (1 1, 0.8 2, 2 2.2, 1.4 1.1, 1 1)), ((3 3.3, 3.5 3.1, 4 3, 4 3.7, 3.7 3.96, 3.2 4, 3 3.3), (3.2 3.4, 3.8 3.2, 3.8 3.7, 3.3 3.8, 3.2 3.4)), ((3 1.2, 2.5 0.2, 3.5 0.2, 3.5 1.2, 3 1.2)), ((0 1, 0.1 0.8, 0.2 0.5, 0.1 0.3, 0 0.7, 0 1)))
## GEOMETRYCOLLECTION (POLYGON ((0.5 0.5, 2 0, 3 2, 1.5 4, 0 3, 0.5 0.5), (1 1, 0.8 2, 2 2.2, 1.4 1.1, 1 1)), MULTIPOINT ((3.5 -0.5), (4 2), (5 0), (3.2 1), (5 2), (4.5 0.5)), MULTILINESTRING ((3 3.5, 3.7 3.2, 4.5 3.3), (2.5 3.5, 3 4, 3.7 3.7), (4.5 3.8, 5.5 4.5)))</code></pre>
</div>
<p><strong>Well-Known Binary (WKB)</strong> — бинарный формат хранения координат. Именно этот формат фактически используется в базах данных, поскольку он обеспечивает высокую скорость чтения и записи данных (в отличие от текстового). Однако внешний вид данных в формате WKB мало о чем говорит человеку, поскольку он предназначен для чтения компьютером. Например, вышеприведенная строка <code>LINESTRING</code> будет выглядеть так:</p>
<div class="cell">
<pre><code>## 01 02 00 00 00 05 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 f0 3f 00 00 00 00 00 00 e0 3f 00 00 00 00 00 00 f8 3f 33 33 33 33 33 33 f3 3f 33 33 33 33 33 33 f3 3f 00 00 00 00 00 00 00 40 cd cc cc cc cc cc f4 3f 00 00 00 00 00 00 08 40 00 00 00 00 00 00 00 40</code></pre>
</div>
</section>
<section id="vector_data_packages" class="level3" data-number="9.3.2">
<h3 data-number="9.3.2" class="anchored" data-anchor-id="vector_data_packages"><span class="header-section-number">9.3.2</span> Базовые библиотеки</h3>
<p>В R существует высоко развитая инфраструктура для работы с векторными данными, которая обеспечивается пакетом <a href="https://cran.r-project.org/web/packages/sf/index.html"><strong>sf</strong></a>.</p>
<p>Пакет <strong>sf</strong> базируется на библиотеках <a href="https://proj.org">PROJ</a>, <a href="https://gdal.org">GDAL</a>, <a href="https://trac.osgeo.org/geos/">GEOS</a> и <a href="https://s2geometry.io">S2</a>, которые устанавливаются вместе с ним. Их назначение кратко описано на следующем рисунке:</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/sf_architecture_new.svg" class="img-fluid figure-img" style="width:100.0%"></p>
<figcaption>Архитектура программных библиотек для работы с пространственными данными в R</figcaption>
</figure>
</div>
</div>
</div>
<p>Со многими функциями <strong>sf</strong> мы познакомимся в последующих разделах нашего курса. Некоторые из них (такие как <code>arrange</code>, <code>filter</code>, <code>mutate</code> из пакета <strong>dplyr</strong>), должны быть уже знакомы вам по предыдущим лекциям. Можно обратить внимание на то, что практически все функции начинаются с префикса <code>st_</code>, что означает <strong>“spatiotemporal”</strong>. Данные префиксы были выбраны для унификации с аналогичными названиями функций, используемых в широко распространенной СУБД PostgreSQL для оперирования объектами <em>Simple Features</em>.</p>
</section>
<section id="vector_data_reading" class="level3" data-number="9.3.3">
<h3 data-number="9.3.3" class="anchored" data-anchor-id="vector_data_reading"><span class="header-section-number">9.3.3</span> Чтение</h3>
<p>Существует большое количество форматов хранения пространственных данных. Но в общем и целом их можно разделить на две категории: файловые форматы (наиболее привычные пользователям) и хранение данных в СУБД — системах управления базами данных. Благодаря библиотеке GDAL пакет <strong>sf</strong> имеет возможность читать и записывать <a href="http://www.gdal.org/ogr_formats.html">более 90 различных форматов векторных даных</a>.</p>
<p>Исторически наиболее распространенным форматом был (и остается) <a href="https://www.esri.com/library/whitepapers/pdfs/shapefile.pdf">ESRI Shapefile</a>. Данный формат, однако не отвечает современным техническим требованиям с точки зрения гибкости, соответствия стандартам и возможностям хранения разнообразных типов геометрий (напомним, что в стандарте <strong>Simple Features</strong> их 17, а с учетом четырех вариантов размерности точек получается целых 68 ). Современный формат, который обеспечивает полную поддержку стандарта <strong>Simple Features</strong> (и не только) — это <a href="http://www.geopackage.org">GeoPackage</a>. Именно его мы и будем использовать в нашем практикуме.</p>
<p>Для чтения данных средствами sf необходимо использовать функцию <code>st_read()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>countries <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'data/ne/countries.gpkg'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Reading layer `admin_0_map_units' from data source </span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   `/Users/tsamsonov/GitHub/r-geo-course/data/ne/countries.gpkg' </span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   using driver `GPKG'</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple feature collection with 183 features and 72 fields</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: MULTIPOLYGON</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Лог функции сообщил нам следующую информацию:</p>
<ul>
<li>Набор данных представляет собой коллекцию из 183 пространственных объектов с 72 атрибутами</li>
<li>Тип геометрии <code>MULTIPOLYGON</code></li>
<li>Размерность геометрии <span class="math inline">\(XY\)</span></li>
<li>Ограничивающий прямоугольник (разброс координат) по осям <span class="math inline">\(X\)</span> и <span class="math inline">\(Y\)</span> имеет диапазон <span class="math inline">\([-180, 180] \times [-90, 83.64513]\)</span></li>
<li>Проекция (CRS — coordinate reference system) имеет название <em>WGS 84</em>.</li>
</ul>
<p>Подгрузим также для работы данные по другим типам объектов:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>oceans <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'data/ne/oceans.gpkg'</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Reading layer `ocean' from data source </span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   `/Users/tsamsonov/GitHub/r-geo-course/data/ne/oceans.gpkg' </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   using driver `GPKG'</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple feature collection with 2 features and 4 fields</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: POLYGON</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: -180 ymin: -85.60904 xmax: 180 ymax: 90</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>rivers <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'data/ne/rivers.gpkg'</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Reading layer `rivers_lake_centerlines' from data source </span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="do">##   `/Users/tsamsonov/GitHub/r-geo-course/data/ne/rivers.gpkg' </span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="do">##   using driver `GPKG'</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple feature collection with 13 features and 8 fields</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: LINESTRING</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: -135.3134 ymin: -33.99358 xmax: 129.956 ymax: 72.90651</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>lakes <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'data/ne/lakes.gpkg'</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Reading layer `lakes' from data source </span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="do">##   `/Users/tsamsonov/GitHub/r-geo-course/data/ne/lakes.gpkg' using driver `GPKG'</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple feature collection with 25 features and 8 fields</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: POLYGON</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: -124.9536 ymin: -16.53641 xmax: 109.9298 ymax: 66.9693</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>cities <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">'data/ne/cities.gpkg'</span>)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="do">## Reading layer `populated_places' from data source </span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="do">##   `/Users/tsamsonov/GitHub/r-geo-course/data/ne/cities.gpkg' </span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="do">##   using driver `GPKG'</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple feature collection with 243 features and 103 fields</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: POINT</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: -175.2206 ymin: -41.29999 xmax: 179.2166 ymax: 64.15002</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sf_structure" class="level3" data-number="9.3.4">
<h3 data-number="9.3.4" class="anchored" data-anchor-id="sf_structure"><span class="header-section-number">9.3.4</span> Внутренняя структура</h3>
<p>Традиционно во всех ГИС-приложениях и базах пространственных данных множество пространственных объектов представляется в виде таблицы атрибутов, где каждая строка соответствует объекту, а каждый столбец — атрибуту объекта. С каждой строкой таблицы должна быть ассоциирована информация о геометрии объекта, которая, в зависимости от формата данных, может либо храниться непосредственно в таблице (в специальном столбце), либо быть вынесена в отдельную структуру данных, которая связана с таблицей атрибутов посредством ключа<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<p>В <strong>R</strong> используется первый подход, в котором информация о геометрии хранится в специальном столбце таблицы. Каждая ячейка этого столбца соответствует геометрическому объекту <em>Simple Features</em>. Представление геометрических объектов реализовано стандартными средствами, такими как списки, матрицы и векторы. Эти структуры данных упорядоченным образом хранят координаты объектов и естественным образом соответствуют способу организации данных, который регламентируется стандартом <em>Simple Features</em>. Поскольку геометрический столбец хранит не обычные переменные, а структуры данных, он реализуется в виде так называемого <em>списка-колонки (list-column)</em>, каждый элемент которой соответствует отдельному объекту.</p>
<p>Исходя из этих соображений, представление пространственных объектов реализовано в <strong>R</strong> в виде иерархии из трех классов объектов:</p>
<ol type="1">
<li><code>sf</code> (simple features) — объект класса <code>data.frame</code>, представляющий множество пространственных объектов со списком-колонкой для хранения геометрии</li>
<li><code>sfc</code> (simple features geometry column) — список-колонка в объекте <code>sf</code>, представляющий множество геометрий пространственных объектов</li>
<li><code>sfg</code> (simple feature geometry) — геометрия пространственного объекта внутри списка <code>sfc</code></li>
</ol>
<p>В соответствии с перечисленными спецификациями происходит работа с пространственными объектами. То что, объекты типа Simple Features реализованы в виде самых обычных фреймов данных, означает что <em>любая операция, применимая к фрейму данных, будет также применима к объекту типа</em> <code>sf</code>. Это очень важная особенность объектов типа sf, которой сильно не хватало в экосистеме исторического пакета <code>sp</code>.</p>
<p>Посмотрим, как все это реализовано, на конкретном примере:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(countries)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "sf"         "data.frame"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Данная форма записи говорит о том, что прочитанный слой имеет класс <em>sf</em>, который, в свою очередь, является расширением класса <em>data.frame</em>.</p>
<p>А теперь посмотрим на последние колонки в первых строках таблицы:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(countries[<span class="fu">tail</span>(<span class="fu">colnames</span>(countries))])</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple feature collection with 6 features and 5 fields</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: MULTIPOLYGON</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: -73.41544 ymin: -55.25 xmax: 75.15803 ymax: 42.68825</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   tiny homepart min_zoom min_label max_label                       geometry</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1  -99        1        0         3         7 MULTIPOLYGON (((61.21082 35...</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 2  -99        1        0         3         7 MULTIPOLYGON (((23.90415 -1...</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 3  -99        1        0         5        10 MULTIPOLYGON (((21.02004 40...</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 4  -99        1        0         4         9 MULTIPOLYGON (((51.57952 24...</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 5  -99        1        0         2         7 MULTIPOLYGON (((-66.95992 -...</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 6  -99        1        0         5        10 MULTIPOLYGON (((43.58275 41...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Видно, что геометрия пространственных объектов хранится в заключительном столбце с названием <code>geometry</code>. Данный столбец можно быстро извлечь, применив функцию <code>st_geometry()</code>. Полученный объект будет иметь тип <strong>sfc</strong> (Simple Feature Geometry Column)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>outlines <span class="ot">=</span> <span class="fu">st_geometry</span>(countries)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(outlines)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "sfc_MULTIPOLYGON" "sfc"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Полученный вывод говорит нам о том, что наши объекты имеют класс <code>sfc_MULTIPOLYGON</code>, который является расширением класса <code>sfc</code> (simple feature geometry column).</p>
<p>Теперь если просмотреть начало данных, то мы увидим, что это больше не фрейм данных, а аннотированный список:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(outlines)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry set for 6 features </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: MULTIPOLYGON</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: -73.41544 ymin: -55.25 xmax: 75.15803 ymax: 42.68825</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="do">## First 5 geometries:</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Далее можно опуститься на базовый уровень геометрии, получив доступ к отдельному объекту. Поскольку объект класса <code>sfc</code> представляет собой список, любой элемент можно извлечь по его порядковому номеру. Класс полученного объекта будет:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(outlines[[<span class="dv">8</span>]])</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "XY"           "MULTIPOLYGON" "sfg"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Исходя из полученной информации можно сделать вывод, что геометрия 8-го объекта таблицы <code>countries</code> имеет класс <code>sfg</code>, реализованный в виде мультиполигонов (<code>MULTIPOLYGON</code>) с плоскими координатами (<code>XY</code>)</p>
<p>Наконец, чтобы добраться до координат в чистом виде, необходимо развернуть иерархию списков, из которых состоит объект <code>sfg</code>. Количество уровней вложенности всегда зависит от конкретного объекта, их может быть достаточно много, особенно если объекты представлены мультиполигонами (несколько компонент связности), каждый из которых также состоит из полигонов с дырками. В нашем случае все достаточно просто, так как в слое <code>countries</code> дырок в полигонах нет, а 8-й по счету полигон состоит из одной-единственной геометрии, координаты которой в виде матрицы можно извлечь как:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>outlines[[<span class="dv">8</span>]][[<span class="dv">1</span>]]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="do">## [[1]]</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="do">##          [,1]     [,2]</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1,] 68.9350 -48.6250</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="do">##  [2,] 69.5800 -48.9400</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="do">##  [3,] 70.5250 -49.0650</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  [4,] 70.5600 -49.2550</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  [5,] 70.2800 -49.7100</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  [6,] 68.7450 -49.7750</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  [7,] 68.7200 -49.2425</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  [8,] 68.8675 -48.8300</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  [9,] 68.9350 -48.6250</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sf_plotting" class="level3" data-number="9.3.5">
<h3 data-number="9.3.5" class="anchored" data-anchor-id="sf_plotting"><span class="header-section-number">9.3.5</span> Визуализация</h3>
<section id="sf_plotting_basic" class="level4" data-number="9.3.5.1">
<h4 data-number="9.3.5.1" class="anchored" data-anchor-id="sf_plotting_basic"><span class="header-section-number">9.3.5.1</span> Базовая графическая система</h4>
<p>Если попытаться применить функцию <code>plot()</code> к геометрии объекта, она попытается нарисовать тематические карты по всем имеющимся атрибутам (но остановится, если их более 9):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(countries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Если задача стоит нарисовать границы объектов, то нужно отображать объект <strong>sfc</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(outlines, <span class="at">col =</span> <span class="st">'red'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Для быстрого построения тематических карт по выбранному показателю необходимо при вызове функции <code>plot()</code> указать соответствующий атрибут фрейма данных:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(countries[<span class="st">'sovereignt'</span>], <span class="at">key.pos =</span> <span class="cn">NULL</span>) <span class="co"># Здесь легенда не нужна</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Для отображения координатной сетки надо указать параметр <code>graticule = TRUE</code>, а подписей координат — <code>axes = TRUE</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(countries[<span class="st">'gdp_md_est'</span>], <span class="at">graticule =</span> <span class="cn">TRUE</span>, <span class="at">axes =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Для совмещения нескольких слоев на одной карте необходимо при втором и последующих вызовах функции <code>plot()</code> указать параметр <code>add = TRUE</code>. Все остальные настройки визуализации работают так же,как и в обычной графике:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>cities_large <span class="ot">=</span> cities <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(scalerank <span class="sc">==</span> <span class="dv">0</span>, </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>         <span class="sc">!</span> name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">'Washington, D.C.'</span>, <span class="st">'Paris'</span>, <span class="st">'Riyadh'</span>, <span class="st">'Rome'</span>, <span class="st">'São Paulo'</span>, <span class="st">'Kolkata'</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(countries), <span class="at">lwd =</span> <span class="fl">0.5</span>, <span class="at">border =</span> <span class="st">'gray'</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(oceans, <span class="at">col =</span> <span class="st">'steelblue1'</span>, <span class="at">border =</span> <span class="st">'steelblue'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lakes, <span class="at">col =</span> <span class="st">'steelblue1'</span>, <span class="at">border =</span> <span class="st">'steelblue'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rivers, <span class="at">col =</span> <span class="st">'steelblue'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cities_large, <span class="at">col =</span> <span class="st">'black'</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> <span class="fl">0.25</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(cities_large<span class="sc">$</span>longitude, cities_large<span class="sc">$</span>latitude, </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">label =</span> cities_large<span class="sc">$</span>name, <span class="at">cex =</span> <span class="fl">0.5</span>, <span class="at">pos =</span> <span class="dv">2</span>, <span class="at">offset =</span> <span class="fl">0.25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p><strong>Внимание</strong>: чтобы слои совместились на карте, они должна иметь одинаковую систему координат.</p>
</blockquote>
<p>Ясно, что на полученных нами картах можно много что улучшить, однако это мы отложим до следующей главы, где подробно разбирается построение тематических карт в <strong>R</strong>.</p>
<blockquote class="blockquote">
<p><strong>Внимание</strong>: чтобы слои данных можно было совместно анализировать и наносить на одну карту, они должны иметь одну и ту же координатную систему (проекцию).</p>
</blockquote>
</section>
<section id="spatial_interactive" class="level4" data-number="9.3.5.2">
<h4 data-number="9.3.5.2" class="anchored" data-anchor-id="spatial_interactive"><span class="header-section-number">9.3.5.2</span> Интерактивные карты</h4>
<p>R предоставляет возможности для интерактивного просмотра пространственных данных средствами библиотек веб-картографирования. В данном разделе мы кратко познакомимся с возможностями пакета <a href="https://r-spatial.github.io/mapview/"><strong>mapview</strong></a>, который использует возможности библиотеки <a href="https://leafletjs.com/">Leaflet</a>. Функции данного пакета не предназначены для создания тематических карт высокого качества и рассчитаны на выполнение исследовательского анализа данных.</p>
<p>Чтобы отобразить векторный или растровый слой средствами mapview, достаточно вызвать одноименную функцию данного пакета:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(countries)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/mapview1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Чтобы отобразить определенный показатель, можно использовать параметр <code>zcol</code>, а палитру передать в параметр <code>col.regions</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>nconts <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(countries<span class="sc">$</span>continent))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(countries, <span class="at">zcol =</span> <span class="st">'continent'</span>, </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">col.regions =</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(nconts, <span class="st">'Set1'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/mapview2.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Чтобы скомбинировать несколько слоев, необходимо сложить несколько вызовов <code>mapview()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>{ <span class="fu">mapview</span>(countries, <span class="at">zcol =</span> <span class="st">'continent'</span>, </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">col.regions =</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(nconts, <span class="st">'Set1'</span>)) <span class="sc">+</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mapview</span>(cities_large, <span class="at">col.regions =</span> <span class="st">'black'</span>, <span class="at">label =</span> <span class="st">'name'</span>, <span class="at">cex =</span> <span class="dv">3</span>) } <span class="sc">|&gt;</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  leafem<span class="sc">::</span><span class="fu">addStaticLabels</span>(cities_large, <span class="at">label =</span> cities_large<span class="sc">$</span>name,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">offset =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="dv">0</span>),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                          <span class="at">style =</span> <span class="fu">list</span>(<span class="st">"color"</span> <span class="ot">=</span> <span class="st">"black"</span>, <span class="st">"font-weight"</span> <span class="ot">=</span> <span class="st">"bold"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/mapview3.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sf_attrs" class="level3" data-number="9.3.6">
<h3 data-number="9.3.6" class="anchored" data-anchor-id="sf_attrs"><span class="header-section-number">9.3.6</span> Атрибутивные операции</h3>
<p>Поскольку пространственные объекты хранятся в фреймах данных, к ним можно применять стандартные операции выборки по атрибутам и преобразования таблиц. Например, можно выбрать Италию и отобразить ее на отдельной карте:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>italy <span class="ot">=</span> countries <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sovereignt <span class="sc">==</span> <span class="st">'Italy'</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(italy))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Следующий пример иллюстрирует как выбрать страны с населением более 100 млн человек:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>largest <span class="ot">=</span> countries <span class="sc">|&gt;</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pop_est) <span class="sc">|&gt;</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pop_est <span class="sc">&gt;</span> <span class="dv">100000000</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(outlines, <span class="at">col =</span> <span class="st">'lightgrey'</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(largest, <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Обратите внимание на то, что при вызове функции <code>select()</code> столбец <code>geometry</code> не был указан в числе выбираемых переменных. Тем не менее, то, что мы смогли построить карту по результатам выборки, говорит о том, что данный столбец был сохранен. <em>Функции <strong>dplyr</strong> определены для объектов <code>sf</code> таким образом, чтобы всегда сохранять геометрический столбец.</em></p>
<p>Еще интереснее работает агрегирование объектов по атрибутам. В случае, когда агрегируются пространственные объекты, необходимо объединять и их геометрию. При этом если у агрегируемых объектов имеется общая граница, ее необходимо удалить, а если объекты разнесены в пространстве, из них нужно собрать новый мульти-объект.</p>
<p>Например, мы можем агрегировать валовой региональный продукт по континентам:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>continents <span class="ot">=</span> countries <span class="sc">%&gt;%</span> <span class="co"># этот пайп из пакета magrittr для подстановки в точку</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(., <span class="fu">st_is_valid</span>(.)) <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(continent) <span class="sc">|&gt;</span>  </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">gdp =</span> <span class="fu">sum</span>(gdp_md_est))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(continents[<span class="st">'gdp'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Потрясающе просто, не правда ли? Вдобавок, мы еще и получили границы континентов (достаточно условные, конечно), которых у нас раньше не было. Данный пример также показывает, что атрибутивные операции над пространственными объектами всегда учитывают их геометрию.</p>
</section>
<section id="sf_creation" class="level3" data-number="9.3.7">
<h3 data-number="9.3.7" class="anchored" data-anchor-id="sf_creation"><span class="header-section-number">9.3.7</span> Создание пространственных объектов</h3>
<p>Пространственные объекты в R можно собирать “вручную”, если есть такая необходимость. Например, вам известны координаты границ участков полевого обследования, полученные посредством GPS, а вам необходимо превратить их в полигоны, чтобы выполнить анализ и картографирование. Придется из координат собрать полигоны программным путем. Процесс создания пространственных объектов осуществляется в последовательности их иерархического соподчинения: <strong>sfg</strong> &gt; <strong>sfc</strong> &gt; <strong>sf</strong>.</p>
<section id="sf_sfg" class="level4" data-number="9.3.7.1">
<h4 data-number="9.3.7.1" class="anchored" data-anchor-id="sf_sfg"><span class="header-section-number">9.3.7.1</span> Геометрические объекты (sfg)</h4>
<p>Для создания геометрических объектов в пакете sf существует ряд функций с говорящими названиями:</p>
<table class="table">
<thead>
<tr class="header">
<th>Функция</th>
<th>Тип пространственного объекта</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>st_point()</code></td>
<td><em>POINT</em></td>
</tr>
<tr class="even">
<td><code>st_linestring()</code></td>
<td><em>LINESTRING</em></td>
</tr>
<tr class="odd">
<td><code>st_polygon()</code></td>
<td><em>POLYGON</em></td>
</tr>
<tr class="even">
<td><code>st_multipoint()</code></td>
<td><em>MULTIPOINT</em></td>
</tr>
<tr class="odd">
<td><code>st_multilinestring()</code></td>
<td><em>MULTILINESTRING</em></td>
</tr>
<tr class="even">
<td><code>st_multipolygon()</code></td>
<td><em>MULTIPOLYGON</em></td>
</tr>
<tr class="odd">
<td><code>st_geometrycollection()</code></td>
<td><em>GEOMETRYCOLLECTION</em></td>
</tr>
</tbody>
</table>
<p>В зависимости от типа создаваемого объекта, данные функции принимают координаты, организованные в виде одной из трех структур данных:</p>
<ul>
<li>Вектор координат (<em>POINT</em>)</li>
<li>Матрица координат (<em>MULTIPOINT</em> или <em>LINESTRING</em>), в которой строки соответствуют точкам, столбцы — координатам</li>
<li>Список (для всех остальных типов)</li>
</ul>
<p>Проще всего создаются отдельные <strong>точки</strong> (<em>POINT</em>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>)) <span class="co"># XY POINT</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>)) <span class="co"># XYZ POINT</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">5</span>), <span class="at">dim =</span> <span class="st">'XYM'</span>) <span class="co"># XYM POINT</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">st_point</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">5</span>)) <span class="co"># XYZM POINT</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Дополнительный параметр <code>dim=</code> служит для уточнения типа геометрии точек и по сути нужен только тогда, когда необходимо создать редко используемые точки типа <em>XYM</em>. во всех остальных случаях (<em>XY</em>, <em>XYZ</em>, <em>XYZM</em>) размерность геометрии распознается по умолчанию.</p>
<p>При создании <strong>мультиточек</strong> (<em>MULTIPOINT</em>) и <strong>линий</strong> (<em>LINESTRING</em>) необходимо подавать на вход функции уже матрицу координат:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span>, <span class="dv">2</span>,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="dv">3</span>,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>, <span class="dv">1</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span>, <span class="dv">0</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>mp <span class="ot">=</span> <span class="fu">st_multipoint</span>(coords) <span class="co"># XY MULTIPOINT</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mp)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>ls <span class="ot">=</span> <span class="fu">st_linestring</span>(coords) <span class="co"># XY LINESTRING</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>В первом случае геометрия состоит из отдельных точек. Во втором случае те же самые точки соединены линией:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ls)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mp, <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Создание трех-(<em>XYZ</em>, <em>XYM</em>) и четырехмерных (<em>ZYXM</em>) мультиточек и линий выполняется аналогично, но матрица должна содержать не 2, а, соответственно 3 или 4 столбца, и при необходимости параметр <code>dim = 'XYM'</code>.</p>
<p>Создание <strong>полигонов</strong> (<em>POLYGON</em>), <strong>мультиполигонов</strong> (<em>MULTIPOLYGON</em>) и <strong>мультилиний</strong> (<em>MULTILINESTRING</em>) требует уже создания списков из матриц.</p>
<p>Почему нельзя представить обычный (не мульти) полигон просто матрицей координат? Потому что полигон может содержать дырки. Например, контур леса может содержать дырку в том месте, где находится озеро. Или озеро может содержать дырку в том месте, где находится остров. Природа предлагает нам бесконечное число таких примеров. В целях универсализации приходится закладываться на возможность наличия дырок в полигонах, поэтому даже полигоны без дырок представляются в виде списков. При этом действу.т следующее правила:</p>
<ul>
<li>Первая матрица координат в списке отвечает за контур полигона</li>
<li>Все остальные матрицы координат отвечают за дыры в полигоне</li>
<li>Координаты первой и последней точки в каждой матрице должны совпадать</li>
</ul>
<p>Если дыр в полигоне нет, его список будет содержать только одну матрицу. Рассмотрим оба примера построения <strong>полигонов</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>( <span class="co"># Координаты главного полигона</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="dv">0</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span>, <span class="dv">2</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>, <span class="dv">3</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>, <span class="dv">2</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>, <span class="fl">0.5</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="dv">0</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>pol <span class="ot">=</span> <span class="fu">st_polygon</span>(<span class="fu">list</span>(coords)) <span class="co"># Простой полигон</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pol)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">col =</span> <span class="st">'lightblue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>hole <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>( <span class="co"># Координаты дыры</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>, <span class="dv">1</span>,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>, <span class="fl">1.5</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>, <span class="dv">2</span>,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>, <span class="dv">2</span>,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fl">1.5</span>, <span class="fl">1.5</span>,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>, <span class="dv">1</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>pol2 <span class="ot">=</span> <span class="fu">st_polygon</span>(<span class="fu">list</span>(coords, hole)) <span class="co"># Полигон с дырой</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(pol2)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol2, <span class="at">col =</span> <span class="st">'lightblue'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-32-2.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Мультиполигоны (<em>MULTIPOLYGON</em>) и мультилинии (<em>MULTILINESTRING</em>) требуются тогда, когда один и тот же географический объект состоит из нескольких геометрических объектов. Простейший пример — островные государства. Чтобы представить страну, занимающую архипелаг (Багамские острова, Индонезия, Япония и т.д.) как один пространственный объект, необходимо создать мультиполигон. Все компоненты мультиполигона будут иметь общий набор атрибутов (непространственных характеристик). Мультилинии используются реже мультиполигонов и необходимы для представления линейных объектов, разорванных в пространстве. Примером такого объекта может быть любая река или канал, которые разорваны в тех местах, где они протекают через озеро или водохранилище, представленное полигональным объектом.</p>
<p>В мультиполигонах добавляется еще один уровень списка, то есть искомые матрицы координат будут располагаться как минимум на втором уровне вложенности:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>coords1 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span>, <span class="dv">0</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span>, <span class="dv">1</span>,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="fl">1.5</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>, <span class="dv">1</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fl">1.5</span>, <span class="fl">0.25</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fl">0.5</span>, <span class="dv">0</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>coords2 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>, <span class="dv">1</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.5</span>, <span class="dv">2</span>,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fl">3.5</span>, <span class="fl">2.5</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>, <span class="dv">2</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>, <span class="fl">1.25</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>, <span class="dv">1</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>mpol <span class="ot">=</span> <span class="fu">st_multipolygon</span>(<span class="fu">list</span>(<span class="fu">list</span>(coords1), <span class="fu">list</span>(coords2)))</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mpol)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol, <span class="at">col =</span> <span class="st">'grey'</span>) <span class="co"># Обычный полигон (серый)</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mpol, <span class="at">col =</span> <span class="st">'pink'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>) <span class="co"># Мультиполигон (розовый)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Как насчет острова на озере? Если остров и суша, окружающая озеро, составляют единое целое (например, подлежат учету как единый массив леса), их можно собрать как мультиполигон. В этом случае первая компонента мультиполигона будет представлять собой полигон с дыркой, а вторая компонента — остров. Порядок компонент в данном случае роли не играет:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>coords4 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.2</span>, <span class="fl">1.2</span>,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.8</span>, <span class="fl">1.5</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.8</span>, <span class="fl">1.8</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.2</span>, <span class="fl">1.8</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.0</span>, <span class="fl">1.6</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fl">2.2</span>, <span class="fl">1.2</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>island <span class="ot">=</span> <span class="fu">st_polygon</span>(<span class="fu">list</span>(coords4))</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>mpol2 <span class="ot">=</span> <span class="fu">st_multipolygon</span>(<span class="fu">list</span>(pol2, island))</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mpol2)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mpol2, <span class="at">col =</span> <span class="st">'darkolivegreen4'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Из данного примера также видно, что при сборе мультиполигона на самом нижнем уровне вложенности можно подавать не списки матриц координат, а готовые полигоны.</p>
<p>Мультилиния, в отличие от мультиполигона, не требует дополнительного списка верхнего уровня, поскольку линии не могут содержать дыр. Например, можно собрать мультилинию из двух частей, соответствующих участкам реки до и после озера:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>coords1 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="dv">3</span>, <span class="dv">0</span>,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="dv">1</span>, <span class="dv">2</span>,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span>, <span class="dv">2</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>coords2 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>, <span class="dv">2</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span>, <span class="dv">3</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="dv">6</span>, <span class="dv">5</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>mline <span class="ot">=</span> <span class="fu">st_multilinestring</span>(<span class="fu">list</span>(coords1, coords2))</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mline)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mline, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">col =</span> <span class="st">'blue'</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pol2, <span class="at">col =</span> <span class="st">'lightblue'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Наконец, еще один вид геометрии — это геометрическая коллекция (GEOMETRYCOLLECTION), который позволяет хранить вместе любые виды геометрий. Эта возможность используется достаточно редко, тем не менее, рассмотреть ее нужно. Геометрическая коллекция собирается из списка объектов с простыми типами геометрии (мы создали их ранее):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>col <span class="ot">=</span> <span class="fu">st_geometrycollection</span>(<span class="fu">list</span>(ls, mp, mline, pol2))</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(col)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(col)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sf_sfc" class="level4" data-number="9.3.7.2">
<h4 data-number="9.3.7.2" class="anchored" data-anchor-id="sf_sfc"><span class="header-section-number">9.3.7.2</span> Списки геометрических объектов (sfc)</h4>
<p>Списки геометрических объектов (класс <code>sfc</code>) используются в таблицах пространственных объектов в качестве столбца, который хранит геометрию объектов. Создание таких списков осуществляется функцией <code>st_sfc()</code>, которой достаточно передать в качестве перечня параметров объекты типа <code>sfg</code>. Рассмотрим создание списка геометрий на примере точечных объектов (для остальных типов объектов порядок действий не меняется):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>moscow.sfg <span class="ot">=</span> <span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">37.615</span>, <span class="fl">55.752</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>irkutsk.sfg <span class="ot">=</span> <span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">104.296</span>, <span class="fl">52.298</span>))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>petro.sfg <span class="ot">=</span> <span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">158.651</span>, <span class="fl">53.044</span>))</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>cities.sfc <span class="ot">=</span> <span class="fu">st_sfc</span>(moscow.sfg, irkutsk.sfg, petro.sfg)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cities.sfc)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry set for 3 features </span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: POINT</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: 37.615 ymin: 52.298 xmax: 158.651 ymax: 55.752</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="do">## CRS:           NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>При создании списка геометрий для него может быть определена система координат (это можно сделать и позднее при создании таблицы пространственных объектов). Для этого используем уже знакомую нам функцию <code>st_crs()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(cities.sfc) <span class="ot">=</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>) <span class="co"># WGS84</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cities.sfc)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry set for 3 features </span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: POINT</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: 37.615 ymin: 52.298 xmax: 158.651 ymax: 55.752</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>Для списка геометрий может быть определена только одна система координат</p>
</blockquote>
<p>Можно посмотреть, куда легли наши точки:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(cities.sfc, <span class="at">pch =</span> <span class="dv">19</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>countries <span class="sc">|&gt;</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sovereignt <span class="sc">==</span> <span class="st">'Russia'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sf_sf" class="level4" data-number="9.3.7.3">
<h4 data-number="9.3.7.3" class="anchored" data-anchor-id="sf_sf"><span class="header-section-number">9.3.7.3</span> Пространственные объекты (sf)</h4>
<p>Пространственные объекты (класс <code>sf</code>) организуются в виде фрейма данных, один из столбцов которого имеет класс <code>sfc</code>. Для этого следует сначала создать обычный фрейм данных с атрибутами, а затем соединить его со списком геометрий посредством функции <code>st_sf</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>city.attr <span class="ot">=</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">name =</span> <span class="fu">c</span>(<span class="st">'Москва'</span>, <span class="st">'Иркутск'</span>, <span class="st">'Петропавловск-Камчатский'</span>),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">established =</span> <span class="fu">c</span>(<span class="dv">1147</span>, <span class="dv">1661</span>, <span class="dv">1740</span>),</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">population =</span> <span class="fu">c</span>(<span class="dv">12500</span>, <span class="dv">620</span>, <span class="dv">180</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>cites.sf <span class="ot">=</span> <span class="fu">st_sf</span>(city.attr, <span class="at">geometry =</span> cities.sfc)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cites.sf)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Simple feature collection with 3 features and 3 fields</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: POINT</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: 37.615 ymin: 52.298 xmax: 158.651 ymax: 55.752</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="do">##                       name established population               geometry</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 1                   Москва        1147      12500  POINT (37.615 55.752)</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 2                  Иркутск        1661        620 POINT (104.296 52.298)</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 Петропавловск-Камчатский        1740        180 POINT (158.651 53.044)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sf_geom_points" class="level4" data-number="9.3.7.4">
<h4 data-number="9.3.7.4" class="anchored" data-anchor-id="sf_geom_points"><span class="header-section-number">9.3.7.4</span> Точки по координатам</h4>
<p>Достаточно распространенной является следующая задача: имеются координаты точек в табличной форме, необходимо создать на их основе набор пространственных объектов. Для решения этой задачи можно воспользоваться функцией <code>st_as_sf()</code>. Рассмотрим задачу на примере файла координат станций из базы метеорологических данных <a href="http://meteo.ru/"><strong>ВНИИГМИ-МЦД</strong></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">stations =</span> <span class="fu">read_fwf</span>(<span class="st">'data/vniigmi/stations.txt'</span>, </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">col_positions =</span> <span class="fu">fwf_widths</span>(<span class="fu">diff</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">7</span>, <span class="dv">42</span>, <span class="dv">47</span>, <span class="dv">53</span>, <span class="dv">59</span>, <span class="dv">67</span>, <span class="dv">71</span>)), </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">col_names =</span> <span class="fu">c</span>(<span class="st">'id'</span>, <span class="st">'name'</span>, <span class="st">'lat'</span>, <span class="st">'t1'</span>, <span class="st">'lon'</span>, <span class="st">'t2'</span>, <span class="st">'z'</span>)),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">locale =</span> <span class="fu">locale</span>(<span class="at">encoding =</span> <span class="st">'CP1251'</span>)))</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 1,124 × 7</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="do">##       id name                  lat t1      lon t2        z</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;dbl&gt; &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  1 20046 Им.Э.Т.Кренкеля,ГМО  80.6 с.ш.   58   в.д.     21</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  2 20069 Остров_Визе          79.5 с.ш.   77.0 в.д.     10</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  3 20087 Голомянный           79.6 с.ш.   90.6 в.д.      7</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  4 20107 Баренцбург           78.1 с.ш.   14.2 в.д.     73</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  5 20289 Русский              77.2 с.ш.   96.4 в.д.      9</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="do">##  6 20292 Им.Е.К.Федорова,ГМО  77.7 с.ш.  104.  в.д.     12</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="do">##  7 20353 мыс_Желания          77.0 с.ш.   68.6 в.д.      9</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="do">##  8 20476 Стерлегова           75.4 с.ш.   88.9 в.д.     10</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="do">##  9 20667 Им.М.В.Попова        73.3 с.ш.   70.0 в.д.      4</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 10 20674 Остров_Диксон        73.5 с.ш.   80.4 в.д.     42</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="do">## # ℹ 1,114 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Теперь создадим пространственные точки на основе этой таблицы, взяв координаты из столбцов <em>lat</em> и <em>lon</em> соответственно и указав код системы координат:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>sf_stations <span class="ot">=</span> <span class="fu">st_as_sf</span>(stations, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(sf_stations), <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">'red'</span>, <span class="at">cex =</span> <span class="fl">0.25</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(countries), <span class="at">border =</span> <span class="st">'grey'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">box</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sf_cast" class="level4" data-number="9.3.7.5">
<h4 data-number="9.3.7.5" class="anchored" data-anchor-id="sf_cast"><span class="header-section-number">9.3.7.5</span> Преобразование типов геометрии</h4>
<p>Для преобразования типов геометрии существует функция <code>st_cast()</code>. Функция принимает объекты классов <code>sfg</code>, <code>sfc</code> или <code>sf</code>, а также название типа геометрии, к которому необходимо привести входные объекты. Довольно часто возникает задача конвертации площадного объекта в линейный и обратно, а также задача получения координат вершин линейного или площадного объекта в виде точек. Примеры преобразований:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>italy.borders <span class="ot">=</span> <span class="fu">st_cast</span>(italy, <span class="st">'MULTILINESTRING'</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(<span class="fu">st_geometry</span>(italy.borders))</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "sfc_MULTILINESTRING" "sfc"</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>italy.regions <span class="ot">=</span> <span class="fu">st_cast</span>(italy.borders, <span class="st">'MULTIPOLYGON'</span>)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(<span class="fu">st_geometry</span>(italy.regions))</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "sfc_MULTIPOLYGON" "sfc"</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>italy.points <span class="ot">=</span> <span class="fu">st_cast</span>(italy.borders, <span class="st">'POINT'</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(<span class="fu">st_geometry</span>(italy.points))</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "sfc_POINT" "sfc"</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(italy.regions), <span class="at">lwd =</span> <span class="fl">0.5</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(italy.points, <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sf_polygonize" class="level4" data-number="9.3.7.6">
<h4 data-number="9.3.7.6" class="anchored" data-anchor-id="sf_polygonize"><span class="header-section-number">9.3.7.6</span> Полигонизация и разбиение линий</h4>
<p><strong>Полигонизация</strong> — это процесс преобразования линии или мультилинии в полигон(ы). Полигон может быть образован последовательностью из одной и более линий, для которых выполняются следующие условия:</p>
<ol type="1">
<li>Каждая линия является простой (не имеет самопересечений)</li>
<li>Линии касаются только своими начальными и конечными точками</li>
<li>Линии образуют замкнутую последовательность (т.е. выйдя из любой конечной точки и двигаясь вдоль множества линий, можно вернуться в ту же точку.)</li>
</ol>
<p>Полигонизация может применяться только к одному геометрическому объекту (simple feature geometry). Соответственно, это должна быть либо просто замкнутая линия, либо мультилиния, компоненты которой образуют замкнутую последовательность.</p>
<p>Рассмотрим операции полигонизации и добавления узлов на простом примере трех пересекающихся отрезков:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Создадим три линии</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>coords1 <span class="ot">=</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">6</span>))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>line1 <span class="ot">=</span> <span class="fu">st_linestring</span>(coords1)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>coords2 <span class="ot">=</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">1</span>))</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>line2 <span class="ot">=</span> <span class="fu">st_linestring</span>(coords2)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>coords3 <span class="ot">=</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">5</span>), <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">0</span>))</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>line3 <span class="ot">=</span> <span class="fu">st_linestring</span>(coords3)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Создадим мультилинию</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>mls <span class="ot">=</span> <span class="fu">st_multilinestring</span>(<span class="fu">list</span>(line1, line2, line3))</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mls)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Посмотрим на ее точки</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>points <span class="ot">=</span> <span class="fu">st_cast</span>(mls, <span class="st">'MULTIPOINT'</span>)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(points, <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Из рисунка видно, что линии образуют треугольную замкнутую область. Также рисунок показывает, что у компонент мультилинии нет вершин в точках пересечения. Мы можем попытаться найти замкнутые области и превратить их в полигоны, используя <code>st_polygonize()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_polygonize</span>(mls)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Операция завершилась возвратом пустой геометрической коллекции, то есть программа не смогла выделить замкнутые области. Это произошло по причине того, что линии не разбиты в точках пересечения. Разбить их на компоненты можно, используя функцию <code>st_node()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>mls2 <span class="ot">=</span> <span class="fu">st_node</span>(mls)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>poly2 <span class="ot">=</span> <span class="fu">st_polygonize</span>(mls2)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>points2 <span class="ot">=</span> <span class="fu">st_cast</span>(mls2, <span class="st">'MULTIPOINT'</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mls2)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(poly2, <span class="at">col =</span> <span class="st">'grey'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(points2, <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Таким образом, после разбиения линий на куски в точках пересечения стала возможной операция полигонизации.</p>
</section>
</section>
<section id="sf_geom_attrs" class="level3" data-number="9.3.8">
<h3 data-number="9.3.8" class="anchored" data-anchor-id="sf_geom_attrs"><span class="header-section-number">9.3.8</span> Геометрические атрибуты</h3>
<p>К описательным характеристикам геометрии относятся ограничивающий прямоугольник, периметр (для линий и полигонов), площадь (для полигонов), центроид и список координат, которые можно получить с помощью функций <code>st_bbox()</code>, <code>st_length()</code>, <code>st_area()</code>, <code>st_centroid()</code> и <code>st_coordinates()</code> соответственно. Функции корректно работают для простых объектов, мультиобъектов, списков геометрий и пространственных объектов. Применительно к полигону Италии эти параметры будут учитывать части геометрии, занимаемые островами:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_bbox</span>(italy)        <span class="co"># Координаты органичивающего прямоугольника</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="do">##      xmin      ymin      xmax      ymax </span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  6.749955 36.619987 18.480247 47.115393</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">st_area</span>(italy)        <span class="co"># Площадь</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 314577521836 [m^2]</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="fu">st_length</span>(italy)      <span class="co"># Периметр</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 0 [m]</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="fu">st_centroid</span>(italy) <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>()    <span class="co"># Центроид (может быть не внутри для невыпуклых фигур)</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry set for 1 feature </span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: POINT</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: 12.2687 ymin: 42.67074 xmax: 12.2687 ymax: 42.67074</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="fu">st_point_on_surface</span>(italy) <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="co"># Точка гарантированно внутри, но не обязательно в центре</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry set for 1 feature </span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Geometry type: POINT</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Dimension:     XY</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="do">## Bounding box:  xmin: 12.63118 ymin: 42.55822 xmax: 12.63118 ymax: 42.55822</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a><span class="do">## Geodetic CRS:  WGS 84</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a><span class="fu">st_coordinates</span>(italy) <span class="sc">|&gt;</span> <span class="fu">head</span>() <span class="co"># Список координат</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="do">##             X        Y L1 L2 L3</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a><span class="do">## [1,] 10.44270 46.89355  1  1  1</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="do">## [2,] 11.04856 46.75136  1  1  1</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="do">## [3,] 11.16483 46.94158  1  1  1</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a><span class="do">## [4,] 12.15309 47.11539  1  1  1</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="do">## [5,] 12.37649 46.76756  1  1  1</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="do">## [6,] 13.80648 46.50931  1  1  1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Обратите внимание на то, что площадь и периметр выводятся с указанием единиц измерений! Это возможно благодаря тому, что объекты типа <code>sf</code> поддерживают единицы измерений на основе пакета <a href="https://cran.r-project.org/web/packages/units/index.html">units</a>.</p>
<blockquote class="blockquote">
<p>Если данные находятся в плоской прямоугольной системе координат, то единицы измерения как правило указываются в параметрах проекции — следовательно, они могут быть использованы при вычислении геометрических параметров объектов. Если же данные хранятся в широтах и долготах, то вычисление геометрических параметров осуществляется пакетом <em>sf</em> по формулам сферической тригонометрии через пакет <a href="https://cran.r-project.org/web/packages/geosphere/index.html">geosphere</a>. Это позволяет выводить результат в плоских единицах измерения.</p>
</blockquote>
<p>Ограничивающий прямоугольник можно быстро преобразовать в полигон и нанести на карту, применив функцию <code>st_as_sfc()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>box <span class="ot">=</span> <span class="fu">st_as_sfc</span>(<span class="fu">st_bbox</span>(italy)) <span class="co"># Ограничивающий прямоугольник</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(italy <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>(), </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">'lightgrey'</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(box, </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">border =</span> <span class="st">'orangered'</span>, </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_centroid</span>(italy), </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">'darkgreen'</span>, </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_point_on_surface</span>(italy), </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">'steelblue4'</span>, </span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Как видно, в данном случае центроид и характерная точка расположились относительно рядом. Однако так бывает далеко не всегда. Выполним аналогичные вычисления для Индонезии:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>indonesia <span class="ot">=</span> countries <span class="sc">|&gt;</span> <span class="fu">filter</span>(sovereignt <span class="sc">==</span> <span class="st">'Indonesia'</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>box <span class="ot">=</span> <span class="fu">st_as_sfc</span>(<span class="fu">st_bbox</span>(indonesia))</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(indonesia <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>(), </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">'lightgrey'</span>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(box, </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">border =</span> <span class="st">'red'</span>, </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_centroid</span>(indonesia), </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">'darkgreen'</span>, </span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_point_on_surface</span>(indonesia), </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">'steelblue4'</span>, </span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Как видно, в данном случае центроид мультиполигона оказался за пределами какой-либо из его полигональных компонент, в то время как характерная точка находится внутри одного из полигонов. Таким образом, если необходимо получить точку, находящуюся гарантированно в пределах исходного множества, следует использовать <code>st_point_on_surface()</code>. При этом следует помнить, что характерная точка, в отличие от центроида, может не располагаться в визуальном центре тяжести множества объектов, и выбор между этими способами описания геометрии остается за разработчиком.</p>
</section>
<section id="sf_export" class="level3" data-number="9.3.9">
<h3 data-number="9.3.9" class="anchored" data-anchor-id="sf_export"><span class="header-section-number">9.3.9</span> Экспорт</h3>
<p>Для экспорта векторных пространственных данных можно воспользоваться функцией <code>st_write()</code>, которая определит формат выходного файла по указанному вами расширению:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(cites.sf, <span class="st">'data/mycities.shp'</span>) <span class="co"># Шейп-файл</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="raster_data_r" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="raster_data_r"><span class="header-section-number">9.4</span> Растровые данные</h2>
<p>Работа с растровыми данными в целом гораздо проще, чем работа с векторными объектами. Это обусловлено в том числе жесткой сеточной структурой данных, которая предоставляет не так много свободы в различных сценариях обработки данных. В то же время, эта структура позволяет сделать растровые алгоритмы универсальными и робастными, многие задачи решаются в растровом виде быстрее и проще, чем в векторном.</p>
<section id="raster_data" class="level3" data-number="9.4.1">
<h3 data-number="9.4.1" class="anchored" data-anchor-id="raster_data"><span class="header-section-number">9.4.1</span> Теоретические сведения</h3>
<p><strong>Растр</strong> представляет из себя матрицу значений. Каждой ячейке матрицы соответствует прямоугольная пространственная область фиксированного размера, которая называется <em>пикселом</em>. Различают растры <em>непрерывные</em> и <em>категориальные (классифицированные)</em>. Также необходимо разделять <em>одноканальные</em> и <em>многоканальные растры</em>. Примером одноканального растра является цифровая модель рельефа. В виде многоканальных растров часто представляют космические снимки.</p>
<p>В отличие от векторных данных, которые требуют указания координат для каждой вершины, регулярно-ячеистый характер растровой модели позволяет вычислять координаты пикселов на основе их индексов. Поэтому фактически растровые данные хранятся в виде линейно упорядоченного списка значений <em>(raster values)</em> и описания геометрии растра <em>(raster geometry)</em>.</p>
<p><strong>Геометрия растра</strong> определяет, где именно располагаются в пространстве пикселы растра и может быть описана путем указания следующих компонент<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>:</p>
<table class="table">
<thead>
<tr class="header">
<th>Параметр</th>
<th>Назначение</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>NCOLS</code></td>
<td>Количество столбцов</td>
</tr>
<tr class="even">
<td><code>NROWS</code></td>
<td>Количество строк</td>
</tr>
<tr class="odd">
<td><code>XLLCENTER</code></td>
<td>Координата <span class="math inline">\(X\)</span> центра левой нижней ячейки растра</td>
</tr>
<tr class="even">
<td><code>YLLCENTER</code></td>
<td>Координата <span class="math inline">\(Y\)</span> центра левой нижней ячейки растра</td>
</tr>
<tr class="odd">
<td><code>CELLSIZE</code></td>
<td>Размер ячейки</td>
</tr>
</tbody>
</table>
<p>Иногда вместо параметров <code>XLLCENTER</code>/<code>YLLCENTER</code> указываются <code>XLLCORNER</code>/<code>YLLCORNER</code>, которые кодируют координаты левого нижнего угла, а не центра левой нижней ячейки растра. Выбор одного из двух этих вариантов определяет тип <em>регистрации растра</em>, а их значения указывают, в какое именно место необходимо “посадить” растр, чтобы его ячейки заняли соответствующие им области в системе координат. Если геометрия растра характеризуется <em>анизотропией</em>, то вместо одного значения <code>CELLSIZE</code> могут быть указаны разные размеры ячеек по осям координат <code>CELLSIZEX</code> и <code>CELLSIZEY</code>.</p>
<p>В отличие от векторной модели, которая позволяет хранить данные только о нужных географических локациях, растровая модель такой свободы не предоставляет. Матрица ячеек растра всегда покрывает область данных целиком, и за простоту растровой структуры приходится расплачиваться ее неэкономичностью. Поскольку часто данные имеются не на всю территорию, возникает необходимость кодирования ячеек, для которых данные не известны, специальным числом (назовем его условно <code>NODATA_VALUE</code>). Значение этого числа хранится в метаданных растра и позволяет интерпретировать соответствующие ячейки как пустые.</p>
<p>В настоящее время для работы с растровыми данными в R используются два пакета: <a href="https://r-spatial.github.io/stars/"><strong>stars</strong></a> и <a href="https://cran.r-project.org/web/packages/terra/index.html"><strong>terra</strong></a>. <strong>terra</strong> является наследником пакета <a href="https://cran.r-project.org/web/packages/terra/index.html">raster</a>, который исторически был основным средством работы с растровыми данными и обладает широким спектром функций растрового анализа. <strong>stars</strong> — относительно новый, разработан с целью поддержки многомерных данных и более тесного взаимодействия с пакетом <code>sf</code>. В целом можно сказать, что пакеты <strong>terra</strong> и <strong>stars</strong> частично пересекаются по функциональности, но скорее дополняют друг друга, нежели дублируют.</p>
<p>В этой и ближайших лекциях мы будем работать с растрами в формате <strong>stars</strong>, поскольку он концептуально близок к пакету <strong>sf</strong>.</p>
</section>
<section id="raster_read" class="level3" data-number="9.4.2">
<h3 data-number="9.4.2" class="anchored" data-anchor-id="raster_read"><span class="header-section-number">9.4.2</span> Чтение</h3>
<p>Для чтения растров любой размерности можно использовать функцию <code>read_stars()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>dem <span class="ot">=</span> <span class="fu">read_stars</span>(<span class="st">'data/world/gebco.tif'</span>) <span class="co"># Цифровая модель рельефа</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>dem</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="do">## stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="do">## attribute(s):</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="do">##              Min. 1st Qu. Median      Mean 3rd Qu. Max.</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="do">## gebco.tif  -10348   -4287  -2458 -1890.525     215 6581</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="do">## dimension(s):</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   from  to offset delta refsys point x/y</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="do">## x    1 900   -180   0.4 WGS 84 FALSE [x]</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="do">## y    1 450     90  -0.4 WGS 84 FALSE [y]</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>img <span class="ot">=</span> <span class="fu">read_stars</span>(<span class="st">'data/world/BlueMarbleJuly.tif'</span>) <span class="co"># Цветной космический снимок (RGB)</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>img</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="do">## stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="do">## attribute(s):</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="do">##                     Min. 1st Qu. Median     Mean 3rd Qu. Max.</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="do">## BlueMarbleJuly.tif     1      13     33 63.13569      75  255</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="do">## dimension(s):</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a><span class="do">##      from  to offset delta refsys point x/y</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="do">## x       1 720   -180   0.5 WGS 84 FALSE [x]</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="do">## y       1 360     90  -0.5 WGS 84 FALSE [y]</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="do">## band    1   3     NA    NA     NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="stars_inner" class="level3" data-number="9.4.3">
<h3 data-number="9.4.3" class="anchored" data-anchor-id="stars_inner"><span class="header-section-number">9.4.3</span> Внутренняя структура</h3>
<p>Для работы с данными типа stars необходимо понимать их внутреннюю структуру. Для начала можно взглянуть на нее посредством стандартной функции <code>str()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(img)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="do">## List of 1</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  $ BlueMarbleJuly.tif: num [1:720, 1:360, 1:3] 6 4 7 7 7 7 7 8 8 8 ...</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  - attr(*, "dimensions")=List of 3</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   ..$ x   :List of 7</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ from  : num 1</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ to    : num 720</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ offset: num -180</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ delta : num 0.5</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ refsys:List of 2</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. .. ..$ input: chr "WGS 84"</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. .. ..$ wkt  : chr "GEOGCRS[\"WGS 84\",\n    ENSEMBLE[\"World Geodetic System 1984 ensemble\",\n        MEMBER[\"World Geodetic Sys"| __truncated__</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. .. ..- attr(*, "class")= chr "crs"</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ point : logi FALSE</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ values: NULL</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..- attr(*, "class")= chr "dimension"</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="do">##   ..$ y   :List of 7</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ from  : num 1</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ to    : num 360</span></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ offset: num 90</span></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ delta : num -0.5</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ refsys:List of 2</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. .. ..$ input: chr "WGS 84"</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. .. ..$ wkt  : chr "GEOGCRS[\"WGS 84\",\n    ENSEMBLE[\"World Geodetic System 1984 ensemble\",\n        MEMBER[\"World Geodetic Sys"| __truncated__</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. .. ..- attr(*, "class")= chr "crs"</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ point : logi FALSE</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ values: NULL</span></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..- attr(*, "class")= chr "dimension"</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="do">##   ..$ band:List of 7</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ from  : num 1</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ to    : int 3</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ offset: num NA</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ delta : num NA</span></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ refsys: chr NA</span></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ point : logi NA</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ values: NULL</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..- attr(*, "class")= chr "dimension"</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a><span class="do">##   ..- attr(*, "raster")=List of 4</span></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ affine     : num [1:2] 0 0</span></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ dimensions : chr [1:2] "x" "y"</span></span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ curvilinear: logi FALSE</span></span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ blocksizes : int [1:3, 1:2] 720 720 720 1 1 1</span></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. .. ..- attr(*, "dimnames")=List of 2</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. .. .. ..$ : NULL</span></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. .. .. ..$ : chr [1:2] "x" "y"</span></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..- attr(*, "class")= chr "stars_raster"</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a><span class="do">##   ..- attr(*, "class")= chr "dimensions"</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a><span class="do">##  - attr(*, "class")= chr "stars"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Видно, что данный трёхканальный растр представляет собой список из единственного элемента с названием <code>BlueMarbleJuly.tif</code> — это имя было присвоено автоматически при чтении растра. Каждый такой элемент соответствует <em>переменной</em> данных. В данном случае переменная одна — это интенсивность цвета. Хранится она в виде трехмерного массива (<code>array</code>) размерностью <span class="math inline">\(720 \times 360 \times 3\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(img[[<span class="dv">1</span>]])</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  num [1:720, 1:360, 1:3] 6 4 7 7 7 7 7 8 8 8 ...</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>img[[<span class="dv">1</span>]][<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">2</span>]</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Каждой оси этого массива соответствует измерение (<code>dimension</code>), которое определяет параметры отображения индексов массива на соответствующую систему координат (пространственную, временную, спектральную и т.д.). Например, чтобы понять, что ячейка растра с индексами <code>[36, 18, ]</code> имеет географические координаты (широту и долготу) <code>(0, 0)</code>, нужно знать направления осей растра, размер ячейки и координаты одной из угловых ячеек растра. Необходимая информация находится в атрибуте <code>dimensions</code> объекта <code>stars</code>, т.е. является общей для всех переменных. При печати параметры измерений выводятся в удобном табличном виде:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(img, <span class="st">'dimensions'</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="do">##      from  to offset delta refsys point x/y</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="do">## x       1 720   -180   0.5 WGS 84 FALSE [x]</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="do">## y       1 360     90  -0.5 WGS 84 FALSE [y]</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="do">## band    1   3     NA    NA     NA    NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Этот атрибут представляет собой список, длина которого равна количеству измерений в массиве данных переменной. Обычно измерения имеют имена, в данном случае это <code>x</code>, <code>y</code> и <code>band</code>. Описание каждого измерения выполнено по единому шаблону, который включает следующие параметры:</p>
<ul>
<li><code>from</code>: начальный индекс (будет меняться при обрезке растра при постоянной точке отсчета индексов);</li>
<li><code>to</code>: конечный индекс (будет меняться при обрезке растра при постоянной точке отсчета индексов);</li>
<li><code>offset</code>: координата первого пиксела (точки отсчета);</li>
<li><code>delta</code>: размер ячейки;</li>
<li><code>refsys</code>: координатная (референцная) система: для систем счета координат, времени, высот и других измерений будет своя;</li>
<li><code>point</code>: логическое значение, которое указывает, следует ли интерпретировать элементы растра по этой оси как измеренные в точке (мгновенные) или агрегированные по площади (за временной период);</li>
<li><code>values</code>: значения координат ячеек по данной оси
<ul>
<li><code>NULL</code> (используется в большинстве случаев, т.к. координаты могут быть вычислены на основе <code>from</code>, <code>delta</code> и индекса пиксела),</li>
<li>вектор координат (используется для представления ректилинейных растров в переменным размром пиксела),</li>
<li>объект класса <code>intervals</code> (список из двух векторов — начал и концов интервалов), or</li>
<li>матрица координат такой же размерности, что и пространственные измерения растра. В случае стекущего примера будет иметь размер <span class="math inline">\(720 \times 360\)</span>. Используется для представления <em>криволинейных</em> растров.</li>
</ul></li>
</ul>
<p>Например, посмотрим параметры измерения <code>x</code> растра:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(img, <span class="st">'dimensions'</span>)[[<span class="st">'x'</span>]]</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="do">## $from</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 1</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="do">## $to</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 720</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="do">## $offset</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] -180</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="do">## $delta</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 0.5</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="do">## $refsys</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System:</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="do">##   User input: WGS 84 </span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="do">##   wkt:</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="do">## GEOGCRS["WGS 84",</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="do">##     ENSEMBLE["World Geodetic System 1984 ensemble",</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (Transit)"],</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G730)"],</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G873)"],</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1150)"],</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1674)"],</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1762)"],</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G2139)"],</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a><span class="do">##         ELLIPSOID["WGS 84",6378137,298.257223563,</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1]],</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a><span class="do">##         ENSEMBLEACCURACY[2.0]],</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a><span class="do">##     PRIMEM["Greenwich",0,</span></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a><span class="do">##         ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a><span class="do">##     CS[ellipsoidal,2],</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic latitude (Lat)",north,</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[1],</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic longitude (Lon)",east,</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[2],</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a><span class="do">##     USAGE[</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a><span class="do">##         SCOPE["Horizontal component of 3D system."],</span></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="do">##         AREA["World."],</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="do">##         BBOX[-90,-180,90,180]],</span></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a><span class="do">##     ID["EPSG",4326]]</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a><span class="do">## $point</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] FALSE</span></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a><span class="do">## $values</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a><span class="do">## NULL</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a><span class="do">## attr(,"class")</span></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] "dimension"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Наконец, дополнительно к этому атрибут <code>dimensions</code> имеет свой собственный атрибут <code>raster</code>, который необходим для того чтобы определить какие именно измерения растра являются пространственными, а также установить преобразования, которые будут над ними производиться при анализе или визулизации:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>img <span class="sc">|&gt;</span> <span class="fu">attr</span>(<span class="st">'dimensions'</span>) <span class="sc">|&gt;</span> <span class="fu">attr</span>(<span class="st">'raster'</span>) <span class="sc">|&gt;</span> <span class="fu">str</span>()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="do">## List of 4</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  $ affine     : num [1:2] 0 0</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  $ dimensions : chr [1:2] "x" "y"</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="do">##  $ curvilinear: logi FALSE</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="do">##  $ blocksizes : int [1:3, 1:2] 720 720 720 1 1 1</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="do">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ : NULL</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   .. ..$ : chr [1:2] "x" "y"</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  - attr(*, "class")= chr "stars_raster"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Видно, что атрибут <code>raster</code> содержит 3 элемента:</p>
<ul>
<li><code>dimensions</code>: названия измерений, которые являются пространственными</li>
<li><code>affine</code>: параметры аффинного преобразования, которое будет применяться к пространственным измерениям перед их отображением или применением в операциях пространственного анализа</li>
<li><code>curvilinear</code>: логическое значение, которое устанавливает, является ли растр криволинейным (в этом случае в параметре <code>values</code> пространственных измерений должна быть матрица координат)</li>
</ul>
</section>
<section id="raster_viz" class="level3" data-number="9.4.4">
<h3 data-number="9.4.4" class="anchored" data-anchor-id="raster_viz"><span class="header-section-number">9.4.4</span> Визуализация</h3>
<section id="raster_viz_static" class="level4" data-number="9.4.4.1">
<h4 data-number="9.4.4.1" class="anchored" data-anchor-id="raster_viz_static"><span class="header-section-number">9.4.4.1</span> Статичные карты</h4>
<p>Для визуализации одноканальных растров используется функция <code>plot()</code>. В простейшем виде ей достаточно просто передать визуализируемый растр:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dem)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Поскольку растры часто используют в классифицированном виде, вы можете сформировать вектор граничных значений классов, вектор цветов классов, и передать их в параметры <code>breaks</code> и <code>col</code> функции <code>plot()</code> соответственно. Если параметр <code>breaks</code> не определять, то весь диапазон значений растра будет разбит на равные интервалы соответственно количеству цветов. Если не определять параметр <code>col</code>, то будет применена стандартная палитра <code>terrain.colors</code>. Вы также можете использовать одну из готовых палитр цветов или создать ее вручную (см. посвященную графической подсистеме R):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">12000</span>, <span class="sc">-</span><span class="dv">5000</span>, <span class="sc">-</span><span class="dv">2500</span>, <span class="sc">-</span><span class="dv">1000</span>, <span class="sc">-</span><span class="dv">200</span>, <span class="dv">0</span>, <span class="dv">200</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">2000</span>, <span class="dv">4000</span>, <span class="dv">8000</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>clrs <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"steelblue4"</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"steelblue3"</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"steelblue2"</span>,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"steelblue1"</span>,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lightskyblue1"</span>,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"darkseagreen"</span>,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"lightgoldenrod1"</span>,</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"darkgoldenrod1"</span>,</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"darkorange"</span>,</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"coral2"</span>,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"firebrick3"</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dem, <span class="at">breaks =</span> brks, <span class="at">col =</span> clrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dem, <span class="at">col =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"white"</span>))(<span class="dv">255</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-58-2.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dem, <span class="at">col =</span> <span class="fu">rainbow</span>(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-58-3.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Для синтезирования цветного изображения на основе многоканального растра необходимо объект <code>stars</code> предварительно подать в функцию <code>st_rgb()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_rgb</span>(img))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Поскольку при визуализации космических снимков часто используют различные варианты синтеза каналов (чтобы лучше дешифрировать те или иные категории объектов), функция <code>st_rgb()</code> предоставляет такую возможность. Достаточно перечислить последовательность каналов растрового стека (по умолчанию эти каналы будут подставлены в каналы R, G и B соответственно):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_rgb</span>(img[,,,<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)]) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-60-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_rgb</span>(img[,,,<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>)]) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-60-2.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_rgb</span>(img[,,,<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">3</span>)]) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-60-3.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_rgb</span>(img[,,,<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>)]) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-60-4.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_rgb</span>(img[,,,<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">2</span>)]) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-60-5.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_rgb</span>(img[,,,<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>)]) <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-60-6.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Вы можете совмещать на картах несколько растровых и векторных слоев точно так же как и при совмещении векторных данных (указав параметр <code>add = TRUE</code> при вызове функции <code>plot()</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_rgb</span>(img), <span class="at">reset =</span> <span class="cn">FALSE</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(outlines, <span class="at">border =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">lwd =</span> <span class="fl">0.5</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-61-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="raster_viz_inter" class="level4" data-number="9.4.4.2">
<h4 data-number="9.4.4.2" class="anchored" data-anchor-id="raster_viz_inter"><span class="header-section-number">9.4.4.2</span> Интерактивные карты</h4>
<p>Объекты типа stars могут быть визуализированы аналогично векторным на интерактивных картах <code>mapview</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mapview</span>(dem, <span class="at">at =</span> brks, <span class="at">col =</span> clrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="images/mapview4.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="raster_crop" class="level3" data-number="9.4.5">
<h3 data-number="9.4.5" class="anchored" data-anchor-id="raster_crop"><span class="header-section-number">9.4.5</span> Обрезка</h3>
<p>Одна из распространенных задач при работе с растрами — это обрезка, то есть удаление растровых данных, находящихся за пределами указанной территории. Чаще всего обрезку делают либо ограничивающим прямоугольником, либо полигональным объектом. Рассмотрим оба варианта:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Обрезка по ограничивающему прямоугольнику</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>box <span class="ot">=</span> <span class="fu">st_bbox</span>(<span class="fu">c</span>(<span class="at">xmin =</span> <span class="sc">-</span><span class="dv">80</span>, <span class="at">xmax =</span> <span class="sc">-</span><span class="dv">10</span>, <span class="at">ymax =</span> <span class="dv">85</span>, <span class="at">ymin =</span> <span class="dv">58</span>), <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>))</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>dem_greenland <span class="ot">=</span> dem[box]</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>dem_greenland</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="do">## stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="do">## attribute(s):</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="do">##             Min. 1st Qu. Median     Mean 3rd Qu. Max.</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="do">## gebco.tif  -4041    -811    -49 70.50328 1187.25 3228</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="do">## dimension(s):</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="do">##   from  to offset delta refsys point x/y</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="do">## x  251 425   -180   0.4 WGS 84 FALSE [x]</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="do">## y   13  80     90  -0.4 WGS 84 FALSE [y]</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dem_greenland)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Аналогичным образом можено обрезать растр контуром выбранной страны:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>country <span class="ot">=</span> countries <span class="sc">|&gt;</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(name <span class="sc">==</span> <span class="st">'Afghanistan'</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>dem_country <span class="ot">=</span> dem[country]</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>dem_country</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="do">## stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="do">## attribute(s):</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="do">##            Min. 1st Qu. Median     Mean 3rd Qu. Max. NA's</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="do">## gebco.tif   261   877.5   1628 1824.854    2635 5036  485</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="do">## dimension(s):</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   from  to offset delta refsys point x/y</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="do">## x  602 638   -180   0.4 WGS 84 FALSE [x]</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a><span class="do">## y  129 152     90  -0.4 WGS 84 FALSE [y]</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(dem_country)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="индексирование" class="level3" data-number="9.4.6">
<h3 data-number="9.4.6" class="anchored" data-anchor-id="индексирование"><span class="header-section-number">9.4.6</span> Индексирование</h3>
<p>Ортогональная структура объектов типа stars позволяет выполнять по ним различные срезы, отсекая ненужные данные. Для этого используется привычный по работе с векторами оператор квадратной скобки <code>[</code>, который работает следующим образом:</p>
<ul>
<li>первый аргумент выбирает атрибут</li>
<li>второй и последующий аргументы выбирают измерения.</li>
</ul>
<p>Таким образом, при работе с растрами, которые содержат один атрибут, вам необходимо указать 4 индекса: <code>[var, x, y, band]</code>, где <code>var</code> - это название или порядковый номер атрибута, а <code>x, y, band</code> — порядковые номера двух координатных и одного семантического измерения.</p>
<p>Например:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># выбрать 1 канал</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>ch1 <span class="ot">=</span> img[,,,<span class="dv">1</span>] </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>ch1</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="do">## stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="do">## attribute(s):</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="do">##                     Min. 1st Qu. Median    Mean 3rd Qu. Max.</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="do">## BlueMarbleJuly.tif     1       5     14 51.1141      47  255</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="do">## dimension(s):</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="do">##      from  to offset delta refsys point x/y</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="do">## x       1 720   -180   0.5 WGS 84 FALSE [x]</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="do">## y       1 360     90  -0.5 WGS 84 FALSE [y]</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="do">## band    1   1     NA    NA     NA    NA</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ch1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-66-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="co"># выбрать диапазон ячеек растра</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>frag <span class="ot">=</span> img[, <span class="dv">320</span><span class="sc">:</span><span class="dv">470</span>, <span class="dv">100</span><span class="sc">:</span><span class="dv">255</span>, ] </span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>frag</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="do">## stars object with 3 dimensions and 1 attribute</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="do">## attribute(s):</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="do">##                     Min. 1st Qu. Median     Mean 3rd Qu. Max.</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="do">## BlueMarbleJuly.tif     1      20     50 65.96065     106  221</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="do">## dimension(s):</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="do">##      from  to offset delta refsys point x/y</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="do">## x     320 470   -180   0.5 WGS 84 FALSE [x]</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="do">## y     100 255     90  -0.5 WGS 84 FALSE [y]</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="do">## band    1   3     NA    NA     NA    NA</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_rgb</span>(frag))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-66-2.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="манипуляции" class="level3" data-number="9.4.7">
<h3 data-number="9.4.7" class="anchored" data-anchor-id="манипуляции"><span class="header-section-number">9.4.7</span> Манипуляции</h3>
<p>Объекты типа <code>stars</code> поддерживают манипуляции, аналогичные тем, что могут применяться к векторным данным. Посмотрим это на примере данных по высоте земной поверхности с учетом и без покровного оледенения:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>etopo <span class="ot">=</span> <span class="fu">read_stars</span>(<span class="fu">c</span>(<span class="st">'data/etopo1_bed.tif'</span>, <span class="st">'data/etopo1_ice.tif'</span>))</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>etopo</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="do">## stars object with 2 dimensions and 2 attributes</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="do">## attribute(s):</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="do">##        Min. 1st Qu.  Median      Mean 3rd Qu. Max.</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="do">## bed  -10632   -4287 -2451.5 -2113.199      86 6159</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="do">## ice  -10632   -4287 -2451.5 -1892.726     215 6159</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="do">## dimension(s):</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   from  to offset delta refsys point x/y</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="do">## x    1 720   -180   0.5 WGS 84 FALSE [x]</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="do">## y    1 360     90  -0.5 WGS 84 FALSE [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Для начала переименуем переменные:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>etopo <span class="ot">=</span> etopo <span class="sc">|&gt;</span> <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">'bed'</span>, <span class="st">'ice'</span>))</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>etopo</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="do">## stars object with 2 dimensions and 2 attributes</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="do">## attribute(s):</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="do">##        Min. 1st Qu.  Median      Mean 3rd Qu. Max.</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="do">## bed  -10632   -4287 -2451.5 -2113.199      86 6159</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="do">## ice  -10632   -4287 -2451.5 -1892.726     215 6159</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="do">## dimension(s):</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   from  to offset delta refsys point x/y</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="do">## x    1 720   -180   0.5 WGS 84 FALSE [x]</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="do">## y    1 360     90  -0.5 WGS 84 FALSE [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>После этого посчитаем, например, толщину покровного оледеления как разность <code>ice</code> и <code>bed</code> через <em>мутирование</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>etopo <span class="ot">=</span> etopo <span class="sc">|&gt;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">depth =</span> ice <span class="sc">-</span> bed)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(etopo[<span class="st">'depth'</span>], </span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">cm.colors</span>(<span class="dv">5</span>),</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">2000</span>, <span class="dv">3000</span>, <span class="dv">4000</span>),</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">'Мощность покровного оледенения'</span>,</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">reset =</span> <span class="cn">FALSE</span>)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(oceans, <span class="at">col =</span> <span class="st">'steelblue'</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p><em>Фильтрация</em> происходит по измерениям, но применяется не к индексам ячеек, а к соответствующим величинам измерений:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>greenland <span class="ot">=</span> etopo <span class="sc">|&gt;</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(x <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">80</span>, x <span class="sc">&lt;</span> <span class="sc">-</span><span class="dv">10</span>, y <span class="sc">&gt;</span> <span class="dv">58</span>, y <span class="sc">&lt;</span> <span class="dv">85</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(greenland)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-70-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p><em>Выбор</em> переменной позволяет оставить только ее:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>icedepth <span class="ot">=</span> etopo <span class="sc">|&gt;</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(depth)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>icedepth</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="do">## stars object with 2 dimensions and 1 attribute</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="do">## attribute(s):</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="do">##        Min. 1st Qu. Median     Mean 3rd Qu. Max.</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="do">## depth  -198       0      0 220.4736       0 4286</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="do">## dimension(s):</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="do">##   from  to offset delta refsys point x/y</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="do">## x    1 720   -180   0.5 WGS 84 FALSE [x]</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="do">## y    1 360     90  -0.5 WGS 84 FALSE [y]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="raster_export" class="level3" data-number="9.4.8">
<h3 data-number="9.4.8" class="anchored" data-anchor-id="raster_export"><span class="header-section-number">9.4.8</span> Экспорт</h3>
<p>Чтобы экспортировать (сохранить в файл) любой растр, можно воспользоваться функцией <code>write_stars()</code>, указав имя выходного файла:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stars</span>(greenland, <span class="st">'data/world/greenland.tif'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="spatref" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="spatref"><span class="header-section-number">9.5</span> Пространственная привязка</h2>
<section id="spatref_components" class="level3" data-number="9.5.1">
<h3 data-number="9.5.1" class="anchored" data-anchor-id="spatref_components"><span class="header-section-number">9.5.1</span> Компоненты пространственной привязки</h3>
<p><strong>Пространственная привязка</strong> (<em>spatial reference</em> или <em>georeference</em>) — важнейшая составляющая пространственных данных, которая говорит нам о том, как правильно интерпретировать координаты объектов. Пространственная привязка в простейшем случае включает несколько фундаментальных компонент:</p>
<ol type="1">
<li><em>Эллипсоид вращения</em> — тело, по отношению к которому вычисляются геодезические координаты точек (широты и долготы)</li>
<li><em>Исходные геодезические даты (датум)</em> — параметры положения эллипсоида в теле Земли</li>
<li><em>Географическая система координат</em> — включает датум, положение начального меридиана и единицы измерения широт и долгот</li>
<li><em>Проекция</em> — математический способ перехода от географических координат на эллипсоиде к плоским прямоугольным координатам карты.</li>
<li><em>Плоская прямоугольная система координат</em> — включает проекцию, ее параметры и единицы измерения координат.</li>
</ol>
<p>Если точки имеют также координаты <span class="math inline">\(Z\)</span>, то для их правильной интерпретации необходимы дополнительные компоненты пространственной привязки:</p>
<ol type="1">
<li><em>Система счета высот</em> (геодезические, нормальные, ортометрические) - определяют содержательный смысл и порядок вычисления высот и глубин (координата Z)</li>
<li><em>Модель геоида, квазигеоида или эллипсоида</em> — определяет поверхность, относительно которой вычисляются высоты точек.</li>
<li><em>Вертикальная система координат</em> — фактическая реализация системы счета высот относительно конкретной поверхности относимости с заданным положением нулевого уровня. Например, в России это <em>Балтийская система нормальных высот</em> с нулем в г. Кронштадт.</li>
</ol>
<p>Аналогичным образом требуется введение системы счета дополнительных координат <span class="math inline">\(M\)</span>, если они используются в представлении координат.</p>
</section>
<section id="spatref_formats" class="level3" data-number="9.5.2">
<h3 data-number="9.5.2" class="anchored" data-anchor-id="spatref_formats"><span class="header-section-number">9.5.2</span> Форматы описания пространственной привязки</h3>
<p>Существует три распространенных способа задания (хранения) пространственной привязки:</p>
<ul>
<li><em>PROJ.4 String</em> — представление в виде строки.</li>
<li><em>WKT (Well-Known Text)</em> — представление в виде иерархического списка. Это <em>наиболее полный</em> формат описания пространственной привязки, который рекомендуется к использованию для избежания неоднозначностей.</li>
<li><em>EPSG (European Petroleum Survey Group)</em> — представление в виде числового кода.</li>
</ul>
<p>Для поиска проекций в перечисленных форматах представления удобно воспользоваться порталом <a href="spatialreference.org">spatialreference.org</a>.</p>
<p><strong>PROJ.4 String</strong> — строковый формат представления информации о пространственной привязки, используемый в библиотеке <a href="http://proj.org"><strong>PROJ</strong></a>. Данная библиотека лежит в основе координатных систем пространственных данных, используется в <strong>R</strong>, <strong>Python</strong>, <strong>QGIS</strong> и прочих средах. Основные параметры строки:</p>
<pre><code>+datum     Datum name (see `proj -ld`)
+ellps     Ellipsoid name (see `proj -le`)
+lat_0     Latitude of origin
+lat_1     Latitude of first standard parallel
+lat_2     Latitude of second standard parallel
+lat_ts    Latitude of true scale
+lon_0     Central meridian
+proj      Projection name (see `proj -l`)
+units     meters, US survey feet, etc.
+vunits    vertical units.
+x_0       False easting
+y_0       False northing
+zone      UTM zone</code></pre>
<p>Примеры записи координат в формате PROJ.4:</p>
<ul>
<li>Географические координаты в <em>WGS84</em> (без проекции):</li>
</ul>
<ul>
<li>Координаты в проекции <em>Web Mercator</em> (проекция Google Maps, Яндекс.Карт и т.д.):</li>
</ul>
<ul>
<li>Координаты в <em>конической равнопромежуточной проекции</em>:</li>
</ul>
<ul>
<li>Координаты в проекции <em>UTM, зона 37</em>:</li>
</ul>
<p><strong>WKT</strong> предполагает представление вышеуказанных компонент пространственной привязки к виде иерархического списка. Например, так будет выглядеть информация о <em>полярной стереографической проекции для карт России</em>:</p>
<pre><code>PROJCS["WGS 84 / EPSG Russia Polar Stereographic",
    GEOGCS["WGS 84",
        DATUM["WGS_1984",
            SPHEROID["WGS 84",6378137,298.257223563,
                AUTHORITY["EPSG","7030"]],
            AUTHORITY["EPSG","6326"]],
        PRIMEM["Greenwich",0,
            AUTHORITY["EPSG","8901"]],
        UNIT["degree",0.0174532925199433,
            AUTHORITY["EPSG","9122"]],
        AUTHORITY["EPSG","4326"]],
    PROJECTION["Polar_Stereographic"],
    PARAMETER["latitude_of_origin",90],
    PARAMETER["central_meridian",105],
    PARAMETER["scale_factor",0.994],
    PARAMETER["false_easting",2000000],
    PARAMETER["false_northing",2000000],
    UNIT["metre",1,
        AUTHORITY["EPSG","9001"]],
    AXIS["X",EAST],
    AXIS["Y",NORTH],
    AUTHORITY["EPSG","5940"]]</code></pre>
<p><strong>EPSG (European Petroleum Survey Group)</strong> — европейская рабочая группа нефтегазовой области, которая ведет реестр систем координат с уникальными цифровыми кодами вида <code>EPSG:xxxxxx</code>. Коды EPSG оказались настолько удобны, что используются повсеместно для быстрой инициализации проекций со стандартными параметрами. Например, вышеприведенные проекции имеют следующие коды EPSG:</p>
<ul>
<li><em>WGS84</em>: <code>EPSG:4326</code></li>
<li><em>Web Mercator</em>: <code>EPSG:3857</code></li>
<li><em>UTM</em>: <code>EPSG:326..</code> , например для UTM 37N: <code>EPSG:32637</code></li>
</ul>
</section>
<section id="spatref_transform" class="level3" data-number="9.5.3">
<h3 data-number="9.5.3" class="anchored" data-anchor-id="spatref_transform"><span class="header-section-number">9.5.3</span> Преобразование координат</h3>
<p>Преобразование координат включает три различных операции:</p>
<ol type="1">
<li><p><strong>Трансформирование</strong> — пересчет географических координат с одного датума на другой</p></li>
<li><p><strong>Проецирование</strong> — переход от географических координат к плоским прямоугольным</p></li>
<li><p><strong>Обратное проецирование</strong> — переход от плоских координат к географическим.</p></li>
</ol>
<p>Например, чтобы пересчитать координаты <em>UTM</em> в проекцию <em>Гаусса-Крюгера</em>, необходимо:</p>
<ol type="1">
<li>Обратно проецировать координаты в географические <em>WGS84</em></li>
<li>Трансформировать географические координаты c <em>WGS84</em> в <em>ГСК-2011</em></li>
<li>Проецировать координаты <em>ГСК-2011</em> в проекцию <em>Гаусса-Крюгера</em></li>
</ol>
<p><em>Несоответствие датумов часто является причиной того, что данные из разных наборов плохо совмещаются друг с другом</em></p>
</section>
<section id="sf_crs" class="level3" data-number="9.5.4">
<h3 data-number="9.5.4" class="anchored" data-anchor-id="sf_crs"><span class="header-section-number">9.5.4</span> Работа с пространственной привязкой в R</h3>
<p>Работа с пространственной привязкой данных в R состоит в основном из четырех операций:</p>
<ul>
<li>чтение информации о системе координат</li>
<li>создание информации о системе координат</li>
<li>замена информации о системе координат</li>
<li>изменение системы координат (проецирование)</li>
</ul>
<p>Первые три операции (чтение, создание, замена) осуществляются функцией <code>st_crs()</code>. Чтобы прочитать информацию о проекции, достаточно передать в качестве параметра объект типа <code>sf</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(countries)    <span class="co"># Координатная система</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System:</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   User input: WGS 84 </span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   wkt:</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="do">## GEOGCRS["WGS 84",</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="do">##     ENSEMBLE["World Geodetic System 1984 ensemble",</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (Transit)"],</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G730)"],</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G873)"],</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1150)"],</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1674)"],</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1762)"],</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G2139)"],</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a><span class="do">##         ELLIPSOID["WGS 84",6378137,298.257223563,</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1]],</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a><span class="do">##         ENSEMBLEACCURACY[2.0]],</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="do">##     PRIMEM["Greenwich",0,</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a><span class="do">##         ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a><span class="do">##     CS[ellipsoidal,2],</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic latitude (Lat)",north,</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[1],</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic longitude (Lon)",east,</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[2],</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a><span class="do">##     USAGE[</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a><span class="do">##         SCOPE["Horizontal component of 3D system."],</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a><span class="do">##         AREA["World."],</span></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a><span class="do">##         BBOX[-90,-180,90,180]],</span></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a><span class="do">##     ID["EPSG",4326]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Эта же функция позволяет создать новую координатную систему, путем передачи ей кода <em>EPSG</em> или строки <em>PROJ.4</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(<span class="dv">3857</span>) <span class="co"># Проекция Меркатора для карт мира</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System:</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   User input: EPSG:3857 </span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   wkt:</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="do">## PROJCRS["WGS 84 / Pseudo-Mercator",</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="do">##     BASEGEOGCRS["WGS 84",</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="do">##         ENSEMBLE["World Geodetic System 1984 ensemble",</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a><span class="do">##             MEMBER["World Geodetic System 1984 (Transit)"],</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="do">##             MEMBER["World Geodetic System 1984 (G730)"],</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a><span class="do">##             MEMBER["World Geodetic System 1984 (G873)"],</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="do">##             MEMBER["World Geodetic System 1984 (G1150)"],</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="do">##             MEMBER["World Geodetic System 1984 (G1674)"],</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a><span class="do">##             MEMBER["World Geodetic System 1984 (G1762)"],</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a><span class="do">##             MEMBER["World Geodetic System 1984 (G2139)"],</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a><span class="do">##             ELLIPSOID["WGS 84",6378137,298.257223563,</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a><span class="do">##                 LENGTHUNIT["metre",1]],</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a><span class="do">##             ENSEMBLEACCURACY[2.0]],</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a><span class="do">##         PRIMEM["Greenwich",0,</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a><span class="do">##         ID["EPSG",4326]],</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a><span class="do">##     CONVERSION["Popular Visualisation Pseudo-Mercator",</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a><span class="do">##         METHOD["Popular Visualisation Pseudo Mercator",</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",1024]],</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["Latitude of natural origin",0,</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433],</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8801]],</span></span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["Longitude of natural origin",0,</span></span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433],</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8802]],</span></span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["False easting",0,</span></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1],</span></span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8806]],</span></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["False northing",0,</span></span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1],</span></span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8807]]],</span></span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a><span class="do">##     CS[Cartesian,2],</span></span>
<span id="cb78-37"><a href="#cb78-37" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["easting (X)",east,</span></span>
<span id="cb78-38"><a href="#cb78-38" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[1],</span></span>
<span id="cb78-39"><a href="#cb78-39" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1]],</span></span>
<span id="cb78-40"><a href="#cb78-40" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["northing (Y)",north,</span></span>
<span id="cb78-41"><a href="#cb78-41" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[2],</span></span>
<span id="cb78-42"><a href="#cb78-42" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1]],</span></span>
<span id="cb78-43"><a href="#cb78-43" aria-hidden="true" tabindex="-1"></a><span class="do">##     USAGE[</span></span>
<span id="cb78-44"><a href="#cb78-44" aria-hidden="true" tabindex="-1"></a><span class="do">##         SCOPE["Web mapping and visualisation."],</span></span>
<span id="cb78-45"><a href="#cb78-45" aria-hidden="true" tabindex="-1"></a><span class="do">##         AREA["World between 85.06°S and 85.06°N."],</span></span>
<span id="cb78-46"><a href="#cb78-46" aria-hidden="true" tabindex="-1"></a><span class="do">##         BBOX[-85.06,-180,85.06,180]],</span></span>
<span id="cb78-47"><a href="#cb78-47" aria-hidden="true" tabindex="-1"></a><span class="do">##     ID["EPSG",3857]]</span></span>
<span id="cb78-48"><a href="#cb78-48" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(<span class="st">'+proj=robin'</span>) <span class="co"># Проекция Робинсона для карт мира</span></span>
<span id="cb78-49"><a href="#cb78-49" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System:</span></span>
<span id="cb78-50"><a href="#cb78-50" aria-hidden="true" tabindex="-1"></a><span class="do">##   User input: +proj=robin </span></span>
<span id="cb78-51"><a href="#cb78-51" aria-hidden="true" tabindex="-1"></a><span class="do">##   wkt:</span></span>
<span id="cb78-52"><a href="#cb78-52" aria-hidden="true" tabindex="-1"></a><span class="do">## PROJCRS["unknown",</span></span>
<span id="cb78-53"><a href="#cb78-53" aria-hidden="true" tabindex="-1"></a><span class="do">##     BASEGEOGCRS["unknown",</span></span>
<span id="cb78-54"><a href="#cb78-54" aria-hidden="true" tabindex="-1"></a><span class="do">##         DATUM["World Geodetic System 1984",</span></span>
<span id="cb78-55"><a href="#cb78-55" aria-hidden="true" tabindex="-1"></a><span class="do">##             ELLIPSOID["WGS 84",6378137,298.257223563,</span></span>
<span id="cb78-56"><a href="#cb78-56" aria-hidden="true" tabindex="-1"></a><span class="do">##                 LENGTHUNIT["metre",1]],</span></span>
<span id="cb78-57"><a href="#cb78-57" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",6326]],</span></span>
<span id="cb78-58"><a href="#cb78-58" aria-hidden="true" tabindex="-1"></a><span class="do">##         PRIMEM["Greenwich",0,</span></span>
<span id="cb78-59"><a href="#cb78-59" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433],</span></span>
<span id="cb78-60"><a href="#cb78-60" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8901]]],</span></span>
<span id="cb78-61"><a href="#cb78-61" aria-hidden="true" tabindex="-1"></a><span class="do">##     CONVERSION["unknown",</span></span>
<span id="cb78-62"><a href="#cb78-62" aria-hidden="true" tabindex="-1"></a><span class="do">##         METHOD["Robinson"],</span></span>
<span id="cb78-63"><a href="#cb78-63" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["Longitude of natural origin",0,</span></span>
<span id="cb78-64"><a href="#cb78-64" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433],</span></span>
<span id="cb78-65"><a href="#cb78-65" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8802]],</span></span>
<span id="cb78-66"><a href="#cb78-66" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["False easting",0,</span></span>
<span id="cb78-67"><a href="#cb78-67" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1],</span></span>
<span id="cb78-68"><a href="#cb78-68" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8806]],</span></span>
<span id="cb78-69"><a href="#cb78-69" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["False northing",0,</span></span>
<span id="cb78-70"><a href="#cb78-70" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1],</span></span>
<span id="cb78-71"><a href="#cb78-71" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8807]]],</span></span>
<span id="cb78-72"><a href="#cb78-72" aria-hidden="true" tabindex="-1"></a><span class="do">##     CS[Cartesian,2],</span></span>
<span id="cb78-73"><a href="#cb78-73" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["(E)",east,</span></span>
<span id="cb78-74"><a href="#cb78-74" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[1],</span></span>
<span id="cb78-75"><a href="#cb78-75" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1,</span></span>
<span id="cb78-76"><a href="#cb78-76" aria-hidden="true" tabindex="-1"></a><span class="do">##                 ID["EPSG",9001]]],</span></span>
<span id="cb78-77"><a href="#cb78-77" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["(N)",north,</span></span>
<span id="cb78-78"><a href="#cb78-78" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[2],</span></span>
<span id="cb78-79"><a href="#cb78-79" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1,</span></span>
<span id="cb78-80"><a href="#cb78-80" aria-hidden="true" tabindex="-1"></a><span class="do">##                 ID["EPSG",9001]]]]</span></span>
<span id="cb78-81"><a href="#cb78-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-82"><a href="#cb78-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Проекция UTM, зона 37.</span></span>
<span id="cb78-83"><a href="#cb78-83" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(<span class="st">'+proj=utm +zone=37 +datum=WGS84 +units=m'</span>)</span>
<span id="cb78-84"><a href="#cb78-84" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System:</span></span>
<span id="cb78-85"><a href="#cb78-85" aria-hidden="true" tabindex="-1"></a><span class="do">##   User input: +proj=utm +zone=37 +datum=WGS84 +units=m </span></span>
<span id="cb78-86"><a href="#cb78-86" aria-hidden="true" tabindex="-1"></a><span class="do">##   wkt:</span></span>
<span id="cb78-87"><a href="#cb78-87" aria-hidden="true" tabindex="-1"></a><span class="do">## PROJCRS["unknown",</span></span>
<span id="cb78-88"><a href="#cb78-88" aria-hidden="true" tabindex="-1"></a><span class="do">##     BASEGEOGCRS["unknown",</span></span>
<span id="cb78-89"><a href="#cb78-89" aria-hidden="true" tabindex="-1"></a><span class="do">##         DATUM["World Geodetic System 1984",</span></span>
<span id="cb78-90"><a href="#cb78-90" aria-hidden="true" tabindex="-1"></a><span class="do">##             ELLIPSOID["WGS 84",6378137,298.257223563,</span></span>
<span id="cb78-91"><a href="#cb78-91" aria-hidden="true" tabindex="-1"></a><span class="do">##                 LENGTHUNIT["metre",1]],</span></span>
<span id="cb78-92"><a href="#cb78-92" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",6326]],</span></span>
<span id="cb78-93"><a href="#cb78-93" aria-hidden="true" tabindex="-1"></a><span class="do">##         PRIMEM["Greenwich",0,</span></span>
<span id="cb78-94"><a href="#cb78-94" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433],</span></span>
<span id="cb78-95"><a href="#cb78-95" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8901]]],</span></span>
<span id="cb78-96"><a href="#cb78-96" aria-hidden="true" tabindex="-1"></a><span class="do">##     CONVERSION["UTM zone 37N",</span></span>
<span id="cb78-97"><a href="#cb78-97" aria-hidden="true" tabindex="-1"></a><span class="do">##         METHOD["Transverse Mercator",</span></span>
<span id="cb78-98"><a href="#cb78-98" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",9807]],</span></span>
<span id="cb78-99"><a href="#cb78-99" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["Latitude of natural origin",0,</span></span>
<span id="cb78-100"><a href="#cb78-100" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433],</span></span>
<span id="cb78-101"><a href="#cb78-101" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8801]],</span></span>
<span id="cb78-102"><a href="#cb78-102" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["Longitude of natural origin",39,</span></span>
<span id="cb78-103"><a href="#cb78-103" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433],</span></span>
<span id="cb78-104"><a href="#cb78-104" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8802]],</span></span>
<span id="cb78-105"><a href="#cb78-105" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["Scale factor at natural origin",0.9996,</span></span>
<span id="cb78-106"><a href="#cb78-106" aria-hidden="true" tabindex="-1"></a><span class="do">##             SCALEUNIT["unity",1],</span></span>
<span id="cb78-107"><a href="#cb78-107" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8805]],</span></span>
<span id="cb78-108"><a href="#cb78-108" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["False easting",500000,</span></span>
<span id="cb78-109"><a href="#cb78-109" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1],</span></span>
<span id="cb78-110"><a href="#cb78-110" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8806]],</span></span>
<span id="cb78-111"><a href="#cb78-111" aria-hidden="true" tabindex="-1"></a><span class="do">##         PARAMETER["False northing",0,</span></span>
<span id="cb78-112"><a href="#cb78-112" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1],</span></span>
<span id="cb78-113"><a href="#cb78-113" aria-hidden="true" tabindex="-1"></a><span class="do">##             ID["EPSG",8807]],</span></span>
<span id="cb78-114"><a href="#cb78-114" aria-hidden="true" tabindex="-1"></a><span class="do">##         ID["EPSG",16037]],</span></span>
<span id="cb78-115"><a href="#cb78-115" aria-hidden="true" tabindex="-1"></a><span class="do">##     CS[Cartesian,2],</span></span>
<span id="cb78-116"><a href="#cb78-116" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["(E)",east,</span></span>
<span id="cb78-117"><a href="#cb78-117" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[1],</span></span>
<span id="cb78-118"><a href="#cb78-118" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1,</span></span>
<span id="cb78-119"><a href="#cb78-119" aria-hidden="true" tabindex="-1"></a><span class="do">##                 ID["EPSG",9001]]],</span></span>
<span id="cb78-120"><a href="#cb78-120" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["(N)",north,</span></span>
<span id="cb78-121"><a href="#cb78-121" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[2],</span></span>
<span id="cb78-122"><a href="#cb78-122" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1,</span></span>
<span id="cb78-123"><a href="#cb78-123" aria-hidden="true" tabindex="-1"></a><span class="do">##                 ID["EPSG",9001]]]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Замена координатной системы требуется в тех случаях, когда слой не имеет пространственной привязки, или же она задана некорректно. В этом случае необходимо вызвать для слоя функцию <code>st_crs()</code> и перезаписать результат.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(countries) <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(countries) </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System: NA</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(countries) <span class="ot">=</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(countries)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System:</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="do">##   User input: EPSG:4326 </span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   wkt:</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="do">## GEOGCRS["WGS 84",</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="do">##     ENSEMBLE["World Geodetic System 1984 ensemble",</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (Transit)"],</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G730)"],</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G873)"],</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1150)"],</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1674)"],</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1762)"],</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G2139)"],</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a><span class="do">##         ELLIPSOID["WGS 84",6378137,298.257223563,</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1]],</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a><span class="do">##         ENSEMBLEACCURACY[2.0]],</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a><span class="do">##     PRIMEM["Greenwich",0,</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a><span class="do">##         ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a><span class="do">##     CS[ellipsoidal,2],</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic latitude (Lat)",north,</span></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[1],</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic longitude (Lon)",east,</span></span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[2],</span></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a><span class="do">##     USAGE[</span></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a><span class="do">##         SCOPE["Horizontal component of 3D system."],</span></span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a><span class="do">##         AREA["World."],</span></span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a><span class="do">##         BBOX[-90,-180,90,180]],</span></span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a><span class="do">##     ID["EPSG",4326]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Внимание</strong>: замена координатной системы не осуществляет перепроецирования данных и не меняет координаты точек. Она лишь влияет на то, как эти координаты будут интерпретироваться. Если вместо проецирования выполнить замену информации о координатной системе, данные будут позиционироваться в неправильном месте.</p>
</blockquote>
<p>Для проецирования данных в другую систему координат следует использовать функцию <code>st_tranform(x, crs)</code>. Данная функция принимает в качестве параметров класс объектов <em>sf</em> и координатную систему, в которую необходимо проецировать данные.</p>
<div class="cell" data-crop="true">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Проекция Меркатора</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>countries_merc <span class="ot">=</span> <span class="fu">st_transform</span>(countries, <span class="dv">3857</span>)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">16</span>,<span class="dv">2</span>,<span class="dv">16</span>))</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(countries_merc), </span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">'lightgray'</span>,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">lwd =</span> <span class="fl">0.5</span>,</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">graticule =</span> <span class="cn">TRUE</span>, </span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">axes =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-80-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-crop="true">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Проекция Мольвейде (используем dplyr)</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>countries_moll <span class="ot">=</span> countries <span class="sc">|&gt;</span> <span class="fu">st_transform</span>(<span class="st">'+proj=moll'</span>)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(countries_moll), </span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">'lightgray'</span>,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">lwd =</span> <span class="fl">0.5</span>,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">graticule =</span> <span class="cn">TRUE</span>, </span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">axes =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-81-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-crop="true">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Зарубежная Европа в Конической равнопромежуточной проекции. </span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Задаем только необходимые параметры проекции</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>countries_eqdc <span class="ot">=</span> countries <span class="sc">|&gt;</span> </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(continent <span class="sc">==</span> <span class="st">'Europe'</span> <span class="sc">&amp;</span> sovereignt <span class="sc">!=</span> <span class="st">'Russia'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="st">'+proj=eqdc +lon_0=10 +lat_1=30 +lat_2=60 +datum=WGS84 +units=m'</span>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(countries_eqdc), </span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="st">'lightgray'</span>,</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">lwd =</span> <span class="fl">0.5</span>,</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">graticule =</span> <span class="cn">TRUE</span>, </span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">axes =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Работа с проекцией растровых данных также предполагает четыре возможных процедуры: чтение, создание, замена и проецирование:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(dem) <span class="co"># читаем систему координат</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System:</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   User input: WGS 84 </span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   wkt:</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="do">## GEOGCRS["WGS 84",</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="do">##     ENSEMBLE["World Geodetic System 1984 ensemble",</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (Transit)"],</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G730)"],</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G873)"],</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1150)"],</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1674)"],</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1762)"],</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G2139)"],</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="do">##         ELLIPSOID["WGS 84",6378137,298.257223563,</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1]],</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="do">##         ENSEMBLEACCURACY[2.0]],</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a><span class="do">##     PRIMEM["Greenwich",0,</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a><span class="do">##         ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a><span class="do">##     CS[ellipsoidal,2],</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic latitude (Lat)",north,</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[1],</span></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic longitude (Lon)",east,</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[2],</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a><span class="do">##     USAGE[</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a><span class="do">##         SCOPE["Horizontal component of 3D system."],</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a><span class="do">##         AREA["World."],</span></span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a><span class="do">##         BBOX[-90,-180,90,180]],</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a><span class="do">##     ID["EPSG",4326]]</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(dem) <span class="ot">=</span> <span class="cn">NA</span> <span class="co"># очищаем систему координат</span></span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(dem)</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System: NA</span></span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(dem) <span class="ot">=</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>) <span class="co"># создаем систему координат</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(dem)</span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a><span class="do">## Coordinate Reference System:</span></span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a><span class="do">##   User input: EPSG:4326 </span></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a><span class="do">##   wkt:</span></span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a><span class="do">## GEOGCRS["WGS 84",</span></span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a><span class="do">##     ENSEMBLE["World Geodetic System 1984 ensemble",</span></span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (Transit)"],</span></span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G730)"],</span></span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G873)"],</span></span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1150)"],</span></span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1674)"],</span></span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G1762)"],</span></span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a><span class="do">##         MEMBER["World Geodetic System 1984 (G2139)"],</span></span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a><span class="do">##         ELLIPSOID["WGS 84",6378137,298.257223563,</span></span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a><span class="do">##             LENGTHUNIT["metre",1]],</span></span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a><span class="do">##         ENSEMBLEACCURACY[2.0]],</span></span>
<span id="cb83-51"><a href="#cb83-51" aria-hidden="true" tabindex="-1"></a><span class="do">##     PRIMEM["Greenwich",0,</span></span>
<span id="cb83-52"><a href="#cb83-52" aria-hidden="true" tabindex="-1"></a><span class="do">##         ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb83-53"><a href="#cb83-53" aria-hidden="true" tabindex="-1"></a><span class="do">##     CS[ellipsoidal,2],</span></span>
<span id="cb83-54"><a href="#cb83-54" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic latitude (Lat)",north,</span></span>
<span id="cb83-55"><a href="#cb83-55" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[1],</span></span>
<span id="cb83-56"><a href="#cb83-56" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb83-57"><a href="#cb83-57" aria-hidden="true" tabindex="-1"></a><span class="do">##         AXIS["geodetic longitude (Lon)",east,</span></span>
<span id="cb83-58"><a href="#cb83-58" aria-hidden="true" tabindex="-1"></a><span class="do">##             ORDER[2],</span></span>
<span id="cb83-59"><a href="#cb83-59" aria-hidden="true" tabindex="-1"></a><span class="do">##             ANGLEUNIT["degree",0.0174532925199433]],</span></span>
<span id="cb83-60"><a href="#cb83-60" aria-hidden="true" tabindex="-1"></a><span class="do">##     USAGE[</span></span>
<span id="cb83-61"><a href="#cb83-61" aria-hidden="true" tabindex="-1"></a><span class="do">##         SCOPE["Horizontal component of 3D system."],</span></span>
<span id="cb83-62"><a href="#cb83-62" aria-hidden="true" tabindex="-1"></a><span class="do">##         AREA["World."],</span></span>
<span id="cb83-63"><a href="#cb83-63" aria-hidden="true" tabindex="-1"></a><span class="do">##         BBOX[-90,-180,90,180]],</span></span>
<span id="cb83-64"><a href="#cb83-64" aria-hidden="true" tabindex="-1"></a><span class="do">##     ID["EPSG",4326]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Для проецирования растра в новую систему координат необходимо использовать функцию <code>st_warp()</code> Приведем несколько примеров проецирования.</p>
<p>Проекция <em>Меркатора</em>:</p>
<div class="cell" data-crop="true">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>img_merc <span class="ot">=</span> <span class="fu">st_warp</span>(img, <span class="at">crs =</span> <span class="dv">3857</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_rgb</span>(img_merc), <span class="at">main =</span> <span class="cn">NULL</span>, <span class="at">reset =</span> <span class="cn">FALSE</span>)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(countries_merc), </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">border =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">lwd =</span> <span class="fl">0.25</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-84-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Проекция <em>Мольвейде</em>:</p>
<div class="cell" data-crop="true">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>img_moll <span class="ot">=</span> <span class="fu">st_warp</span>(img, <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="st">'+proj=moll'</span>), <span class="at">use_gdal =</span> <span class="cn">TRUE</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_rgb</span>(img_moll, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.99</span>),</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>       <span class="at">stretch =</span> <span class="st">"percent"</span>), <span class="at">main =</span> <span class="cn">NULL</span>, <span class="at">reset =</span> <span class="cn">FALSE</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(countries_moll), </span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">border =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">lwd =</span> <span class="fl">0.5</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-85-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Проекция <em>коническая равнопромежуточная</em>:</p>
<div class="cell" data-crop="true">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>prj <span class="ot">=</span> <span class="st">'+proj=eqdc +lon_0=10 +lat_1=30 +lat_2=60 +datum=WGS84 +units=m'</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>img_eqdc <span class="ot">=</span> <span class="fu">st_warp</span>(</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  img, </span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="fu">st_crs</span>(prj)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>img_eqdc_euro <span class="ot">=</span> img_eqdc[<span class="fu">st_bbox</span>(countries_eqdc)]</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_rgb</span>(img_eqdc_euro), <span class="at">main =</span> <span class="cn">NULL</span>, <span class="at">reset =</span> <span class="cn">FALSE</span>)</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(countries_eqdc), </span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">border =</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.5</span>), <span class="at">lwd =</span> <span class="fl">0.5</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09-SpatialData_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
</div>
</div>
<p>Более подробно вопросы выбора проекций и построения сеток координат рассматриваются в следующей главе.</p>
</section>
</section>
<section id="temporal_review" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="temporal_review"><span class="header-section-number">9.6</span> Краткий обзор</h2>
<p>Для просмотра презентации щелкните на ней один раз левой кнопкой мыши и листайте, используя кнопки на клавиатуре:</p>
<div class="cell">
<iframe src="https://tsamsonov.github.io/r-geo-course-slides/09_SpatialData.html#1" width="100%" height="390px" data-external="1">
</iframe>
</div>
<blockquote class="blockquote">
<p>Презентацию можно открыть в отдельном окне или вкладке браузере. Для этого щелкните по ней правой кнопкой мыши и выберите соответствующую команду.</p>
</blockquote>
</section>
<section id="questions_tasks_spatial" class="level2" data-number="9.7">
<h2 data-number="9.7" class="anchored" data-anchor-id="questions_tasks_spatial"><span class="header-section-number">9.7</span> Контрольные вопросы и упражнения</h2>
<section id="questions_spatial" class="level3" data-number="9.7.1">
<h3 data-number="9.7.1" class="anchored" data-anchor-id="questions_spatial"><span class="header-section-number">9.7.1</span> Вопросы</h3>
<ol type="1">
<li>Что такое пространственные данные и какие модели пространственных данных существуют?</li>
<li>Назовите номер стандарта ISO, в котором описана модель <em>Simple Features</em>.</li>
<li>Перечислите основные принципы представления объектов в рамках стандарта <em>Simple Features</em>.</li>
<li>Какие размерности координат допустимы в объектах <em>Simple Features</em>?</li>
<li>Перечислите основные 7 типов геометрий. Сколько всего их описано в стандарте <em>Simple Features</em>?</li>
<li>Как называются основные два формата представления объектов <em>Simple Features</em>?</li>
<li>Перечислите основные компоненты пространственной привязки.</li>
<li>Перечислите основные форматы описания пространственной привязки.</li>
<li>Дайте расшифровку основных параметров строки <em>PROJ.4</em>.</li>
<li>Какой номер <em>EPSG</em> имеет географическая система координат <em>WGS84</em>?</li>
<li>В чем отличие трансформирования координат и проецирования?</li>
<li>Какие три программных библиотеки составляют основу функциональности пакета <strong>sf</strong>? Каково их назначение?</li>
<li>В чем отличие объектов типа <strong>sp</strong> от <strong>sf</strong>?</li>
<li>Что означает префикс <code>st_</code>, используемый в названиях функций пакета <strong>sf</strong>?</li>
<li>Какая функция используется для чтения данных средствами пакета <strong>sf</strong>?</li>
<li>Перечислите три класса, слагающих иерархию представления пространственных объектов, реализуемую пакетом <strong>sf</strong>.</li>
<li>Какой тип данных имеет колонка с геометрией объекта <strong>sf</strong>?</li>
<li>Какая функция позволяет извлечь геометрическую колонку из объекта <strong>sf</strong>?</li>
<li>С помощью какой структуры данных фактически реализован класс объектов <strong>sfg</strong>?</li>
<li>Сколько карт будет построено функцией <code>plot()</code> применительно к объекту <strong>sf</strong>?</li>
<li>Как с помощью функции <code>plot()</code> нарисовать только геометрию объектов, не отображая атрибутивные характеристики?</li>
<li>Какой параметр функции <code>plot()</code> отвечает за отображение/не отображение градусной сетки координат?</li>
<li>Каким способом можно узнать и задать систему координат объекта <strong>sf</strong>?</li>
<li>Какая функция позволяет осуществить проецирование данных?</li>
<li>Можно ли применять к объектам типа <strong>sf</strong> стандартные манипуляции <strong>dplyr</strong>?</li>
<li>Что произойдет с геометрией пространственных объектов при выполнении агрегирования данных по группам значений заданных атрибутов?</li>
<li>Перечислите функции, с помощью которых создаются объекты типа <strong>sfg</strong>, и структуры данных с координатами, которые должны быть поданы на вход этих функций.</li>
<li>Назовите три правила, которым подчиняется формат представления координат вершин <em>полигональных</em> объектов.</li>
<li>Может ли обычный полигон <strong>sf</strong> содержать дырку, или же для этого требуется создание мультиполигона?</li>
<li>Как можно быстро собрать слой точечных объектов по их координатам, не собирая объекты вручную?</li>
<li>Какая функция позволяет осуществлять преобразование типа геометрии <strong>sf</strong>?</li>
<li>Перечислите требования, которым должно удовлетворять множество линейных объектов для того, чтобы к нему была применима операция полигонизации?</li>
<li>Назовите функции <strong>sf</strong>, реализующие операцию добавления вершин в точках пересечения линий и операцию полигонизации линий.</li>
<li>Перечислите названия функций <strong>sf</strong>, позволяющих получать ограничивающий прямоугольник, периметр, площадь, центроид, характерную точку и координаты объекта.</li>
<li>С помощью какой функции осуществляется запись (экспорт) <strong>sf</strong> в файлы пространственных данных?</li>
<li>Назовите основные параметры, определяющие геометрию растра.</li>
<li>Какие пакеты отвечают за поддержку растровых данных в <strong>R</strong>?</li>
<li>Как можно прочитать одноканальный и многоканальный растры в <strong>R</strong>?</li>
<li>Какие функции можно использовать для визуализации одноканальных и многоканальных растров?</li>
<li>Можно ли совмещать растровые и векторные слои на одном изображении? Если да, то как эта возможность реализуется?</li>
<li>Каким образом можно узнать и задать пространственную привязку растрового набора данных?</li>
<li>Какая функция отвечает за проецирование растровых данных? Перечислите ее параметры и их назначение.</li>
<li>Объясните систему индексирования объектов типа <strong>stars</strong>.</li>
<li>Как вычислить новую переменную объекта типа <strong>stars</strong>?</li>
<li>Как осуществить экспорт растра в файл?</li>
</ol>
</section>
<section id="tasks_spatial" class="level3" data-number="9.7.2">
<h3 data-number="9.7.2" class="anchored" data-anchor-id="tasks_spatial"><span class="header-section-number">9.7.2</span> Упражнения</h3>
<ol type="1">
<li><p>Преобразуйте точки землетрясений из набора данных <em>quakes</em> в пространственные объекты и отобразите их сначала средствами стандартной графической подсистемы, а затем на интерактивной карте средствами пакета <strong>mapview</strong>. Передайте магнитуду землетрясения в параметр <code>zcol</code> функции <code>mapview()</code>, чтобы дифференцировать точки цветом по этому параметру.</p></li>
<li><p>Таблица <em>storms</em> из пакета <strong>dplyr</strong> содержит данные трекинга тропических циклонов c 1975 по 2015 год. Выберите любой циклон и постройте для него линию трека прохождения и точки прохождения. Отобразите эти данные средствами стандартной графической подсистемы, а затем на интерактивной карте средствами <strong>mapview</strong>. Напишите программу таким образом, чтобы можно было выбирать имя циклона и программа отображала его трек на интерактивной карте.</p></li>
<li><p>Скачайте <a href="https://github.com/tsamsonov/r-geo-course/blob/master/data/Satino.gpkg">базу данных</a> и <a href="https://github.com/tsamsonov/r-geo-course/blob/master/data/Satino_DEM.zip">цифровую модель рельефа</a> на территорию Сатинского полигона МГУ. Изучите содержимое базы данных и постройте на основе этих данных общегеографическую карту средствами стандартной графической подсистемы.</p></li>
</ol>
<table class="table">
<tbody>
<tr class="odd">
<td><em>Самсонов Т.Е.</em> <strong>Визуализация и анализ географических данных на языке R.</strong> М.: Географический факультет МГУ, 2023. DOI: <a href="https://doi.org/10.5281/zenodo.901911">10.5281/zenodo.901911</a></td>
</tr>
</tbody>
</table>


</section>
</section>
<aside id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>ГОСТ Р 52438-2005 &lt;&lt;Географические информационные системы. Термины и определения&gt;&gt;. В стандарте поясняется, что объектом может быть неподвижный или движущийся простой или сложный объект, явление, событие, процесс и ситуация. Моделируемый объект может относиться к территории, акватории, недрам и воздушному пространству Земли, околоземному космическому пространству, другим космическим телам и небесной сфере. В широком смысле под пространственным объектом в геоинформатике понимается как сам объект, так и адекватная ему цифровая модель<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Например, в широко распространенном формате <strong>Esri Shapefile</strong> атрибутивная таблица хранится в файле <code>*.dbf</code> формата <em>DBASE</em>, геометрия хранится в отдельном файле <code>*.shp</code>, а связь между ними осуществляется через файл <code>*.shx</code>. Разбиение формата хранения на несколько файлов — это одна из уязвимостей шейп-файлов: при отсутствии хотя бы одного из этих файлов данные прочесть стандартными средствами (без дополнительного хакинга) будет нельзя.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Названия перечисленных компонент геометрии растра укоренились благодаря распространенности стандарта <a href="https://en.wikipedia.org/wiki/Esri_grid">Esri ASCII Grid</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</aside>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./08-AdvStats.html" class="pagination-link  aria-label=" &lt;span="" ряды&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Временные ряды</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./10-Maps.html" class="pagination-link" aria-label="<span class='chapter-number'>10</span>&nbsp; <span class='chapter-title'>Основы картографии</span>">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Основы картографии</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>