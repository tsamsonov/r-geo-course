<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.510">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Визуализация и анализ географических данных на языке R - 4&nbsp; Функции</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05-BaseGraphics.html" rel="next">
<link href="./03-Tables.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01-Basics.html">Основы</a></li><li class="breadcrumb-item"><a href="./04-Functions.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Функции</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Визуализация и анализ географических данных на языке R</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Введение</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Основы</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-Basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Типы данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-DataStructures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Структуры данных</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-Tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Таблицы</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-Functions.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Функции</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Графика и статистика</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-BaseGraphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Базовая графика</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-AdvGraphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Продвинутая графика</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-BaseStats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Основы статистики</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-AdvStats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Временные ряды</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Пространственные данные и карты</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-SpatialData.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Пространственные данные</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-Maps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Основы картографии</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-ThematicMaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Тематические карты</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-3DModels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Трехмерные модели</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Пространственный анализ</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-VectorAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Векторный анализ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-RasterAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Растровый анализ</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-Interpolation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Интерполяция геополей</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-NetworkAnalysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Сетевой анализ</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Библиография</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#tech-fun-functions" id="toc-tech-fun-functions" class="nav-link active" data-scroll-target="#tech-fun-functions"><span class="header-section-number">4.1</span> Функции</a></li>
  <li><a href="#tech-fun-functionals" id="toc-tech-fun-functionals" class="nav-link" data-scroll-target="#tech-fun-functionals"><span class="header-section-number">4.2</span> Функционалы</a>
  <ul class="collapse">
  <li><a href="#tech-fun-functionals-base" id="toc-tech-fun-functionals-base" class="nav-link" data-scroll-target="#tech-fun-functionals-base"><span class="header-section-number">4.2.1</span> Базовые функционалы</a></li>
  <li><a href="#tech-fun-functionals-purrr" id="toc-tech-fun-functionals-purrr" class="nav-link" data-scroll-target="#tech-fun-functionals-purrr"><span class="header-section-number">4.2.2</span> Функционалы <code>purrr</code></a></li>
  </ul></li>
  <li><a href="#tech-meta" id="toc-tech-meta" class="nav-link" data-scroll-target="#tech-meta"><span class="header-section-number">4.3</span> Квотация аргументов</a></li>
  <li><a href="#tech_review" id="toc-tech_review" class="nav-link" data-scroll-target="#tech_review"><span class="header-section-number">4.4</span> Краткий обзор</a></li>
  <li><a href="#tech_questions" id="toc-tech_questions" class="nav-link" data-scroll-target="#tech_questions"><span class="header-section-number">4.5</span> Контрольные вопросы и упражнения</a>
  <ul class="collapse">
  <li><a href="#tech_questions_questions" id="toc-tech_questions_questions" class="nav-link" data-scroll-target="#tech_questions_questions"><span class="header-section-number">4.5.1</span> Вопросы</a></li>
  <li><a href="#tech_questions_tasks" id="toc-tech_questions_tasks" class="nav-link" data-scroll-target="#tech_questions_tasks"><span class="header-section-number">4.5.2</span> Упражнения</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./01-Basics.html">Основы</a></li><li class="breadcrumb-item"><a href="./04-Functions.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Функции</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="controls" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Функции</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>В настоящей главе мы кратко познакомимся с функциональным программированием и метапрограммированием, которые являются одними из основных техник программирования на R.</p>
<section id="tech-fun-functions" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="tech-fun-functions"><span class="header-section-number">4.1</span> Функции</h2>
<p>Функции в R можно использовать для структурирования кода на логически завершенные, автономные фрагменты кода, каждый из которых выполняет конкретную задачу. Синтаксис функции выглядит следующим образом:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>functionName <span class="ot">=</span> <span class="cf">function</span>(parameter1, parameter2, ...){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  last_value <span class="ot">=</span> ...</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Функция создается c помощью ключевого слова <code>function</code>, за которым в круглых скобках заключается произвольное количество параметров (столько, сколько вам нужно: от нуля и более). С помощью этих параметров вы сможете передавать внутрь функции значения переменных. Созданной функции необходимо дать имя, используя оператор присвоения <code>&lt;-</code> или <code>=</code>.</p>
<p>Возврат значения функции осуществляется двумя способами:</p>
<ul>
<li><p>Если не указано иное, то будет возвращен результат вычисления последнего выражения, выполненного внутри функции (<code>last_value</code> в примере выше)</p></li>
<li><p>Результат можно вернуть принудительно в любом месте функции, передав его в выражение <code>return()</code>.</p></li>
</ul>
<blockquote class="blockquote">
<p>Выражение <code>return()</code> работает аналогично ключевому слову <code>break</code> в циклах: оно прерывает выполнение функции и осуществляет выход из нее. Как правило, return() используется, если возврат значения надо сделать где-то посередине или в начале функции. Однако я реккомендую использовать его всегда, поскольку это помогает читателю вашей функции быстро определить, что же именно возвращается из функции</p>
</blockquote>
<p>Как правило, функции оказываются полезны, если:</p>
<ul>
<li>Вы дублируете один и тот же код в разных частях программы</li>
<li>Ваш код становится слишком длинным, при этом присутствует очевидная этапность решения задачи, позволяющая разбить программу на автономные блоки</li>
<li>У вас есть фрагмент кода, который выполняет вспомогательную (второстепенную функцию), и не относится непосредственно к основной логике программы.</li>
</ul>
<p>Предположим, у нас есть линия, заданная координатами четырех точек, и нам надо вычислить длины каждого из трех отрезков. Без использования функции мы запишем это так:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">4</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">4</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>d12 <span class="ot">=</span> <span class="fu">sqrt</span>((x[<span class="dv">1</span>] <span class="sc">-</span> x[<span class="dv">2</span>]) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> (y[<span class="dv">1</span>] <span class="sc">-</span> y[<span class="dv">2</span>]) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>d23 <span class="ot">=</span> <span class="fu">sqrt</span>((x[<span class="dv">2</span>] <span class="sc">-</span> x[<span class="dv">3</span>]) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> (y[<span class="dv">2</span>] <span class="sc">-</span> y[<span class="dv">3</span>]) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>d31 <span class="ot">=</span> <span class="fu">sqrt</span>((x[<span class="dv">3</span>] <span class="sc">-</span> x[<span class="dv">4</span>]) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> (y[<span class="dv">3</span>] <span class="sc">-</span> y[<span class="dv">4</span>]) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(d12, d23, d31)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.78599 1.780432 2.739223</code></pre>
</div>
</div>
<p>В правой части этих выражений стоит один и тот же код, который я скопировал и вставил, а далее заменил названия переменных. Это плохо сразу по двум причинам: дублирование фрагментов программы и возрастание вероятности опечаток в скопированой копии. Улучшить код можно, введя функцию вычисления расстояний:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>distance <span class="ot">=</span> <span class="cf">function</span>(x1, y1, x2, y2) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>((x1 <span class="sc">-</span> x2) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">+</span> (y1 <span class="sc">-</span> y2) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>d12 <span class="ot">=</span> <span class="fu">distance</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>], x[<span class="dv">2</span>], y[<span class="dv">2</span>])</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>d23 <span class="ot">=</span> <span class="fu">distance</span>(x[<span class="dv">2</span>], y[<span class="dv">2</span>], x[<span class="dv">3</span>], y[<span class="dv">3</span>])</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>d31 <span class="ot">=</span> <span class="fu">distance</span>(x[<span class="dv">3</span>], y[<span class="dv">3</span>], x[<span class="dv">4</span>], y[<span class="dv">4</span>])</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(d12, d23, d31)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1.78599 1.780432 2.739223</code></pre>
</div>
</div>
<p>Функция всегда возвращает один объект: значение, вектор, список и т.д. Например, мы можем сделать функцию следующего уровня, рассчитывающая сразу все расстояния для множества точек:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>distances <span class="ot">=</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> <span class="fu">length</span>(x)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distance</span>(x[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)], y[<span class="dv">1</span><span class="sc">:</span>(n<span class="dv">-1</span>)], x[<span class="dv">2</span><span class="sc">:</span>n], y[<span class="dv">2</span><span class="sc">:</span>n])</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">distances</span>(x, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1.785990 1.780432 2.739223</code></pre>
</div>
</div>
<p>Можно пойти еще дальше, и сделать функцию, выполняющую вычисление длины линии, заданной координатами:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>line_length <span class="ot">=</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(<span class="fu">distances</span>(x, y))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">line_length</span>(x, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.305645</code></pre>
</div>
</div>
<p>Обратите внимание на то, как мы используем одну ранее написанную функцию при создании другой функции! Это весьма распространенная практика: одна и та же функция может быть как самостоятельно полезной (вызываться непосредственно в программе полтьзователя), так и применяться для решения задач внутри других функций. При этом иногда даже относительно простые фрагменты кода имеет смысл оформлять в виде функций, так как это может улучшить читаемость программы и пояснить смысл выполняемых операций. Так, например, <code>line_length(x, y)</code> в более явном виде обозначает операцию вычисления длины по координатам, нежели <code>sum(distances(x, y))</code>. В то же время, здесь важно не переусердствовать и оформлять короткие фрагменты кода в виде функций только если они будут применяться вами неоднократно.</p>
<p>Если вам нужно вернуть из функции несколько объектов, имеющих разный тип или смысл, заключите их в список и дайте каждому элементу списка “говорящее” имя. Например, помимо периметра, мы можем вернуть также извилистость линии (отношение длины линии к длине отрезка, соединяющего ее первую и последнюю точку):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>line_params <span class="ot">=</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">=</span> <span class="fu">length</span>(x)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  l <span class="ot">=</span> <span class="fu">line_length</span>(x, y)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">=</span> l <span class="sc">/</span> <span class="fu">distance</span>(x[<span class="dv">1</span>], y[<span class="dv">1</span>], x[n], y[n]) </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">length =</span> l, <span class="at">sinuosity =</span> s)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">line_params</span>(x, y)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>result<span class="sc">$</span>length</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.305645</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>result<span class="sc">$</span>sinuosity</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4.907202</code></pre>
</div>
</div>
</section>
<section id="tech-fun-functionals" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="tech-fun-functionals"><span class="header-section-number">4.2</span> Функционалы</h2>
<section id="tech-fun-functionals-base" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="tech-fun-functionals-base"><span class="header-section-number">4.2.1</span> Базовые функционалы</h3>
<p>Данные (в том числе географические) практически всегда носят множественный характер и организованы в определенные структуры (см. главу 2). Эта особенность данных выдвигает логичное желание иметь процедуры, которые можно применять к полному набору данных, а не к его отдельным компонентам. Это и есть процедуры векторизованных вычислений.</p>
<p>Предположим, вам необходимо что-то вычислить для каждой строки таблицы, при этом порядок вычисления зависит от содержимого ячеек данной строки. Вы можете организовать подобные вычисления с помощью циклов, однако в <strong>R</strong> существуют специальные функции семейста <code>apply</code>, которые позволяют решать подобные задачи более элегантно и с высокой скоростью:</p>
<table class="table">
<colgroup>
<col style="width: 26%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th>Функция</th>
<th>Назначение</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>apply()</code></td>
<td>применить функцию ко всем строкам или столбцам матрицы</td>
</tr>
<tr class="even">
<td><code>lapply()</code></td>
<td>применить функцию к каждому компоненту вектора или списка и получить результат также в виде списка (<em>l — list</em>)</td>
</tr>
<tr class="odd">
<td><code>sapply()</code></td>
<td>применить функцию к каждому компоненту вектора или списка и получить результат в виде вектора (<em>s — simplify</em>)</td>
</tr>
<tr class="even">
<td><code>vapply()</code></td>
<td>аналогична <code>sapply()</code>, но требует явного задания типа данных возвращаемого вектора, за счет чего работает быстрее (<em>v — velocity</em>)</td>
</tr>
<tr class="odd">
<td><code>mapply()</code></td>
<td>применить функцию к каждому компоненту нескольких векторов или списков и вернуть результат в виде списка (<em>m — multivariate</em>)</td>
</tr>
<tr class="even">
<td><code>rapply()</code></td>
<td>применить функцию рекурсивно ко всем элементам переданного списка и вернуть результат в аналогичной структур (<em>r — recursive</em>)</td>
</tr>
<tr class="odd">
<td><code>tapply()</code></td>
<td>применить функцию ко всем компонентам вектора или списка, сгруппировав их по значению переданного фактора</td>
</tr>
</tbody>
</table>
<blockquote class="blockquote">
<p>Функции семейства <code>apply</code>, принимающие на вход списки, могут работать и с фреймами данных. В этом случае фрейм внутри функции будет преобразован с помощью функции <code>as.list()</code> в список, элементами которого являются столбцы (переменные) входного фрейма данных. Данные при этом не потеряются, их типы тоже не изменятся.</p>
</blockquote>
<p>Базовая функция <code>apply()</code> имеет следующие аргументы:</p>
<ul>
<li><code>X</code> — массив любой размерности (включая вектор)</li>
<li><code>MARGIN</code> — измерения по которым необходимо вести вычисления. Для матрицы <code>1</code> означает строку, <code>2</code> означает столбец, <code>c(1, 2)</code> будет означать, что вычисления производятся по всем комбинациям строк и столбцов</li>
<li><code>FUN</code> — функция, которая будет применяться к каждому элементу указанных измерений</li>
<li><code>...</code> — список аргументов, которые надо передать в функцию <code>FUN</code> (в этом случае массив должен передаваться обязательно в первый аргумент)</li>
</ul>
<p>Другие функции семейства <code>apply</code> в приложении к фреймам данных будут работать со столбцами (переменными), интерпретируя их как элементы списка. Наиболее часто из них используются <code>lapply()</code>, <code>sapply()</code> и <code>vapply()</code>. В отличие от <code>apply()</code>, они уже не принимаеют номера измерений и работают только с элементами переданного списка.</p>
<p>Рассмотрим применение функций данного семейства на примере анализа основных социально-экономических характеристик столиц субъектов Северо-Западного округа за 2015 год:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>(<span class="at">df =</span> <span class="fu">read_excel</span>(<span class="st">"data/sevzap.xlsx"</span>, <span class="at">col_types =</span> <span class="fu">c</span>(<span class="st">'text'</span>, <span class="fu">rep</span>(<span class="st">'numeric'</span>, <span class="dv">17</span>))))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 10 × 18</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="do">##    city     pop birth death  labor salary livspace doctors  hosp assets business</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="do">##    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  1 Петр…  277.   13    12.3   72.3 36268.     24.4    75      17 2.47e5    15856</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  2 Сыкт…  259.   14.5  10.4   84.1 39790      22.8    79.5    17 2.17e5    10068</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  3 Арха…  358.   11.8  11.6   97.9 40303.     22.7    82.3    19 2.79e5    13016</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  4 Нарь…   24.5  18.1   7.6   12.7 69884.     23.6    65.2     2 1.05e5      704</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="do">##  5 Воло…  313.   16.2  11.4   91   31483      24.7    60.9    18 8.27e5    21931</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  6 Кали…  460.   13.3  13.4  126.  34142      27.7    69.8    25 3.27e5    38013</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="do">##  7 Мурм…  302.   12.4  11.9   96.9 53240.     23.8    68.8    15 7.24e5    16041</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="do">##  8 Вели…  222.   13.8  13.8   74.1 32377.     24.1    78.9    14 1.59e5     9583</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="do">##  9 Псков  208.   13.2  13.7   59.6 27405.     25      59      13 1.31e5     8752</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 10 Санк… 5226.   13.6  11.9 2055.  44187      23.6    73.8   112 4.10e6   374999</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="do">## # ℹ 7 more variables: minerals &lt;dbl&gt;, manufact &lt;dbl&gt;, engaswat &lt;dbl&gt;,</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="do">## #   construct &lt;dbl&gt;, apart &lt;dbl&gt;, retail &lt;dbl&gt;, invest &lt;dbl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>В данной таблице каждый столбец представляет независимую переменную со своими единицами измерения, поэтому ее необходимо оставить в “широкой” форме, не преобразуя в длинную. Используя <code>apply</code>, можно быстро получить максимальные значения каждой переменной:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(df[<span class="sc">-</span><span class="dv">1</span>], <span class="dv">2</span>, max)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      pop     birth     death     labor    salary  livspace   doctors      hosp 
   5225.7      18.1      13.8    2055.3   69883.5      27.7      82.3     112.0 
   assets  business  minerals  manufact  engaswat construct     apart    retail 
4102243.8  374999.0        NA 1978634.0  173292.0  397229.0    3031.0 1144607.0 
   invest 
 521293.0 </code></pre>
</div>
</div>
<p>Что равносильно вызову sapply:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(df[<span class="sc">-</span><span class="dv">1</span>], max)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      pop     birth     death     labor    salary  livspace   doctors      hosp 
   5225.7      18.1      13.8    2055.3   69883.5      27.7      82.3     112.0 
   assets  business  minerals  manufact  engaswat construct     apart    retail 
4102243.8  374999.0        NA 1978634.0  173292.0  397229.0    3031.0 1144607.0 
   invest 
 521293.0 </code></pre>
</div>
</div>
<p>В качестве функции можно использовать не только стандартные, но и пользовательские функции. Например, нам может быть интересно не максимальное значение показателя, а его отношение к среднему значению среди всех городов. Здесь уже одной функцией не обойдешься, так как нужно каждый столбец поделить на среднее значение по нему. Для этого определим небольшую пользовательскую функцию непосредственно при вызове <code>sapply()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">normalized =</span> <span class="fu">sapply</span>(df[<span class="sc">-</span><span class="dv">1</span>], <span class="cf">function</span>(X) { <span class="fu">round</span>(X <span class="sc">/</span> <span class="fu">mean</span>(X, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>) }))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       pop birth death labor salary livspace doctors hosp assets business
 [1,] 0.36  0.93  1.04  0.26   0.89     1.01    1.05 0.67   0.35     0.31
 [2,] 0.34  1.04  0.88  0.30   0.97     0.94    1.11 0.67   0.30     0.20
 [3,] 0.47  0.84  0.98  0.35   0.99     0.94    1.15 0.75   0.39     0.26
 [4,] 0.03  1.29  0.64  0.05   1.71     0.97    0.91 0.08   0.15     0.01
 [5,] 0.41  1.16  0.97  0.33   0.77     1.02    0.85 0.71   1.16     0.43
 [6,] 0.60  0.95  1.14  0.46   0.83     1.14    0.98 0.99   0.46     0.75
 [7,] 0.39  0.89  1.01  0.35   1.30     0.98    0.96 0.60   1.02     0.32
 [8,] 0.29  0.99  1.17  0.27   0.79     0.99    1.11 0.56   0.22     0.19
 [9,] 0.27  0.94  1.16  0.22   0.67     1.03    0.83 0.52   0.18     0.17
[10,] 6.83  0.97  1.01  7.42   1.08     0.97    1.03 4.44   5.76     7.37
      minerals manufact engaswat construct apart retail invest
 [1,]     0.06     0.05     0.52      0.13  0.45   0.23   0.11
 [2,]     0.00     0.28     0.43      0.09  0.31   0.21   0.14
 [3,]     0.00     0.06     0.49      0.09  0.17   0.17   0.15
 [4,]     4.12     0.05     0.03      0.08  0.05   0.02   0.52
 [5,]       NA     0.15     0.63      0.09  0.52   0.23   0.13
 [6,]     0.82     0.83     0.68      0.28  1.24   0.38   0.53
 [7,]       NA     0.23     0.42      0.07  0.02   0.29   0.75
 [8,]       NA     0.42     0.45      0.08  0.32   0.17   0.30
 [9,]       NA     0.08     0.22      0.04  0.27   0.17   0.10
[10,]     1.00     7.87     6.13      9.05  6.65   8.13   7.28</code></pre>
</div>
</div>
<p>Полученный объект является матрицей. Таким образом, можно видеть, что функционалы бывают полезны не только для агрегирования таблиц, но и для преобразования данных, когда структура таблицы остается прежней.</p>
<p>В приведенном выше коде мы сознательно исключили первый столбец, поскольку он является текстовым. Можно сделать более мощную и универсальную функцию, которая будет нормировать все числовые столбцы таблицы, а текстовые оставлять в оригинале. Для этого проверку типа данных надо внести внутрь функции. Поскольку код функции при этом вырастает, целесообразно определить ее заранее. Поскольку в этом случае часть векторов будет символьной, а не числовой, необходимо применять функцию <code>lapply()</code>, которая вернет список из векторов, а не матрицу и таким образом сохранит типы каждого столбца:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>normalize <span class="ot">=</span> <span class="cf">function</span>(X) {</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.numeric</span>(X)) </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(X <span class="sc">/</span> <span class="fu">mean</span>(X, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>) </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> X</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>(<span class="at">normalized_df =</span> df <span class="sc">|&gt;</span> <span class="fu">lapply</span>(normalize) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 18
   city      pop birth death labor salary livspace doctors  hosp assets business
   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
 1 Петроз…  0.36  0.93  1.04  0.26   0.89     1.01    1.05  0.67   0.35     0.31
 2 Сыктыв…  0.34  1.04  0.88  0.3    0.97     0.94    1.11  0.67   0.3      0.2 
 3 Арханг…  0.47  0.84  0.98  0.35   0.99     0.94    1.15  0.75   0.39     0.26
 4 Нарьян…  0.03  1.29  0.64  0.05   1.71     0.97    0.91  0.08   0.15     0.01
 5 Вологда  0.41  1.16  0.97  0.33   0.77     1.02    0.85  0.71   1.16     0.43
 6 Калини…  0.6   0.95  1.14  0.46   0.83     1.14    0.98  0.99   0.46     0.75
 7 Мурман…  0.39  0.89  1.01  0.35   1.3      0.98    0.96  0.6    1.02     0.32
 8 Велики…  0.29  0.99  1.17  0.27   0.79     0.99    1.11  0.56   0.22     0.19
 9 Псков    0.27  0.94  1.16  0.22   0.67     1.03    0.83  0.52   0.18     0.17
10 Санкт-…  6.83  0.97  1.01  7.42   1.08     0.97    1.03  4.44   5.76     7.37
# ℹ 7 more variables: minerals &lt;dbl&gt;, manufact &lt;dbl&gt;, engaswat &lt;dbl&gt;,
#   construct &lt;dbl&gt;, apart &lt;dbl&gt;, retail &lt;dbl&gt;, invest &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="tech-fun-functionals-purrr" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="tech-fun-functionals-purrr"><span class="header-section-number">4.2.2</span> Функционалы <code>purrr</code></h3>
<p>В качестве альтернативы функциям <code>apply</code> можно также воспользоваться вычислениями посредством функций семейства <code>map</code> из пакета <code>purrr</code> (еще один пакет из <a href="https://www.tidyverse.org/packages/">tidyverse</a>). Эти функции работают аналогично, но их разнообразие довольно велико. Например, часто используюбся следующие:</p>
<table class="table">
<thead>
<tr class="header">
<th>Функция</th>
<th>Тип возвращаемого значения</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>map()</code></td>
<td>список</td>
</tr>
<tr class="even">
<td><code>map_lgl()</code></td>
<td>вектор <code>logical</code></td>
</tr>
<tr class="odd">
<td><code>map_int()</code></td>
<td>вектор <code>integer</code></td>
</tr>
<tr class="even">
<td><code>map_dbl()</code></td>
<td>вектор <code>double</code></td>
</tr>
<tr class="odd">
<td><code>map_chr()</code></td>
<td>вектор <code>character</code></td>
</tr>
</tbody>
</table>
<p>Основные отличия от базовых функций следующие:</p>
<ul>
<li><p>явное указание типа возвращаемого значения (<code>apply</code> могут быть непредсказуемы);</p></li>
<li><p>данные всегда идут первым аргументом (это условие не выполняется для <code>mapply</code>).</p></li>
<li><p>поддерживается большое разнообразие сочетаний входных и выходных параметров, в том числе итерации по нескольким векторам одновременно.</p></li>
</ul>
<p>Вышеприведенные операции можно осуществить средствами <strong>purrr</strong> вот так:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(df[<span class="sc">-</span><span class="dv">1</span>], max)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      pop     birth     death     labor    salary  livspace   doctors      hosp 
   5225.7      18.1      13.8    2055.3   69883.5      27.7      82.3     112.0 
   assets  business  minerals  manufact  engaswat construct     apart    retail 
4102243.8  374999.0        NA 1978634.0  173292.0  397229.0    3031.0 1144607.0 
   invest 
 521293.0 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">map</span>(normalize) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 18
   city      pop birth death labor salary livspace doctors  hosp assets business
   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
 1 Петроз…  0.36  0.93  1.04  0.26   0.89     1.01    1.05  0.67   0.35     0.31
 2 Сыктыв…  0.34  1.04  0.88  0.3    0.97     0.94    1.11  0.67   0.3      0.2 
 3 Арханг…  0.47  0.84  0.98  0.35   0.99     0.94    1.15  0.75   0.39     0.26
 4 Нарьян…  0.03  1.29  0.64  0.05   1.71     0.97    0.91  0.08   0.15     0.01
 5 Вологда  0.41  1.16  0.97  0.33   0.77     1.02    0.85  0.71   1.16     0.43
 6 Калини…  0.6   0.95  1.14  0.46   0.83     1.14    0.98  0.99   0.46     0.75
 7 Мурман…  0.39  0.89  1.01  0.35   1.3      0.98    0.96  0.6    1.02     0.32
 8 Велики…  0.29  0.99  1.17  0.27   0.79     0.99    1.11  0.56   0.22     0.19
 9 Псков    0.27  0.94  1.16  0.22   0.67     1.03    0.83  0.52   0.18     0.17
10 Санкт-…  6.83  0.97  1.01  7.42   1.08     0.97    1.03  4.44   5.76     7.37
# ℹ 7 more variables: minerals &lt;dbl&gt;, manufact &lt;dbl&gt;, engaswat &lt;dbl&gt;,
#   construct &lt;dbl&gt;, apart &lt;dbl&gt;, retail &lt;dbl&gt;, invest &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Однако <strong>purrr</strong> позволяет выполнять функции не ко всем элементам, а только к тем, которые удовлетворяют заданным условиям. Если задачу нормировки необходимо решить один раз, то можно не создавать новую функцию, а выполнить нормировку по условию непосредственно при вызове функционала:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">map_if</span>(is.numeric, \(X) <span class="fu">round</span>(X <span class="sc">/</span> <span class="fu">mean</span>(X, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">2</span>)) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 18
   city      pop birth death labor salary livspace doctors  hosp assets business
   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
 1 Петроз…  0.36  0.93  1.04  0.26   0.89     1.01    1.05  0.67   0.35     0.31
 2 Сыктыв…  0.34  1.04  0.88  0.3    0.97     0.94    1.11  0.67   0.3      0.2 
 3 Арханг…  0.47  0.84  0.98  0.35   0.99     0.94    1.15  0.75   0.39     0.26
 4 Нарьян…  0.03  1.29  0.64  0.05   1.71     0.97    0.91  0.08   0.15     0.01
 5 Вологда  0.41  1.16  0.97  0.33   0.77     1.02    0.85  0.71   1.16     0.43
 6 Калини…  0.6   0.95  1.14  0.46   0.83     1.14    0.98  0.99   0.46     0.75
 7 Мурман…  0.39  0.89  1.01  0.35   1.3      0.98    0.96  0.6    1.02     0.32
 8 Велики…  0.29  0.99  1.17  0.27   0.79     0.99    1.11  0.56   0.22     0.19
 9 Псков    0.27  0.94  1.16  0.22   0.67     1.03    0.83  0.52   0.18     0.17
10 Санкт-…  6.83  0.97  1.01  7.42   1.08     0.97    1.03  4.44   5.76     7.37
# ℹ 7 more variables: minerals &lt;dbl&gt;, manufact &lt;dbl&gt;, engaswat &lt;dbl&gt;,
#   construct &lt;dbl&gt;, apart &lt;dbl&gt;, retail &lt;dbl&gt;, invest &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Распространенный сценарий, который более удобно реализуется в <strong>purrr</strong> по сравнению с базовым R — это итерации по множеству аргументов. Например, неоходимо сгенерировать несколько популяций из <span class="math inline">\(7\)</span> случайных глубин, имеющих равномерное распределение в заданных интервалах от <span class="math inline">\([-10, -6]\)</span> до <span class="math inline">\([-5, -1]\)</span>. В базовом R для этого мы использовали бы <code>mapply()</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2020</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>zmin <span class="ot">=</span> <span class="sc">-</span><span class="dv">10</span><span class="sc">:-</span><span class="dv">6</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>zmax <span class="ot">=</span> <span class="sc">-</span><span class="dv">5</span><span class="sc">:-</span><span class="dv">1</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>depths <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  runif, <span class="at">min =</span> zmin, <span class="at">max =</span> zmax, </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">n =</span> <span class="dv">7</span>), <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(depths)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ : num [1:7] -6.77 -8.03 -6.91 -7.62 -9.32 ...
 $ : num [1:7] -7.03 -8.99 -5.9 -5.18 -5.28 ...
 $ : num [1:7] -5.95 -5.3 -3.2 -4.73 -5.27 ...
 $ : num [1:7] -6.61 -2.91 -2.29 -2.58 -6.17 ...
 $ : num [1:7] -3.75 -3.22 -1.18 -5.64 -1.22 ...</code></pre>
</div>
</div>
<p>При этом обратим внимание на то, что аргументы, по которым не делаются итерации, выносятся в <code>MoreArgs</code>, а чтобы получить на выходе список, а не матрицу, мы применяем <code>SIMPLIFY = FALSE</code>.</p>
<p>При использовании <code>map2</code> задача решается одним простым выражением:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>depths <span class="ot">&lt;-</span> <span class="fu">map2</span>(zmin, zmax, runif, <span class="at">n =</span> <span class="dv">7</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(depths)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ : num [1:7] -8.16 -9.94 -5.33 -7.38 -8.89 ...
 $ : num [1:7] -4.68 -4.58 -5.88 -6.14 -6.65 ...
 $ : num [1:7] -7.17 -5.11 -6.56 -3.49 -5.39 ...
 $ : num [1:7] -4.79 -5.88 -4.28 -4.57 -5.96 ...
 $ : num [1:7] -3.88 -1.68 -2.93 -1.04 -3.12 ...</code></pre>
</div>
</div>
<p>Если же и количество глубин в каждой популяции должно быть случайным, то нам понадобится функционал, который может принять более двух аргументов — это <code>pmap</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>nelem <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">5</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>depths <span class="ot">&lt;-</span> <span class="fu">pmap</span>(<span class="fu">list</span>(<span class="at">min =</span> zmin, <span class="at">max =</span> zmax, <span class="at">n =</span> nelem), runif)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(depths)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 5
 $ : num [1:5] -9.71 -6.64 -6.41 -5.91 -9.51
 $ : num [1:6] -7.47 -7.03 -7.09 -8.14 -7.83 ...
 $ : num [1:2] -7.41 -6.88
 $ : num -4
 $ : num [1:3] -2.14 -4.22 -2.01</code></pre>
</div>
</div>
<p>Еще один полезный сценарий, который проддерживается <strong>purrr</strong> — это одновременная итерация по индексам аргументов и их значениям. Такая возможность реализуется в функционалах с префиксом <code>i</code>: <code>imap()</code>, <code>iwalk()</code> и их модификациях.</p>
<blockquote class="blockquote">
<p>Функционалы семейства <code>walk()</code> в отличие от map не возвращают значения, а только посещают каждый элемент. Их используют, например, чтобы сохранить каждый элемент структуры данных в файл, построить график на его основе или просто вывести инфомацию о нем в консоль.</p>
</blockquote>
<p>Например, можем вывести данные по случайным глубинам посредством <code>iwalk()</code> в аннотированном виде:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">iwalk</span>(depths, \(z, i) <span class="fu">cat</span>(<span class="st">'Sample '</span>, i, <span class="st">': '</span>, z, <span class="st">'</span><span class="sc">\n</span><span class="st">'</span>, <span class="at">sep =</span> <span class="st">''</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample 1: -9.714993-6.636848-6.413566-5.909034-9.511208
Sample 2: -7.466208-7.030675-7.091471-8.139645-7.830458-7.188147
Sample 3: -7.405076-6.881571
Sample 4: -4.000526
Sample 5: -2.143847-4.222869-2.013891</code></pre>
</div>
</div>
</section>
</section>
<section id="tech-meta" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="tech-meta"><span class="header-section-number">4.3</span> Квотация аргументов</h2>
<p>Вы уже сталкивались с квотацией, когда работали с функциями <code>dplyr</code>. Например, сравните следующие два способа извлечь столбец из фрейма данных:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"salary"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   salary
    &lt;dbl&gt;
 1 36268.
 2 39790 
 3 40303.
 4 69884.
 5 31483 
 6 34142 
 7 53240.
 8 32377.
 9 27405.
10 44187 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(df, salary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   salary
    &lt;dbl&gt;
 1 36268.
 2 39790 
 3 40303.
 4 69884.
 5 31483 
 6 34142 
 7 53240.
 8 32377.
 9 27405.
10 44187 </code></pre>
</div>
</div>
<p>В обоих случаях мы получили один и тот же результат. В первом случае было указано название столбца в кавычках. Во втором мы передали название столбца без кавычек, точно так же как было передано название фрейма данных. Как R догадался, что параметр <code>salary</code> — это не имя переменной, которая живет на одном уровне с</p>
<p>Для начала разберемся с тем, что происходит в программном коде:</p>
<ul>
<li><code>select()</code> представляет собой <strong>вызов</strong> (call) функции</li>
<li><code>df</code> и <code>salary</code> представляют собой <strong>символы</strong>, обозначающие объекты в программе.</li>
<li><code>"salary"</code> представляет собой <strong>константу</strong></li>
</ul>
<p>R — это <em>функциональный</em> язык программирования. Любая программа на R состоит из вызовов функций, которые применяются к символам и константам. Привычные нам арифметические операции на самом деле тоже являются вызовами функций. Это выглядит довольно неожиданно:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">=</span> <span class="dv">78</span>     <span class="co"># стандартная запись</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">=</span><span class="st">`</span>(a, <span class="dv">78</span>) <span class="co"># функциональная запись</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>a <span class="sc">+</span> <span class="dv">4</span>     <span class="co"># стандартная запись</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 82</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">+</span><span class="st">`</span>(a, <span class="dv">4</span>) <span class="co"># функциональная запись</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 82</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'salary'</span>]      <span class="co"># стандартная запись</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   salary
    &lt;dbl&gt;
 1 36268.
 2 39790 
 3 40303.
 4 69884.
 5 31483 
 6 34142 
 7 53240.
 8 32377.
 9 27405.
10 44187 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">[</span><span class="st">`</span>(df, <span class="st">'salary'</span>) <span class="co"># функциональная запись</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   salary
    &lt;dbl&gt;
 1 36268.
 2 39790 
 3 40303.
 4 69884.
 5 31483 
 6 34142 
 7 53240.
 8 32377.
 9 27405.
10 44187 </code></pre>
</div>
</div>
<p>Таким образом, бинарный оператор в R представляет собой <em>вызов функции с двумя аргументами</em>.</p>
<p>Программный код <code>a + 4</code> с точки зрения R является <strong>выражением</strong> <em>(expression)</em>. Выражение может состоять вообще из одного символа, то есть <code>a</code> — это тоже выражение. Когда интерпретатор доходит до выражения <code>a + 4</code>, он выполняет следующее:</p>
<ol type="1">
<li><strong>Оценка</strong> <em>(evaluation)</em> выражения <code>a</code>. Результатом оценки является константа <code>78</code></li>
<li><strong>Вызов</strong> <em>(call)</em> функции <code>+</code>, которая складывает константы 78 и 4</li>
</ol>
<p>Не все символы и выражения в программе необходимо оценивать. Некоторые из них необходимо <strong>квотировать</strong>, то есть использовать в качестве <em>имени</em> объекта. Квотацию можно условно рассматривать как простановку кавычек вокруг выражения. Для обозначения квотации в явном виде используются обратные кавычки: <code>`</code> Мы уже сталкивались с квотацией при вызове функции сложения: <code>`+`(a, 4)</code>. В данном случае квотация была нужна чтобы <code>+</code> интерпретировался как <em>имя</em> функции.</p>
<p>Явная квотация бывает необходима, когда объекты R имеют недопустимые имена, например начинаются с цифры или содержат пробелы. Для начала рассмотрим искусственный пример:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">f + 17</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">87</span> <span class="co"># создаем объект с именем f + 17</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>f <span class="sc">+</span> <span class="dv">17</span> <span class="co"># ошибка: переменной f не существует</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'f' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">f + 17</span><span class="st">`</span> <span class="co"># обращаемся к объекту путем явной квотации</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 87</code></pre>
</div>
</div>
<p>Теперь более жизнеспособный пример: данные о населении федеральных округов:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>(<span class="at">okruga =</span> <span class="fu">read_csv</span>(<span class="st">'data/okruga.csv'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 7
    `№` Регион            `2005` `2010` `2011` `2012` `2013`
  &lt;dbl&gt; &lt;chr&gt;              &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     1 Центральный         4341   3761   3613   3651   3570
2     2 Северо-Западный     3192   3088   2866   2877   2796
3     3 Южный федеральный   1409   1446   1436   1394   1321
4     4 Северо-Кавказский    496    390    397    395    374
5     5 Приволжский         3162   2883   2857   2854   2849
6     6 Уральский           1681   1860   1834   1665   1624
7     7 Сибирский           2575   2218   2142   2077   1941
8     8 Дальневосточный      871    870    821    765    713</code></pre>
</div>
</div>
<p>Обратите внимание на обратные кавычки вокруг названий столбцов. Они проставлены потому что числа в среде R по умолчанию <em>оцениваются</em>, и не могут использоваться в качестве символов для объектов. Чтобы разрешить это, используется принудительная квотация. Как мы уже знаем, чтобы обратиться к такому объекту, надо использовать обратные кавычки:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>okruga<span class="sc">$</span><span class="dv">2010</span>   <span class="co"># ошибка: 2010 - константа, которая оценивается</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: &lt;text&gt;:1:8: unexpected numeric constant
1: okruga$2010
           ^</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>okruga<span class="sc">$</span><span class="st">`</span><span class="at">2010</span><span class="st">`</span> <span class="co"># правильно: `2010` -- символ, полученный путем квотации</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3761 3088 1446  390 2883 1860 2218  870</code></pre>
</div>
</div>
<p>Теперь вернемся к примеру с использованием функции <code>select()</code>. Данная функция <em>оценивает</em> первый аргумент (фрейм данных) и <em>квотирует</em> все оставшиеся аргументы, которые отвечают за названия столбцов. Это позволяет избежать использования кавычек и использовать символы для наименования объектов. Чтобы понять, использует ли функция оценку или квотацию ее аргументов, необходимо ознакомиться с ее справкой.</p>
<blockquote class="blockquote">
<p>Когда функция применяет квотацию аргументов, говорят что осуществляется <strong>нестандартная оценка</strong> <em>(NSE – non-standard evaluation)</em>. Если аргументы функции оцениваются, то происходит <strong>стандартная оценка</strong> <em>(SE – standard evaluation)</em></p>
</blockquote>
<p>Иногда бывает необходимо использовать строковые названия столбцов (например, если они записаны у вас в переменные). Функция select достаточно умна и в случае если квотация дала несуществующие значения столбцов, произведет оценку аргументов и попытается извлечь из них имена:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>f1 <span class="ot">=</span> <span class="st">'salary'</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>f2 <span class="ot">=</span> <span class="st">'birth'</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(df, f1, f2)        <span class="co"># ОК</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   salary birth
    &lt;dbl&gt; &lt;dbl&gt;
 1 36268.  13  
 2 39790   14.5
 3 40303.  11.8
 4 69884.  18.1
 5 31483   16.2
 6 34142   13.3
 7 53240.  12.4
 8 32377.  13.8
 9 27405.  13.2
10 44187   13.6</code></pre>
</div>
</div>
<p>Если же передавать в качестве аргумента константы, то они всегда используются по значению, т.к. имени у них нет:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(df, <span class="st">'salary'</span>, <span class="st">'birth'</span>) <span class="co"># то же самое</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   salary birth
    &lt;dbl&gt; &lt;dbl&gt;
 1 36268.  13  
 2 39790   14.5
 3 40303.  11.8
 4 69884.  18.1
 5 31483   16.2
 6 34142   13.3
 7 53240.  12.4
 8 32377.  13.8
 9 27405.  13.2
10 44187   13.6</code></pre>
</div>
</div>
<p>Иногда выражения бывает необходимо создать, а оценивать уже потом. Такой подход иногда используется в статистическом анализе. Для этого существуеют <strong>объекты выражений</strong>, которые создаются с помощью функции <code>expression()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">d =</span> <span class="fu">expression</span>(b<span class="sc">^</span><span class="dv">2</span> <span class="sc">-</span> <span class="dv">4</span><span class="sc">*</span>a)) <span class="co"># создаем выражение</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>expression(b^2 - 4 * a)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>b <span class="ot">=</span> <span class="dv">7</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="fu">eval</span>(d) <span class="co"># оцениваем значение выражения</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 41</code></pre>
</div>
</div>
<p>Все символы в объекте выражения по умолчанию <em>квотируются</em> и выражение хранится в статичном виде до тех пор пока не будет произведена его оценка (подстановка значений переменных вместо их символов).</p>
<blockquote class="blockquote">
<p>Выражения и квотация существуют в R благодаря возможностям <strong>метапрограммирования</strong>. Это техника программирования, при которой программный код может генерировать другой код. Широкая поддержка и интенсивное использование метапрограммирования – одна из удивительных черт <strong>R</strong>, которая ставит его особняком на фоне многих других языков, включая Python. Метапрограммирование позволяет во многих случаях сделать код более компактным и подойти к решению задачи элегантным путем.</p>
</blockquote>
</section>
<section id="tech_review" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="tech_review"><span class="header-section-number">4.4</span> Краткий обзор</h2>
<p>Для просмотра презентации щелкните на ней один раз левой кнопкой мыши и листайте, используя кнопки на клавиатуре:</p>
<div class="cell">
<iframe src="https://tsamsonov.github.io/r-geo-course-slides/04_Functions.html#1" width="672" height="390px" data-external="1">
</iframe>
</div>
<blockquote class="blockquote">
<p>Презентацию можно открыть в отдельном окне или вкладке браузере. Для этого щелкните по ней правой кнопкой мыши и выберите соответствующую команду.</p>
</blockquote>
</section>
<section id="tech_questions" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="tech_questions"><span class="header-section-number">4.5</span> Контрольные вопросы и упражнения</h2>
<section id="tech_questions_questions" class="level3" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="tech_questions_questions"><span class="header-section-number">4.5.1</span> Вопросы</h3>
<ol type="1">
<li>Что такое функция?</li>
<li>Какое ключевое слово ипользуется для создания функции?</li>
<li>В каких случаях целесообразно применение функций?</li>
<li>Сколько аргументов может принимать функция?</li>
<li>Можно ли из одной функции вызывать другую функцию?</li>
<li>Как осуществить принудительный выход из функции с возвратом результата?</li>
<li>Что необходимо сделать, если надо передать несколько объектов из функции?</li>
<li>Для чего нужны функционалы семейства <em>apply</em>? В каких задачах они бывают полезны?</li>
<li>Перечислите функции семейства <em>apply</em>, назовите их отличия и сферы применения.</li>
<li>Какая функция семейства <em>apply</em> позволяет обабатывать заданные измерения?</li>
<li>Какой объект первым передается в функцию, подставляемую в параметр <code>FUN</code>, если применяется <em>lapply</em> к фрейму данных?</li>
<li>Назовите аналоги функций <em>apply</em> из пакета <strong>purrr</strong></li>
<li>Что такое метапрограммирование?</li>
<li>Из каких объектов состоят выражения в R?</li>
<li>Что из себя по на самом деле представляют бинарные операторы в R?</li>
<li>Как обратиться к объекту, символ которого не является допустимым именем переменной?</li>
<li>Что такое оценка и квотация выражения? Для чего они используются?</li>
<li>Как понять, будет ли используемая вами функция квотрировать или оценивать ее аргументы?</li>
<li>Как называются функции <strong>dplyr</strong>, осуществляющие оценку, а не квотацию аргументов?</li>
<li>Как создать и оценить объект выражения в R?</li>
</ol>
</section>
<section id="tech_questions_tasks" class="level3" data-number="4.5.2">
<h3 data-number="4.5.2" class="anchored" data-anchor-id="tech_questions_tasks"><span class="header-section-number">4.5.2</span> Упражнения</h3>
<ol type="1">
<li><p>Напишите функцию <code>is_leap(year)</code>, которая определяет, является ли указанный год високосным. Протестируйте ее в вашем скрипте, используя чтение года из консолии</p>
<blockquote class="blockquote">
<p><strong>Подсказка</strong>: високосным считается год, кратный 400, либо кратный 4, но не кратный 100.</p>
</blockquote></li>
<li><p><a href="https://en.wikipedia.org/wiki/Tobler%27s_hiking_function"><strong>Функция Тоблера</strong></a> показывает зависимость скорости пешего маршрута (в км/ч) от угла наклона на местности. Предположим, в вашем распоряжении имеется матрица профиля рельефа, в которой в одном столбце указано расстояние от начала маршрута, а во втором — абсолютная отметка точки. Напишите функцию <code>hiking_time(profile)</code>, которая вычисляет время прохождения маршрута на основе переданной ей матрицы. Используйте для тестирования функции маршрут из 10 точек с шагом в 1 км и случайным разбросом высот в диапазоне от 500 до 1000 метров (равномерное распределение).</p>
<blockquote class="blockquote">
<p><strong>Подсказка:</strong> угол наклона на каждом участке считается постоянным. Для вычисления экспоненты используйте встроенную функцию <code>exp()</code>.</p>
</blockquote></li>
<li><p>Создайте на основе данных по Москве с сайта <a href="http://www.pogodaiklimat.ru/climate/27612.htm">pogodaiklimat</a> таблицу <em>Excel</em> с повторяемостью различных направлений ветра. Не преобразовывая структуру данных, вычислите на ее основе с помощью <code>lapply()</code> преобладающее направление для каждого месяца. Представьте результат как фрейм данных.</p></li>
<li><p>В текущей лекции мы работали с <a href="https://github.com/tsamsonov/r-geo-course/blob/master/data/sevzap.xlsx"><strong>данными</strong></a> по характеристикам центров субъектов СЗФО. Напишите функцию <code>get_extremes(df)</code>, которая определяет названия переменных, по которым каждая строчка фрейма данных (в нашем случае — город) занимает максимальное и минимальное положение относительно среднего значения по всем городам. Например, Петрозаводск имеет максимальный рейтинг по показателю <em>doctors</em> (1.05) — количество врачей на 10000 чел и минимальный по показателю <em>manufact</em> (0.05) — продукции обрабатывающей промышленность (в млн руб). Результирующая таблица должна содержать первое по счету поле, а также поля <em>minvar</em> и <em>maxvar</em>:</p>
<pre><code>Region        minvar    maxvar
Петрозаводск doctors  manufact
...
...</code></pre>
<blockquote class="blockquote">
<p><strong>Подсказка:</strong> для начала вам надо нормировать значения всех переменных с помощью <code>lapply()</code>. Затем нужно определить номер столбца, имеющего максимальное и минимальное значений для каждой строки таблицы. Используйте для этого функции <code>which.min()</code> и <code>which.max()</code> возвращающие индекс максимального и минимального элемента вектора, в комбинации с функцией <code>colnames()</code>, возвращающей названия переменных. Применяйте функцию <code>apply()</code>, которая умеет ходить по строкам.</p>
</blockquote></li>
</ol>
<table class="table">
<tbody>
<tr class="odd">
<td><em>Самсонов Т.Е.</em> <strong>Визуализация и анализ географических данных на языке R.</strong> М.: Географический факультет МГУ, <code>lubridate::year(Sys.Date())</code>. DOI: <a href="https://doi.org/10.5281/zenodo.901911">10.5281/zenodo.901911</a></td>
</tr>
</tbody>
</table>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03-Tables.html" class="pagination-link  aria-label=" &lt;span="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Таблицы</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05-BaseGraphics.html" class="pagination-link" aria-label="<span class='chapter-number'>5</span>&nbsp; <span class='chapter-title'>Базовая графика</span>">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Базовая графика</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>