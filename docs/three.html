<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Глава 12 Трехмерные модели | Визуализация и анализ географических данных на языке R</title>
<meta name="author" content="Тимофей Самсонов">
<meta name="description" content="12.1 Предварительные условия Для выполнения кода данной лекции вам понадобятся следующие пакеты: library(sf) library(stars) library(dplyr) library(rayshader)  12.2 Введение Трехмерные модели...">
<meta name="generator" content="bookdown 0.30 with bs4_book()">
<meta property="og:title" content="Глава 12 Трехмерные модели | Визуализация и анализ географических данных на языке R">
<meta property="og:type" content="book">
<meta property="og:description" content="12.1 Предварительные условия Для выполнения кода данной лекции вам понадобятся следующие пакеты: library(sf) library(stars) library(dplyr) library(rayshader)  12.2 Введение Трехмерные модели...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Глава 12 Трехмерные модели | Визуализация и анализ географических данных на языке R">
<meta name="twitter:site" content="@timofeysamsonov">
<meta name="twitter:description" content="12.1 Предварительные условия Для выполнения кода данной лекции вам понадобятся следующие пакеты: library(sf) library(stars) library(dplyr) library(rayshader)  12.2 Введение Трехмерные модели...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.1/transition.js"></script><script src="libs/bs3compat-0.4.1/tabs.js"></script><script src="libs/bs3compat-0.4.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.26/datatables.js"></script><link href="libs/dt-core-1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.12.1/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.12.1/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/plotly-binding-4.10.1/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="default">
<link rel="stylesheet" href="custom.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Визуализация и анализ географических данных на языке R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Введение</a></li>
<li class="book-part">Основы языка R</li>
<li><a class="" href="basics.html"><span class="header-section-number">1</span> Типы данных</a></li>
<li><a class="" href="data-structures.html"><span class="header-section-number">2</span> Структуры данных</a></li>
<li><a class="" href="tables.html"><span class="header-section-number">3</span> Таблицы</a></li>
<li><a class="" href="controls.html"><span class="header-section-number">4</span> Функции</a></li>
<li class="book-part">Графика и статистика</li>
<li><a class="" href="graphics.html"><span class="header-section-number">5</span> Базовая графика</a></li>
<li><a class="" href="advgraphics.html"><span class="header-section-number">6</span> Продвинутая графика</a></li>
<li><a class="" href="stats.html"><span class="header-section-number">7</span> Основы статистики</a></li>
<li><a class="" href="temporal.html"><span class="header-section-number">8</span> Временные ряды</a></li>
<li class="book-part">Пространственные данные и карты</li>
<li><a class="" href="spatial.html"><span class="header-section-number">9</span> Пространственные данные</a></li>
<li><a class="" href="maps.html"><span class="header-section-number">10</span> Основы картографии</a></li>
<li><a class="" href="mapping.html"><span class="header-section-number">11</span> Тематические карты</a></li>
<li><a class="active" href="three.html"><span class="header-section-number">12</span> Трехмерные модели</a></li>
<li class="book-part">Пространственный анализ</li>
<li><a class="" href="vector.html"><span class="header-section-number">13</span> Векторный анализ</a></li>
<li><a class="" href="interp.html"><span class="header-section-number">14</span> Интерполяция геополей</a></li>
<li><a class="" href="raster.html"><span class="header-section-number">15</span> Растровый анализ</a></li>
<li><a class="" href="network.html"><span class="header-section-number">16</span> Анализ сетей и траекторий</a></li>
<li class="book-part">Решение проблем</li>
<li><a class="" href="package-troubles.html"><span class="header-section-number">A</span> Установка пакетов</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/tsamsonov/r-geo-course">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="three" class="section level1" number="12">
<h1>
<span class="header-section-number">Глава 12</span> Трехмерные модели<a class="anchor" aria-label="anchor" href="#three"><i class="fas fa-link"></i></a>
</h1>
<div id="mapping3d_prerequisites" class="section level2" number="12.1">
<h2>
<span class="header-section-number">12.1</span> Предварительные условия<a class="anchor" aria-label="anchor" href="#mapping3d_prerequisites"><i class="fas fa-link"></i></a>
</h2>
<p>Для выполнения кода данной лекции вам понадобятся следующие пакеты:</p>
<div class="sourceCode" id="cb611"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.rayshader.com">rayshader</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div id="three_intro" class="section level2" number="12.2">
<h2>
<span class="header-section-number">12.2</span> Введение<a class="anchor" aria-label="anchor" href="#three_intro"><i class="fas fa-link"></i></a>
</h2>
<p>Трехмерные модели местности могут использоваться в тех случаях, когда стандартное картографическое изображение недостаточно наглядно. Поскольку и построение трехмерных моделей и взаимодействие с ними сложнее, чем с обычными картами, они распространены не столь повсеместно.</p>
</div>
<div id="three_labels" class="section level2" number="12.3">
<h2>
<span class="header-section-number">12.3</span> Создание трёхмерной сцены<a class="anchor" aria-label="anchor" href="#three_labels"><i class="fas fa-link"></i></a>
</h2>
<div id="three_lighting" class="section level3" number="12.3.1">
<h3>
<span class="header-section-number">12.3.1</span> Освещение цифровой модели рельефа<a class="anchor" aria-label="anchor" href="#three_lighting"><i class="fas fa-link"></i></a>
</h3>
<p>Построение трехмерной модели обычно начинается с создания изображения рельефа. В качестве примера рассмотрим ЦМР на территорию в окрестностях Хибин и Ловозёрских тундр в Мурманской области. Чтобы построить изображение рельефа, для начана надо получить матрицу со значениями цвета RGB, а затем вывести ее на экран посредством <code><a href="https://www.rayshader.com/reference/plot_map.html">plot_map()</a></code>. Градиентная окраска по высоте получается функцией <code><a href="https://www.rayshader.com/reference/height_shade.html">height_shade()</a></code>, аналитическая отмывка — через <code><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade()</a></code>:</p>
<div class="sourceCode" id="cb612"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dem</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="st">'data/dem_khibiny.tif'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">elev</span> <span class="op">=</span> <span class="va">dem</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># ВАЖНО: в текущей версии rayshader оси матрицы не должны иметь названий </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">elev</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">elev</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">elev</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-2-1.png" width="100%"></div>
<div class="sourceCode" id="cb613"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">elev</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span>zscale <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-2-2.png" width="100%"></div>
<div class="sourceCode" id="cb614"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dem_colors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"darkolivegreen"</span>, <span class="st">"lightyellow"</span>, <span class="st">"orange"</span>, <span class="st">"firebrick"</span>, <span class="st">"white"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">elev</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="fu">dem_colors</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span><span class="va">elev</span>, texture <span class="op">=</span> <span class="st">'bw'</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, alphalayer<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-2-3.png" width="100%"></div>
<p>Функция <code><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade()</a></code> имеет несколько встроенных палитр, которые позволяют раскрашивать поверхность в зависимости от восвещенности точки поверхности. В частности, она содержит стандартную черно-белую палитру, и четыре отмывки в швейцарском стиле Эдуарда Имгофа. Каждая палитра имеет, по сути, три цвета: фона, света и тени:</p>
<div class="sourceCode" id="cb615"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">palettes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'bw'</span>, <span class="st">'desert'</span>, <span class="st">'imhof1'</span>,<span class="st">'imhof2'</span>,<span class="st">'imhof3'</span>,<span class="st">'imhof4'</span>, <span class="st">'unicorn'</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">pal</span> <span class="kw">in</span> <span class="va">palettes</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">elev</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="va">pal</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="12-3DModels_files/figure-html/unnamed-chunk-3-1.png" width="100%"><img src="12-3DModels_files/figure-html/unnamed-chunk-3-2.png" width="100%"><img src="12-3DModels_files/figure-html/unnamed-chunk-3-3.png" width="100%"><img src="12-3DModels_files/figure-html/unnamed-chunk-3-4.png" width="100%"><img src="12-3DModels_files/figure-html/unnamed-chunk-3-5.png" width="100%"><img src="12-3DModels_files/figure-html/unnamed-chunk-3-6.png" width="100%"><img src="12-3DModels_files/figure-html/unnamed-chunk-3-7.png" width="100%"></p>
<p>Добавим принудительно посчитанные тени:</p>
<div class="sourceCode" id="cb616"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">elev</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="fu">dem_colors</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span><span class="va">elev</span>, texture <span class="op">=</span> <span class="st">'bw'</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, alphalayer<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/lamb_shade.html">lamb_shade</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-4-1.png" width="100%"></div>
<p>Рассеянный свет (ambient light) позволяет отделить долины от вершин хребтов:</p>
<div class="sourceCode" id="cb617"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">elev</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="fu">dem_colors</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span><span class="va">elev</span>, texture <span class="op">=</span> <span class="st">'bw'</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, alphalayer<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/lamb_shade.html">lamb_shade</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/ambient_shade.html">ambient_shade</a></span><span class="op">(</span><span class="va">elev</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-5-1.png" width="100%"></div>
<p>Для построение трехмерной сцены вместо <code><a href="https://www.rayshader.com/reference/plot_map.html">plot_map()</a></code> необходимо использовать <code><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d()</a></code>. При этом будет открыто интерактивное окно OpenGL, в котором вы сможете вращать созданную сцену:</p>
<div class="sourceCode" id="cb618"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">elev</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="fu">dem_colors</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span><span class="va">elev</span>, texture <span class="op">=</span> <span class="st">'bw'</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, alphalayer<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/lamb_shade.html">lamb_shade</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/ambient_shade.html">ambient_shade</a></span><span class="op">(</span><span class="va">elev</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">20</span>, fov <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          theta <span class="op">=</span> <span class="fl">135</span>, zoom <span class="op">=</span> <span class="fl">0.75</span>, phi <span class="op">=</span> <span class="fl">45</span>, </span>
<span>          windowsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1400</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># rgl::rglwidget(width = 800, height = 600)</span></span></code></pre></div>
<p>Чтобы сохранить текущий вид сцены, необходимо использовать функцию <code><a href="https://www.rayshader.com/reference/render_snapshot.html">render_snapshot()</a></code>. Для закрытия сцены используется функция <code><a href="https://dmurdoch.github.io/rgl/dev/reference/rgl.open.html">rgl::rgl.close()</a></code></p>
<div class="sourceCode" id="cb619"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://www.rayshader.com/reference/render_snapshot.html">render_snapshot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-7-1.png" width="100%"></div>
<div class="sourceCode" id="cb620"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/rgl.open.html">rgl.close</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="three_add" class="section level3" number="12.3.2">
<h3>
<span class="header-section-number">12.3.2</span> Векторные слои<a class="anchor" aria-label="anchor" href="#three_add"><i class="fas fa-link"></i></a>
</h3>
<p>Прочтем векторные данные:</p>
<div class="sourceCode" id="cb621"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db</span> <span class="op">=</span> <span class="st">'data/khibiny.gpkg'</span></span>
<span><span class="va">rivers</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">db</span>, <span class="st">'rivers'</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">lakes</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">db</span>, <span class="st">'lakes'</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">CLASS_ID</span> <span class="op">!=</span> <span class="fl">31300000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">roads_all</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">db</span>, <span class="st">'roads'</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">roads</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">roads_all</span>, <span class="va">CLASS_ID</span> <span class="op">&lt;=</span> <span class="fl">62131000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rails</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">db</span>, <span class="st">'rails'</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">forest</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">db</span>, <span class="st">'veg'</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">blocks</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">db</span>, <span class="st">'blocks'</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">poppol</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">db</span>, <span class="st">'poppol'</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>Добавим их через оверлей объектов:</p>
<div class="sourceCode" id="cb622"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ext</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html">extent</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">elev</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="fu">dem_colors</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span><span class="va">elev</span>, texture <span class="op">=</span> <span class="st">'bw'</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, alphalayer<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/lamb_shade.html">lamb_shade</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_line_overlay.html">generate_line_overlay</a></span><span class="op">(</span><span class="va">rivers</span>, linewidth <span class="op">=</span> <span class="fl">2</span>, color<span class="op">=</span><span class="st">"steelblue4"</span>,</span>
<span>                                    extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                    heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_polygon_overlay.html">generate_polygon_overlay</a></span><span class="op">(</span><span class="va">lakes</span>, linewidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                       palette <span class="op">=</span> <span class="st">'azure'</span>,</span>
<span>                                       linecolor <span class="op">=</span> <span class="st">'steelblue4'</span>,</span>
<span>                                       extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                       heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-9-1.png" width="100%"></div>
<p>Визуализируем в 3D:</p>
<div class="sourceCode" id="cb623"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">elev</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="fu">dem_colors</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span><span class="va">elev</span>, texture <span class="op">=</span> <span class="st">'bw'</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, alphalayer<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/lamb_shade.html">lamb_shade</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_line_overlay.html">generate_line_overlay</a></span><span class="op">(</span><span class="va">rivers</span>, linewidth <span class="op">=</span> <span class="fl">2</span>, color<span class="op">=</span><span class="st">"steelblue4"</span>,</span>
<span>                                    extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                    heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_polygon_overlay.html">generate_polygon_overlay</a></span><span class="op">(</span><span class="va">lakes</span>, linewidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                       palette <span class="op">=</span> <span class="st">'azure'</span>,</span>
<span>                                       linecolor <span class="op">=</span> <span class="st">'steelblue4'</span>,</span>
<span>                                       extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                       heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">20</span>, fov <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          theta <span class="op">=</span> <span class="fl">135</span>, zoom <span class="op">=</span> <span class="fl">0.75</span>, phi <span class="op">=</span> <span class="fl">45</span>,</span>
<span>          windowsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1400</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/render_snapshot.html">render_snapshot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-10-1.png" width="100%"></div>
<div class="sourceCode" id="cb624"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/rgl.open.html">rgl.close</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Чтобы приблизить изображение, повернуть, изменить угол наклона и т.д., используйте параметры функции <code><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d()</a></code>:</p>
<div class="sourceCode" id="cb625"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">elev</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="fu">dem_colors</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span><span class="va">elev</span>, texture <span class="op">=</span> <span class="st">'bw'</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, alphalayer<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/lamb_shade.html">lamb_shade</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_line_overlay.html">generate_line_overlay</a></span><span class="op">(</span><span class="va">rivers</span>, linewidth <span class="op">=</span> <span class="fl">2</span>, color<span class="op">=</span><span class="st">"steelblue4"</span>,</span>
<span>                                    extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                    heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_polygon_overlay.html">generate_polygon_overlay</a></span><span class="op">(</span><span class="va">lakes</span>, linewidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                       palette <span class="op">=</span> <span class="st">'azure'</span>,</span>
<span>                                       linecolor <span class="op">=</span> <span class="st">'steelblue4'</span>,</span>
<span>                                       extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                       heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">50</span>, fov <span class="op">=</span> <span class="fl">0</span>,</span>
<span>          theta <span class="op">=</span> <span class="fl">80</span>, zoom <span class="op">=</span> <span class="fl">0.25</span>, phi <span class="op">=</span> <span class="fl">35</span>,</span>
<span>          windowsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1400</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/render_snapshot.html">render_snapshot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-11-1.png" width="100%"></div>
<div class="sourceCode" id="cb626"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/rgl.open.html">rgl.close</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Расширим состав визуализируемых объектов:</p>
<div class="sourceCode" id="cb627"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plt</span> <span class="op">=</span> <span class="va">elev</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="fu">dem_colors</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span><span class="va">elev</span>, texture <span class="op">=</span> <span class="st">'bw'</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, alphalayer<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/lamb_shade.html">lamb_shade</a></span><span class="op">(</span><span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_polygon_overlay.html">generate_polygon_overlay</a></span><span class="op">(</span><span class="va">poppol</span>, linewidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                     palette <span class="op">=</span> <span class="st">'orange'</span>,</span>
<span>                                     linecolor <span class="op">=</span> <span class="st">'black'</span>,</span>
<span>                                     extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                     heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_line_overlay.html">generate_line_overlay</a></span><span class="op">(</span><span class="va">rivers</span>, linewidth <span class="op">=</span> <span class="fl">2</span>, color<span class="op">=</span><span class="st">"steelblue4"</span>,</span>
<span>                                    extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                    heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_polygon_overlay.html">generate_polygon_overlay</a></span><span class="op">(</span><span class="va">lakes</span>, linewidth <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                       palette <span class="op">=</span> <span class="st">'azure'</span>,</span>
<span>                                       linecolor <span class="op">=</span> <span class="st">'steelblue4'</span>,</span>
<span>                                       extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                       heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_line_overlay.html">generate_line_overlay</a></span><span class="op">(</span><span class="va">roads</span>, linewidth <span class="op">=</span> <span class="fl">4</span>, color<span class="op">=</span><span class="st">"black"</span>,</span>
<span>                                    extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                    heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_line_overlay.html">generate_line_overlay</a></span><span class="op">(</span><span class="va">roads</span>, linewidth <span class="op">=</span> <span class="fl">2</span>, color<span class="op">=</span><span class="st">"lightyellow"</span>,</span>
<span>                                  extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                  heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_line_overlay.html">generate_line_overlay</a></span><span class="op">(</span><span class="va">rails</span>, linewidth <span class="op">=</span> <span class="fl">3</span>, color<span class="op">=</span><span class="st">"black"</span>,</span>
<span>                                  extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                                  heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">plt</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-12-1.png" width="100%"></div>
<div class="sourceCode" id="cb628"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d</a></span><span class="op">(</span><span class="va">plt</span>, <span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">30</span>, fov <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        theta <span class="op">=</span> <span class="op">-</span><span class="fl">45</span>, zoom <span class="op">=</span> <span class="fl">0.25</span>, phi <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        windowsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1400</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/render_snapshot.html">render_snapshot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-12-2.png" width="100%"></div>
<div class="sourceCode" id="cb629"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/rgl.open.html">rgl.close</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="three_labels" class="section level3" number="12.3.3">
<h3>
<span class="header-section-number">12.3.3</span> Подписи<a class="anchor" aria-label="anchor" href="#three_labels"><i class="fas fa-link"></i></a>
</h3>
<p>Для размещения подписей следует использовать функцию <code><a href="https://www.rayshader.com/reference/generate_label_overlay.html">generate_label_overlay()</a></code>:</p>
<div class="sourceCode" id="cb630"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">popmajor</span> <span class="op">=</span> <span class="va">poppol</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">CLASS_ID</span> <span class="op">&lt;</span> <span class="fl">41300000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">popminor</span><span class="op">=</span> <span class="va">poppol</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">CLASS_ID</span> <span class="op">==</span> <span class="fl">41300000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt_lbl</span> <span class="op">=</span> <span class="va">plt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_point_overlay.html">generate_point_overlay</a></span><span class="op">(</span><span class="va">popmajor</span>, size <span class="op">=</span> <span class="fl">8</span>, extent <span class="op">=</span> <span class="va">ext</span>, color <span class="op">=</span> <span class="st">"black"</span>, pch <span class="op">=</span> <span class="fl">19</span>,</span>
<span>                                     heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_point_overlay.html">generate_point_overlay</a></span><span class="op">(</span><span class="va">popmajor</span>, size <span class="op">=</span> <span class="fl">3</span>, extent <span class="op">=</span> <span class="va">ext</span>, color <span class="op">=</span> <span class="st">"white"</span>, pch <span class="op">=</span> <span class="fl">19</span>,</span>
<span>                                     heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_label_overlay.html">generate_label_overlay</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">popmajor</span>,</span>
<span>                                     data_label_column <span class="op">=</span> <span class="st">'NAME'</span>,</span>
<span>                                     extent <span class="op">=</span> <span class="va">ext</span>, text_size <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"black"</span>, font<span class="op">=</span><span class="fl">2</span>,</span>
<span>                                     halo_color <span class="op">=</span> <span class="st">"white"</span>, halo_expand <span class="op">=</span> <span class="fl">2</span>, point_size <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                     seed<span class="op">=</span><span class="fl">1</span>, heightmap <span class="op">=</span> <span class="va">elev</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">plt_lbl</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-13-1.png" width="100%"></div>
<div class="sourceCode" id="cb631"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d</a></span><span class="op">(</span><span class="va">plt_lbl</span>, <span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">30</span>, fov <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        theta <span class="op">=</span> <span class="op">-</span><span class="fl">45</span>, zoom <span class="op">=</span> <span class="fl">0.5</span>, phi <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        windowsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1400</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/render_snapshot.html">render_snapshot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-13-2.png" width="100%"></div>
<div class="sourceCode" id="cb632"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/rgl.open.html">rgl.close</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Как видно, оверлей подписей выглядит не очень в трехмерноме режиме. В этом случае необходимо эти подписи наносить уже после того как трехмерный режим активирован:</p>
<div class="sourceCode" id="cb633"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d</a></span><span class="op">(</span><span class="va">plt</span>, <span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">30</span>, fov <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        theta <span class="op">=</span> <span class="op">-</span><span class="fl">45</span>, zoom <span class="op">=</span> <span class="fl">0.5</span>, phi <span class="op">=</span> <span class="fl">35</span>,</span>
<span>        windowsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1400</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">name</span> <span class="kw">in</span> <span class="va">popmajor</span><span class="op">$</span><span class="va">NAME</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pop</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">popmajor</span>, <span class="va">NAME</span> <span class="op">==</span> <span class="va">name</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/render_label.html">render_label</a></span><span class="op">(</span><span class="va">elev</span>, lat <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, lon <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>               text <span class="op">=</span> <span class="va">name</span>, altitude <span class="op">=</span> <span class="fl">1000</span>, zscale<span class="op">=</span><span class="fl">30</span>, textsize <span class="op">=</span> <span class="fl">1.75</span>, linewidth <span class="op">=</span> <span class="fl">4</span>,</span>
<span>               extent <span class="op">=</span> <span class="va">ext</span>, textcolor <span class="op">=</span> <span class="st">"turquoise2"</span>, linecolor<span class="op">=</span><span class="st">"turquoise2"</span>,</span>
<span>               relativez <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/render_snapshot.html">render_snapshot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-14-1.png" width="100%"></div>
<div class="sourceCode" id="cb634"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/rgl.open.html">rgl.close</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="three_animation" class="section level2" number="12.4">
<h2>
<span class="header-section-number">12.4</span> Анимация трёхмерной сцены<a class="anchor" aria-label="anchor" href="#three_animation"><i class="fas fa-link"></i></a>
</h2>
<p>Анимация с помощью пакета <strong>rayshader</strong> осуществляется покадрово. Для этого необходимо задать последовательность параметров камеры, каждый из которых будет определять кадр видеофильма, и определить эти параметры в функции <code><a href="https://www.rayshader.com/reference/render_movie.html">render_movie()</a></code>.</p>
<div id="three_animation_circle" class="section level3" number="12.4.1">
<h3>
<span class="header-section-number">12.4.1</span> Вращение относительно точки<a class="anchor" aria-label="anchor" href="#three_animation_circle"><i class="fas fa-link"></i></a>
</h3>
<p>Наиболее простой спобособ визуализации сцены — вращение относительно фиксированной точки. В этом случае необходимо менять только угол поворота камеры. По умолчанию <code><a href="https://www.rayshader.com/reference/render_movie.html">render_movie()</a></code> создает 12-секундный ролик с частотой 30 кадров в секунду (т.е. 360 кадров всего). Именно такой результат будет получен, если вызывать ее без параметров:</p>
<div class="sourceCode" id="cb635"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d</a></span><span class="op">(</span><span class="va">plt</span>, <span class="va">elev</span>, zscale <span class="op">=</span> <span class="fl">30</span>, fov <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        theta <span class="op">=</span> <span class="op">-</span><span class="fl">45</span>, zoom <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>        windowsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1400</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">name</span> <span class="kw">in</span> <span class="va">popmajor</span><span class="op">$</span><span class="va">NAME</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pop</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">popmajor</span>, <span class="va">NAME</span> <span class="op">==</span> <span class="va">name</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/render_label.html">render_label</a></span><span class="op">(</span><span class="va">elev</span>, lat <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, lon <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>               text <span class="op">=</span> <span class="va">name</span>, altitude <span class="op">=</span> <span class="fl">1000</span>, zscale<span class="op">=</span><span class="fl">30</span>, textsize <span class="op">=</span> <span class="fl">1.75</span>, linewidth <span class="op">=</span> <span class="fl">4</span>,</span>
<span>               extent <span class="op">=</span> <span class="va">ext</span>, textcolor <span class="op">=</span> <span class="st">"turquoise2"</span>, linecolor<span class="op">=</span><span class="st">"turquoise2"</span>,</span>
<span>               relativez <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://www.rayshader.com/reference/render_movie.html">render_movie</a></span><span class="op">(</span>filename <span class="op">=</span> <span class="st">'images/khibiny_rotate.gif'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="http://carto.geogr.msu.ru/r-geo-course/khibiny_rotate.gif" width="100%"></div>
</div>
<div id="three_animation_path" class="section level3" number="12.4.2">
<h3>
<span class="header-section-number">12.4.2</span> Облёт по траектории<a class="anchor" aria-label="anchor" href="#three_animation_path"><i class="fas fa-link"></i></a>
</h3>
<p>Для того чтобы территорию облететь по заданной траектории, необходимо эту траекторию создать. Проще всего такую задачу решить в настольной ГИС (ArcGIS, QGIS), оцифровав необходимую линию. Также можно создать объект через редактор пакета <a href="https://github.com/r-spatial/mapedit"><strong>mapedit</strong></a>. Подгрузим готовую траекторию из базы данных и посмотрим на ее контур:</p>
<div class="sourceCode" id="cb636"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">traj_line</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">db</span>, <span class="st">'trajectory'</span><span class="op">)</span></span>
<span><span class="co">## Reading layer `trajectory' from data source </span></span>
<span><span class="co">##   `/Users/tsamsonov/GitHub/r-geo-course/data/khibiny.gpkg' using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 1 feature and 0 fields</span></span>
<span><span class="co">## Geometry type: LINESTRING</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 482251.7 ymin: 7473232 xmax: 593004.8 ymax: 7545685</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 36N</span></span>
<span></span>
<span><span class="va">n_frames</span> <span class="op">=</span> <span class="fl">360</span></span>
<span></span>
<span><span class="va">traj_pts</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span><span class="va">traj_line</span>, size <span class="op">=</span> <span class="va">n_frames</span>, type <span class="op">=</span> <span class="st">'regular'</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">'POINT'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt_lbl</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_line_overlay.html">generate_line_overlay</a></span><span class="op">(</span><span class="va">traj_line</span>, linewidth <span class="op">=</span> <span class="fl">10</span>, extent <span class="op">=</span> <span class="va">ext</span>, heightmap <span class="op">=</span> <span class="va">elev</span>, color <span class="op">=</span> <span class="st">'cyan'</span><span class="op">)</span>, <span class="fl">0.8</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/generate_point_overlay.html">generate_point_overlay</a></span><span class="op">(</span><span class="va">traj_pts</span>, size <span class="op">=</span> <span class="fl">3</span>, extent <span class="op">=</span> <span class="va">ext</span>, heightmap <span class="op">=</span> <span class="va">elev</span>, color <span class="op">=</span> <span class="st">'orangered'</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="12-3DModels_files/figure-html/unnamed-chunk-17-1.png" width="100%"></div>
<p>Готовой функции для облета по траектории в rayshader пока что нет, поэтому необходимо соорудить эту функциональность самим. Рендер будем выполнять покадрово, обрезая растр таким образом чтобы текущая точка траектории оказывалась в его середине:</p>
<div class="sourceCode" id="cb637"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/magick/">magick</a></span><span class="op">)</span></span>
<span><span class="va">anim_wd</span> <span class="op">=</span> <span class="st">'anim'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">anim_wd</span><span class="op">)</span></span>
<span></span>
<span><span class="va">output_gif</span> <span class="op">=</span> <span class="st">"images/khibiny_traj.gif"</span></span>
<span></span>
<span><span class="va">img_frames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span></span>
<span>  <span class="va">anim_wd</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"anim_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">formatC</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n_frames</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">3</span>, flag <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span>, <span class="st">".png"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">coords</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">traj_pts</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">img_frames</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">box</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">traj_pts</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="fl">50000</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">elev_crop</span> <span class="op">=</span> <span class="va">dem</span><span class="op">[</span><span class="va">box</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">elev_crop</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">elev_crop</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">ext_crop</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html">extent</a></span><span class="op">(</span><span class="va">box</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">plt</span> <span class="op">=</span> <span class="va">elev_crop</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://www.rayshader.com/reference/height_shade.html">height_shade</a></span><span class="op">(</span>texture <span class="op">=</span> <span class="fu">dem_colors</span><span class="op">(</span><span class="fl">256</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://www.rayshader.com/reference/add_overlay.html">add_overlay</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/sphere_shade.html">sphere_shade</a></span><span class="op">(</span><span class="va">elev_crop</span>, texture <span class="op">=</span> <span class="st">'bw'</span>, zscale<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, alphalayer<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://www.rayshader.com/reference/add_shadow.html">add_shadow</a></span><span class="op">(</span><span class="fu"><a href="https://www.rayshader.com/reference/lamb_shade.html">lamb_shade</a></span><span class="op">(</span><span class="va">elev_crop</span>, zscale <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">dx</span> <span class="op">=</span> <span class="va">coords</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">coords</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">dy</span> <span class="op">=</span> <span class="va">coords</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">coords</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">A</span> <span class="op">=</span> <span class="fl">180</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">atan2</a></span><span class="op">(</span><span class="va">dx</span>, <span class="va">dy</span><span class="op">)</span> <span class="op">/</span> <span class="va">pi</span></span>
<span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/plot_3d.html">plot_3d</a></span><span class="op">(</span><span class="va">plt</span>, <span class="va">elev_crop</span>, zscale <span class="op">=</span> <span class="fl">30</span>, zoom <span class="op">=</span> <span class="fl">0.5</span>, theta <span class="op">=</span> <span class="op">-</span><span class="va">A</span>, phi <span class="op">=</span> <span class="fl">20</span>, windowsize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1400</span>, <span class="fl">800</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://www.rayshader.com/reference/render_snapshot.html">render_snapshot</a></span><span class="op">(</span><span class="va">img_frames</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/scene.html">clear3d</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">rgl</span><span class="fu">::</span><span class="fu"><a href="https://dmurdoch.github.io/rgl/dev/reference/rgl.open.html">rgl.close</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create gif</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/video.html">image_write_gif</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_read</a></span><span class="op">(</span><span class="va">img_frames</span><span class="op">[</span><span class="op">-</span><span class="fl">360</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                        path <span class="op">=</span> <span class="va">output_gif</span>,</span>
<span>                        delay <span class="op">=</span> <span class="fl">6</span><span class="op">/</span><span class="va">n_frames</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="http://carto.geogr.msu.ru/r-geo-course/khibiny_traj.gif" width="100%"></div>
</div>
</div>
<div id="questions_tasks_three" class="section level2" number="12.5">
<h2>
<span class="header-section-number">12.5</span> Контрольные вопросы и упражнения<a class="anchor" aria-label="anchor" href="#questions_tasks_three"><i class="fas fa-link"></i></a>
</h2>
<div id="questions_three" class="section level3" number="12.5.1">
<h3>
<span class="header-section-number">12.5.1</span> Вопросы<a class="anchor" aria-label="anchor" href="#questions_three"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="tasks_three" class="section level3" number="12.5.2">
<h3>
<span class="header-section-number">12.5.2</span> Упражнения<a class="anchor" aria-label="anchor" href="#tasks_three"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>Скачайте <a href="https://github.com/tsamsonov/r-geo-course/blob/master/data/Satino.gpkg">базу данных</a> и <a href="https://github.com/tsamsonov/r-geo-course/blob/master/data/Satino_DEM.zip">цифровую модель рельефа</a> на территорию Сатинского полигона МГУ. Постройте на их основе трехмерную модель местности и выполните ее круговую анимацию.</li>
</ol>
<div class="inline-table"><table class="table table-sm"><tbody><tr class="odd">
<td>
<em>Самсонов Т.Е.</em> <strong>Визуализация и анализ географических данных на языке R.</strong> М.: Географический факультет МГУ, <code>lubridate::year(Sys.Date())</code>. DOI: <a href="https://doi.org/10.5281/zenodo.901911">10.5281/zenodo.901911</a>
</td>
</tr></tbody></table></div>
</div>
</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="mapping.html"><span class="header-section-number">11</span> Тематические карты</a></div>
<div class="next"><a href="vector.html"><span class="header-section-number">13</span> Векторный анализ</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#three"><span class="header-section-number">12</span> Трехмерные модели</a></li>
<li><a class="nav-link" href="#mapping3d_prerequisites"><span class="header-section-number">12.1</span> Предварительные условия</a></li>
<li><a class="nav-link" href="#three_intro"><span class="header-section-number">12.2</span> Введение</a></li>
<li>
<a class="nav-link" href="#three_labels"><span class="header-section-number">12.3</span> Создание трёхмерной сцены</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#three_lighting"><span class="header-section-number">12.3.1</span> Освещение цифровой модели рельефа</a></li>
<li><a class="nav-link" href="#three_add"><span class="header-section-number">12.3.2</span> Векторные слои</a></li>
<li><a class="nav-link" href="#three_labels"><span class="header-section-number">12.3.3</span> Подписи</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#three_animation"><span class="header-section-number">12.4</span> Анимация трёхмерной сцены</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#three_animation_circle"><span class="header-section-number">12.4.1</span> Вращение относительно точки</a></li>
<li><a class="nav-link" href="#three_animation_path"><span class="header-section-number">12.4.2</span> Облёт по траектории</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#questions_tasks_three"><span class="header-section-number">12.5</span> Контрольные вопросы и упражнения</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#questions_three"><span class="header-section-number">12.5.1</span> Вопросы</a></li>
<li><a class="nav-link" href="#tasks_three"><span class="header-section-number">12.5.2</span> Упражнения</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/tsamsonov/r-geo-course/blob/master/12-3DModels.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/tsamsonov/r-geo-course/edit/master/12-3DModels.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Визуализация и анализ географических данных на языке R</strong>" was written by Тимофей Самсонов. It was last built on 2022-12-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
