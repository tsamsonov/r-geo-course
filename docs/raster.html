<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Глава 15 Растровый анализ | Визуализация и анализ географических данных на языке R</title>
<meta name="author" content="Тимофей Самсонов">
<meta name="description" content="Предварительные условия Для выполнения кода данной лекции вам понадобятся следующие пакеты: library(sf) library(sp) library(tmap) library(stars) library(mapview) library(mapedit) library(lattice)...">
<meta name="generator" content="bookdown 0.28 with bs4_book()">
<meta property="og:title" content="Глава 15 Растровый анализ | Визуализация и анализ географических данных на языке R">
<meta property="og:type" content="book">
<meta property="og:description" content="Предварительные условия Для выполнения кода данной лекции вам понадобятся следующие пакеты: library(sf) library(sp) library(tmap) library(stars) library(mapview) library(mapedit) library(lattice)...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Глава 15 Растровый анализ | Визуализация и анализ географических данных на языке R">
<meta name="twitter:site" content="@timofeysamsonov">
<meta name="twitter:description" content="Предварительные условия Для выполнения кода данной лекции вам понадобятся следующие пакеты: library(sf) library(sp) library(tmap) library(stars) library(mapview) library(mapedit) library(lattice)...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.24/datatables.js"></script><link href="libs/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/plotly-binding-4.10.0/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="default">
<link rel="stylesheet" href="custom.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Визуализация и анализ географических данных на языке R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Введение</a></li>
<li class="book-part">Основы языка R</li>
<li><a class="" href="basics.html"><span class="header-section-number">1</span> Типы данных</a></li>
<li><a class="" href="data-structures.html"><span class="header-section-number">2</span> Структуры данных</a></li>
<li><a class="" href="tables.html"><span class="header-section-number">3</span> Таблицы</a></li>
<li><a class="" href="controls.html"><span class="header-section-number">4</span> Функции</a></li>
<li class="book-part">Графика и статистика</li>
<li><a class="" href="graphics.html"><span class="header-section-number">5</span> Базовая графика</a></li>
<li><a class="" href="advgraphics.html"><span class="header-section-number">6</span> Продвинутая графика</a></li>
<li><a class="" href="stats.html"><span class="header-section-number">7</span> Основы статистики</a></li>
<li><a class="" href="temporal.html"><span class="header-section-number">8</span> Временные ряды</a></li>
<li class="book-part">Пространственные данные и карты</li>
<li><a class="" href="spatial.html"><span class="header-section-number">9</span> Пространственные данные</a></li>
<li><a class="" href="maps.html"><span class="header-section-number">10</span> Основы картографии</a></li>
<li><a class="" href="mapping.html"><span class="header-section-number">11</span> Тематические карты</a></li>
<li><a class="" href="three.html"><span class="header-section-number">12</span> Трехмерные модели</a></li>
<li class="book-part">Пространственный анализ</li>
<li><a class="" href="vector.html"><span class="header-section-number">13</span> Векторный анализ</a></li>
<li><a class="" href="interp.html"><span class="header-section-number">14</span> Интерполяция геополей</a></li>
<li><a class="active" href="raster.html"><span class="header-section-number">15</span> Растровый анализ</a></li>
<li><a class="" href="network.html"><span class="header-section-number">16</span> Анализ сетей и траекторий</a></li>
<li class="book-part">Решение проблем</li>
<li><a class="" href="package-troubles.html"><span class="header-section-number">A</span> Установка пакетов</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/tsamsonov/r-geo-course">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="raster" class="section level1" number="15">
<h1>
<span class="header-section-number">Глава 15</span> Растровый анализ<a class="anchor" aria-label="anchor" href="#raster"><i class="fas fa-link"></i></a>
</h1>
<div id="предварительные-условия" class="section level2 unnumbered">
<h2>Предварительные условия<a class="anchor" aria-label="anchor" href="#%D0%BF%D1%80%D0%B5%D0%B4%D0%B2%D0%B0%D1%80%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%83%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D1%8F"><i class="fas fa-link"></i></a>
</h2>
<p>Для выполнения кода данной лекции вам понадобятся следующие пакеты:</p>
<div class="sourceCode" id="cb702"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/">sp</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap">tmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapview">mapview</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapedit">mapedit</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://lattice.r-forge.r-project.org/">lattice</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/classInt/">classInt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">geosphere</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div id="raster_intro" class="section level2" number="15.1">
<h2>
<span class="header-section-number">15.1</span> Введение<a class="anchor" aria-label="anchor" href="#raster_intro"><i class="fas fa-link"></i></a>
</h2>
<p>Растровая модель данных представляет собой мощный инструмент абстракции пространственных распределений и выполнения пространственного анализа. На первый взгляд, растр обладает целым рядом ограничений по сравнению с векторной моделью: не позволяет оперировать отдельными объектами, их границами и так далее. Растровые карты и снимки мы часто оцифровываем, выделяя объекты, чтобы на основе них можно было что-то посчитать. Самые первые ГИС были исключительно растровыми, что сейчас воспринимается как архаизм.</p>
<p>Однако за ширмой ограниченности растровой модели кроются огромные аналитические возможности. Растровая модель обладает внутренней топологией: ее ячейки соприкасаются друг с другом, что позволяет моделировать непрерывные в пространстве и динамические явления (при которых происходит перемещение вещества, энергии или информации в пространстве). Поскольку ячейки растра имеют одинаковый размер, к ним можно применять однотипные операции, которые будут давать предсказуемый результат вне зависимости от конкретной локации в пределах растра. Это также позволяет сделать обработку растра очень быстро.</p>
</div>
<div id="растровая-алгебра" class="section level2" number="15.2">
<h2>
<span class="header-section-number">15.2</span> Растровая алгебра<a class="anchor" aria-label="anchor" href="#%D1%80%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B2%D0%B0%D1%8F-%D0%B0%D0%BB%D0%B3%D0%B5%D0%B1%D1%80%D0%B0"><i class="fas fa-link"></i></a>
</h2>
<p>Существует классификация операций растрового анализа, введенная американским профессором Даной Томлином, которая объединяет их под общим названием “алгебра карт” или “растровая алгебра” <span class="citation">(<a href="package-troubles.html#ref-Tomlin2012" role="doc-biblioref">Tomlin 2012</a>)</span>. Предполагая, что обработке подвергается <em>каждая</em> ячейка растра, данная классификация разделяет все операции по охвату относительно текущей ячейки</p>
<ol style="list-style-type: decimal">
<li>
<em>Локальные</em> — анализируется одна ячейка растра или совпадающие в пространстве ячейки нескольких растров</li>
<li>
<em>Фокальные</em> — анализируются все ячейки в окрестности. Окрестность может быть как фиксированной, так и расширенной (expanded), когда ее размер управляется внешними факторами, например множеством объектов, до которых требуется вычислить расстояние. Информация по соседним ячейкам может быть как из исходного растра, так и из внешнего. Фокальные методы алгебры карт также называются <em>методами анализа соседства</em>.</li>
<li>
<em>Зональные</em> — анализируются все ячейки в пределах зон, определяемых извне (например, вторым растровым слоем).</li>
<li>
<em>Глобальные</em> — анализируются все ячейки растра.</li>
</ol>
<div id="raster_local" class="section level3" number="15.2.1">
<h3>
<span class="header-section-number">15.2.1</span> Локальные операции<a class="anchor" aria-label="anchor" href="#raster_local"><i class="fas fa-link"></i></a>
</h3>
<p>Локальные операции связаны с алгебраическими преобразованиями значений в ячейках. Например, цифровую модель высот в футах можно перевести в цифровую модель высот в метрах. Для этого нужно значение в каждой ячейке умножить на <span class="math inline">\(0.3048\)</span>. В локальных операциях могут участвовать несколько растров. Например, если у нас есть растровые поверхности плотности населения за разные года, мы можем вычесть одну поверхность из другой, чтобы получить поверхность изменений плотности, выяснить где она увеличилась, уменьшилась или осталось прежней. К локальным операциям относится также оверлей растров, при котором получается взвешенная сумма значений по нескольким растрам. И в том и в другом случае анализируются ячейки с нескольких растров, которые совпадают в пространстве.</p>
<p>В качестве примера определим мощность покровного оледенения в Антарктике и Гренландии, путем вычитание двух моделей <a href="https://www.ngdc.noaa.gov/mgg/global/">ETOPO1</a>, одна из которых показывает рельеф коренных пород (bedrock), а вторая — видимый рельеф поверхности (ice surface):</p>
<div class="sourceCode" id="cb703"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ЛОКАЛЬНЫЕ ОПЕРАЦИИ</span></span>
<span><span class="co"># Вычисление толщины покровного оледенения</span></span>
<span></span>
<span><span class="co"># Чтение данных</span></span>
<span><span class="va">bed</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="st">'data/etopo1_bed.tif'</span><span class="op">)</span></span>
<span><span class="va">ice</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="st">'data/etopo1_ice.tif'</span><span class="op">)</span></span>
<span><span class="va">countries</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">'data/countries.gpkg'</span><span class="op">)</span></span>
<span><span class="co">## Reading layer `admin_0_map_units' from data source </span></span>
<span><span class="co">##   `/Users/tsamsonov/GitHub/r-geo-course/data/countries.gpkg' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 183 features and 72 fields</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -180 ymin: -90 xmax: 180 ymax: 83.64513</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span>
<span><span class="va">borders</span> <span class="op">=</span> <span class="va">countries</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_geometry</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># отображение данных</span></span>
<span><span class="va">classes</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/classInt/reference/classIntervals.html">classIntervals</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/values.html">values</a></span><span class="op">(</span><span class="va">bed</span><span class="op">)</span>, <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">brks</span> <span class="op">=</span> <span class="va">classes</span><span class="op">$</span><span class="va">brks</span></span>
<span><span class="va">nclass</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">brks</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">bed</span>, </span>
<span>     breaks <span class="op">=</span> <span class="va">brks</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html">gray.colors</a></span><span class="op">(</span><span class="va">nclass</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">'ETOPO Bedrock'</span>,</span>
<span>     legend <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-2-1.png" width="100%"></div>
<div class="sourceCode" id="cb704"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">ice</span>, </span>
<span>     breaks <span class="op">=</span> <span class="va">brks</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html">gray.colors</a></span><span class="op">(</span><span class="va">nclass</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">'ETOPO Ice surface'</span>,</span>
<span>     legend <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-2-2.png" width="100%"></div>
<div class="sourceCode" id="cb705"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># вычисление разности</span></span>
<span><span class="va">ice.depth</span> <span class="op">=</span> <span class="va">ice</span> <span class="op">-</span> <span class="va">bed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">ice.depth</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">cm.colors</a></span><span class="op">(</span><span class="fl">255</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">'Мощность покровного оледенения'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">borders</span>, </span>
<span>     border <span class="op">=</span> <span class="st">'black'</span>, </span>
<span>     lwd <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-2-3.png" width="100%"></div>
<div class="sourceCode" id="cb706"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># сделаем пустыми все ячейки, в которых толщина льда равна нулю</span></span>
<span><span class="va">ice.depth</span><span class="op">[</span><span class="va">ice.depth</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">ice.depth</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">cm.colors</a></span><span class="op">(</span><span class="fl">255</span><span class="op">)</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'Мощность покровного оледенения'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">borders</span>, </span>
<span>     border <span class="op">=</span> <span class="st">'black'</span>, </span>
<span>     lwd <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-2-4.png" width="100%"></div>
</div>
<div id="raster_focal" class="section level3" number="15.2.2">
<h3>
<span class="header-section-number">15.2.2</span> Фокальные операции<a class="anchor" aria-label="anchor" href="#raster_focal"><i class="fas fa-link"></i></a>
</h3>
<p>В фокальных операциях участвует не только сама ячейка или совпадающие с ней ячейки других растров, но также ячейки, находящиеся в некоторой окрестности (опять же, в одном или нескольких растрах одновременно). Данный вид анализа подразделяется на две категории: фокальный анализ с фиксированной окрестностью и с расширенной окрестностью.</p>
<div id="raster_focal_fixed" class="section level4" number="15.2.2.1">
<h4>
<span class="header-section-number">15.2.2.1</span> Фиксированная окрестность<a class="anchor" aria-label="anchor" href="#raster_focal_fixed"><i class="fas fa-link"></i></a>
</h4>
<p>В общем случае фиксированная окрестность может иметь различную форму, однако наиболее часто используется квадратная окрестность размером <span class="math inline">\(3\times3\)</span>:</p>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-3"></span>
<img src="images/raster_neighborhoods.png" alt="Виды растровых окрестностей. Темной точкой выделена анализируемая ячейка" width="100%"><p class="caption">
Рис. 7.2: Виды растровых окрестностей. Темной точкой выделена анализируемая ячейка
</p>
</div>
<p>Фокальные операции с фиксированной окрестностью — привычное дело в обработке изображений. Они работают по принципу “плавающего окна”. Выбранная окрестность (квадратная, круглая и т.д.) представляется в виде матрицы коэффициентов — так называемого ядра свёртки (convolution kernel). Далее эта матрица перемещается, позиционируясь последовательно над каждой ячейкой растра, и значение в этой ячейке заменяется на взвешенную сумму значений ячеек в окрестности, умноженных на соответствующие коэффициенты ядра свертки. Например, если ядро состоит из единиц, то будет посчитана обычная сумма.</p>
<p>С помощью фокального анализа можно выполнить сглаживание изображения, которое убирает из него мелкие детали (высокочастотные составляющие яркостного сигнала). В качестве такого изображения может быть цифровая модель рельефа или космический снимок. Чтобы выполнить сглаживание, коэффициенты должны быть такими, чтобы получаемая взвешенная сумма осредняла значения в соседних ячейках. Самый простой вариант — это рассчитать среднее арифметическое. В этом случае коэффициенты ядра свертки будут равны <span class="math inline">\(1/k\)</span>, где <span class="math inline">\(k\)</span> — количество ячеек в окрестности. Для матрицы <span class="math inline">\(3\times3\)</span> они будут равны, соответственно <span class="math inline">\(1/9\)</span>:</p>
<div class="sourceCode" id="cb707"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ФОКАЛЬНЫЕ ОПЕРАЦИИ</span></span>
<span></span>
<span><span class="co"># Вырежем кусок из ЦМР</span></span>
<span><span class="va">dem</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">ice</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html">extent</a></span><span class="op">(</span><span class="op">-</span><span class="fl">120</span>, <span class="op">-</span><span class="fl">75</span>, <span class="fl">10</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spplot.html">spplot</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-4-1.png" width="100%"></div>
<div class="sourceCode" id="cb708"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Среднее</span></span>
<span><span class="va">wgt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>               <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>               <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">9</span>, </span>
<span>              nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># на самом деле проще написать так:</span></span>
<span><span class="co"># wgt = matrix(1/9, 3, 3), но полная форма записана для наглядности</span></span>
<span></span>
<span><span class="co"># выполним обработку ЦМР с помощью фокального фильтра</span></span>
<span><span class="va">filtered</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/focal.html">focal</a></span><span class="op">(</span><span class="va">dem</span>, w <span class="op">=</span> <span class="va">wgt</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spplot.html">spplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">filtered</span><span class="op">)</span>,</span>
<span>       names.attr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Исходный рельеф'</span>, <span class="st">'Сглаживание средним'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-4-2.png" width="100%"></div>
<p>Более мягким эффектом сглаживания, который к тому же не нарушает дифференцируемость поверхности, является гауссово сглаживание. Коэффициенты в матрице Гаусса убывают от центральной ячейки к краям матрицы по закону Гаусса-Лапласа, что позволяет придать центральной ячейке более высокий вес по сравнению с ячейками, располагающимися на краю анализируемой окрестности:</p>
<div class="sourceCode" id="cb709"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Гауссово (параметр 0.5 - это стандартное отклонение в единицах измерения растра)</span></span>
<span><span class="va">wgt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/focalWeight.html">focalWeight</a></span><span class="op">(</span><span class="va">dem</span>, <span class="fl">0.5</span>, <span class="st">"Gauss"</span><span class="op">)</span></span>
<span><span class="va">filtered</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/focal.html">focal</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">wgt</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spplot.html">spplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">filtered</span><span class="op">)</span>,</span>
<span>       names.attr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Исходный рельеф'</span>, <span class="st">'Гауссово сглаживание'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-5-1.png" width="100%"></div>
<p>Еще одна интересная область применения фильтрации — это обнаружение границ (change detection). Границы на изображении возникают в тех местах, где его яркость резко меняет свое значение (в одном или нескольких каналах). Например, на фотографии контур лица может быть распознан по перепаду яркости между его изображением и фоном (если он имеет существенно отличный цвет). Поскольку перепад яркости соответствует экстремальным значениям производной поверхности (отрицательным или положительным), его также можно определить путем фокального анализа, а затем отсечь ячейки растра, в которых значение этой производной по модулю превышает заданный порог (то есть, имеет необходимый контраст).</p>
<p>Рассмотрим, как можно выделить уступы континентального склона океана путем применения фильтра Собеля для выделения границ:</p>
<div class="sourceCode" id="cb710"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Матрица Собеля:</span></span>
<span><span class="va">wgt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>,</span>
<span>               <span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">2</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span>, </span>
<span>              nrow<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">filtered</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/focal.html">focal</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">wgt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Это поверхность производных:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">filtered</span>,</span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html">gray.colors</a></span><span class="op">(</span><span class="fl">128</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">'Производная поверхности'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-6-1.png" width="100%"></div>
<div class="sourceCode" id="cb711"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Отберем все ячейки, обладающие высокими значениями производных</span></span>
<span><span class="va">faults</span> <span class="op">=</span> <span class="op">(</span><span class="va">filtered</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1500</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span><span class="va">filtered</span> <span class="op">&gt;</span> <span class="fl">1500</span><span class="op">)</span></span>
<span><span class="va">faults</span><span class="op">[</span><span class="va">faults</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># Визуализируем результат</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">dem</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">'Уступы континентального склона'</span>,</span>
<span>     legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">faults</span>,</span>
<span>     col <span class="op">=</span> <span class="st">'black'</span>,</span>
<span>     legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-6-2.png" width="100%"></div>
<p>Еще один распространенный случай использования фокальных операций — это морфометрический анализ поверхностей. Квадратная окрестность <span class="math inline">\(3\times3\)</span> вокруг каждой ячейки формирует локальную поверхность, производные которой дают представление об уклоне, экспозиции и прочих морфометрических параметрах. Их можно вычислить с помощью функции <code><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain()</a></code> из пакета <code>raster</code>:</p>
<div class="sourceCode" id="cb712"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Морфометрия рельефа — фиксированное соседство</span></span>
<span><span class="va">dem</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="st">'data/dem_fergana.tif'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spplot.html">spplot</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-7-1.png" width="100%"></div>
<div class="sourceCode" id="cb713"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># углы наклона</span></span>
<span><span class="va">slope</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain</a></span><span class="op">(</span><span class="va">dem</span>, opt <span class="op">=</span> <span class="st">'slope'</span>, unit <span class="op">=</span> <span class="st">'degrees'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spplot.html">spplot</a></span><span class="op">(</span><span class="va">slope</span>, </span>
<span>       col.regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">heat.colors</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>       names.attr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Углы наклона'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-7-2.png" width="100%"></div>
<div class="sourceCode" id="cb714"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># экспозиция</span></span>
<span><span class="va">aspect</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain</a></span><span class="op">(</span><span class="va">dem</span>, opt <span class="op">=</span> <span class="st">'aspect'</span>, unit <span class="op">=</span> <span class="st">'degrees'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/spplot.html">spplot</a></span><span class="op">(</span><span class="va">aspect</span>, </span>
<span>       col.regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>       names.attr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Экспозиции склона'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-7-3.png" width="100%"></div>
<p>Вычисление производных поверхности позволяет не только исследовать рельеф, но также строить его изображения. Например, хорошо знакомую всем по картам аналитическую отмывку рельефа (<em>hillshade</em>). Яркость поверхности в этом способе изображения зависит от угла между направлением на источник освещения (откуда светит Солнце) и нормалью к поверхности. Нормаль можно вычислить как напрямую через производные поверхности, так и восстановить на основе значений угла наклона и экспозиции в точке, что и используется в пакете <strong>raster</strong>. Обратите внимание на то, что для того чтобы повысить наглядность (контрастность) изображения, мы умножаем высоты рельефа на 20. Это стандартная практика для мелкомасштабных карт:</p>
<div class="sourceCode" id="cb715"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># отмывка</span></span>
<span><span class="va">slope2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain</a></span><span class="op">(</span><span class="va">dem</span> <span class="op">*</span> <span class="fl">20</span>, opt <span class="op">=</span> <span class="st">'slope'</span><span class="op">)</span></span>
<span><span class="va">aspect2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain</a></span><span class="op">(</span><span class="va">dem</span> <span class="op">*</span> <span class="fl">20</span>, opt <span class="op">=</span> <span class="st">'aspect'</span><span class="op">)</span></span>
<span>                 </span>
<span><span class="co"># параметры angle и direction функции hillShade определяют азимут и высоту источника освещения:</span></span>
<span><span class="va">hill_vert</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/hillShade.html">hillShade</a></span><span class="op">(</span><span class="va">slope2</span>, <span class="va">aspect2</span>, angle <span class="op">=</span> <span class="fl">90</span>, direction <span class="op">=</span> <span class="fl">315</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hill</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/hillShade.html">hillShade</a></span><span class="op">(</span><span class="va">slope2</span>, <span class="va">aspect2</span>, angle <span class="op">=</span> <span class="fl">45</span>, direction <span class="op">=</span> <span class="fl">315</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hill_comb</span> <span class="op">=</span> <span class="va">hill</span> <span class="op">*</span> <span class="va">hill_vert</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">hill_comb</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html">gray.colors</a></span><span class="op">(</span><span class="fl">128</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">'Отмывка рельефа'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-8-1.png" width="100%"></div>
</div>
<div id="raster_focal_extended" class="section level4" number="15.2.2.2">
<h4>
<span class="header-section-number">15.2.2.2</span> Расширенная окрестность<a class="anchor" aria-label="anchor" href="#raster_focal_extended"><i class="fas fa-link"></i></a>
</h4>
<p>Расширенность окрестности означает, что она определяется не фиксированным шаблоном, а условием, которое должно выполниться для того, чтобы анализ в ячейке считался выполненным. Типичный пример анализа на основе расширенной окрестности — это операции, основанные на вычислении расстояний на растровой матрице, такие как аллокация, определение кратчайшего пути на поверхности сопротивления, и собственно, само вычисление расстояние.</p>
<p>В мелкомасштабных тематических атласах часто можно встретить карты доступности той или иной географической локации, которые в форме изолиний показывают время движения до ближайшего населенного пункта. Эти изолинии можно построить по растровой поверхности, в каждой ячейке которой зафиксировано расстояние до ближайшего населенного пункта.</p>
<p>Рассмотрим построение аналогичной поверхности на примере доступности станций метро (по расстоянию). Для этого нам понадобится представить растр в виде матрицы точек, рассчитать для этих точек расстояния до ближайших станций метро и присвоить эти значения выходному растру:</p>
<div class="sourceCode" id="cb716"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Определение Евклидовых расстояний — расширенное соседство</span></span>
<span></span>
<span><span class="co"># Чтение данных</span></span>
<span><span class="va">roads</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/roads.gpkg"</span><span class="op">)</span> <span class="co"># Дороги</span></span>
<span><span class="co">## Reading layer `roads' from data source </span></span>
<span><span class="co">##   `/Users/tsamsonov/GitHub/r-geo-course/data/roads.gpkg' using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 2213 features and 12 fields</span></span>
<span><span class="co">## Geometry type: MULTILINESTRING</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 410946.9 ymin: 6176676 xmax: 415890.8 ymax: 6181910</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 37N</span></span>
<span><span class="va">poi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/poi_point.gpkg"</span><span class="op">)</span> <span class="co"># Точки интереса</span></span>
<span><span class="co">## Reading layer `poi_point' from data source </span></span>
<span><span class="co">##   `/Users/tsamsonov/GitHub/r-geo-course/data/poi_point.gpkg' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 6623 features and 9 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 410947.3 ymin: 6176678 xmax: 415889.9 ymax: 6181909</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 37N</span></span>
<span><span class="va">rayons</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/boundary_polygon.gpkg"</span><span class="op">)</span> <span class="co"># Границы районов</span></span>
<span><span class="co">## Reading layer `boundary_polygon' from data source </span></span>
<span><span class="co">##   `/Users/tsamsonov/GitHub/r-geo-course/data/boundary_polygon.gpkg' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 11 features and 5 fields</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 410946.9 ymin: 6176676 xmax: 415890.8 ymax: 6181910</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 37N</span></span>
<span><span class="va">stations</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/metro_stations.gpkg"</span><span class="op">)</span> <span class="co"># Станции метро</span></span>
<span><span class="co">## Reading layer `metro_stations' from data source </span></span>
<span><span class="co">##   `/Users/tsamsonov/GitHub/r-geo-course/data/metro_stations.gpkg' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 45 features and 3 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 411007.5 ymin: 6176747 xmax: 415852.2 ymax: 6181892</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 37N</span></span>
<span><span class="va">water</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/water_polygon.gpkg"</span><span class="op">)</span> <span class="co"># Водные объекты</span></span>
<span><span class="co">## Reading layer `water_polygon' from data source </span></span>
<span><span class="co">##   `/Users/tsamsonov/GitHub/r-geo-course/data/water_polygon.gpkg' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 8 features and 7 fields</span></span>
<span><span class="co">## Geometry type: POLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 411595.6 ymin: 6176676 xmax: 415890.8 ymax: 6180765</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 37N</span></span>
<span></span>
<span><span class="co"># Создаем пустой растр с охватом, равным охвату станции</span></span>
<span><span class="va">dist_grid</span> <span class="op">=</span> <span class="va">stations</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span>dx <span class="op">=</span> <span class="fl">25</span>, dy <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">.</span>, as_points <span class="op">=</span> <span class="cn">TRUE</span>, merge <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_distance</a></span><span class="op">(</span><span class="va">stations</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">min</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Визуализируем результат</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dist_grid</span><span class="op">[</span><span class="st">'dist'</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'white'</span>, <span class="st">'red'</span>, <span class="st">'black'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">stations</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">water</span>, size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">roads</span>, size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">stations</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'Расстояние до ближайшей станции метро'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-9-1.png" width="100%"></div>
</div>
</div>
<div id="raster_zonal" class="section level3" number="15.2.3">
<h3>
<span class="header-section-number">15.2.3</span> Зональные операции<a class="anchor" aria-label="anchor" href="#raster_zonal"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Зональные операции</strong> связаны с агрегированием растровых данных по площадным зонам. В пределах каждой зоны вычисляется одна или несколько характеристик значений анализируемого растра: среднее, максимум и т.д. Как правило, зоны задаются в виде вспомогательного растрового или векторного набора данных. В случае растра каждая ячейка должна содержать идентификатор (номер) зоны, к которой она относится. Совокупность ячеек, имеющих одинаковый идентификатор, определяет территорию, которую покрывает зона с этим идентификатором. Если зоны представлены векторным набором пространственных объектов, то каждый объект (полигон) также должен иметь собственный идентификатор. Теоретически в одном наборе данных может быть несколько пространственно не связанных объектов, относящихся к одной зоне (например, зона экваториального климата состоит из трех ареалов). В этом случае агрегирование данных будет произведено сразу по трем полигонам. Таким образом, количество получаемых в результате зональной статистики значений определяется количеством зон, но может не совпадать с общим количеством полигонов, которыми эти зоны представлены.</p>
<p>В качестве примера рассмотрим вычисление среднеклиматических параметров <em>WorldClim</em> в пределах различных типов земельного покрова (Land Cover), которые доступны в пакете <strong>tmap</strong>:</p>
<div class="sourceCode" id="cb717"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/getData.html">getData</a></span><span class="op">(</span><span class="st">"worldclim"</span>, var <span class="op">=</span> <span class="st">"tmean"</span>, res <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-10-1.png" width="100%"></div>
<div class="sourceCode" id="cb718"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">land</span>, package <span class="op">=</span> <span class="st">'tmap'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pal</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#003200"</span>, <span class="st">"#3C9600"</span>, <span class="st">"#006E00"</span>, <span class="st">"#556E19"</span>, <span class="st">"#00C800"</span>, <span class="st">"#8CBE8C"</span>,</span>
<span>           <span class="st">"#467864"</span>, <span class="st">"#B4E664"</span>, <span class="st">"#9BC832"</span>, <span class="st">"#EBFF64"</span>, <span class="st">"#F06432"</span>, <span class="st">"#9132E6"</span>,</span>
<span>           <span class="st">"#E664E6"</span>, <span class="st">"#9B82E6"</span>, <span class="st">"#B4FEF0"</span>, <span class="st">"#646464"</span>, <span class="st">"#C8C8C8"</span>, <span class="st">"#FF0000"</span>,</span>
<span>           <span class="st">"#FFFFFF"</span>, <span class="st">"#5ADCDC"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">land</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">pal</span>, guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, name <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">land</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-10-2.png" width="100%"></div>
<p>Предварительно необходимо убедиться, что оба растра имеют совпадающий охват (экстент) и пространственное разрешение. Обратите внимание на то, что, поскольку растр земельного покрова категориальный, для его передискретизации необходимо использовать метод ближайшего соседа (<em>Nearest Neighbor</em>), который для каждого пиксела нового растра берет значение в ближайшем к нему пикселе исходного растра:</p>
<div class="sourceCode" id="cb719"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp</span></span>
<span><span class="co">## stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">## attribute(s), summary of first 1e+05 cells:</span></span>
<span><span class="co">##          Min. 1st Qu. Median      Mean 3rd Qu.  Max.  NA's</span></span>
<span><span class="co">## tmean1  -42.1 -34.075 -30.85 -31.98754   -29.5 -27.8 98298</span></span>
<span><span class="co">## dimension(s):</span></span>
<span><span class="co">##      from   to offset     delta                       refsys point</span></span>
<span><span class="co">## x       1 2160   -180  0.166667 +proj=longlat +datum=WGS8...    NA</span></span>
<span><span class="co">## y       1  900     90 -0.166667 +proj=longlat +datum=WGS8...    NA</span></span>
<span><span class="co">## band    1   12     NA        NA                           NA    NA</span></span>
<span><span class="co">##                  values x/y</span></span>
<span><span class="co">## x                  NULL [x]</span></span>
<span><span class="co">## y                  NULL [y]</span></span>
<span><span class="co">## band tmean1,...,tmean12</span></span>
<span><span class="va">land</span></span>
<span><span class="co">## stars object with 2 dimensions and 4 attributes</span></span>
<span><span class="co">## attribute(s):</span></span>
<span><span class="co">##                cover                              cover_cls     </span></span>
<span><span class="co">##  Water bodies     :393060   Water                      :393060  </span></span>
<span><span class="co">##  Snow / Ice       : 61986   Snow/ice                   : 61986  </span></span>
<span><span class="co">##  Herbaceous       : 21377   Forest                     : 48851  </span></span>
<span><span class="co">##  Tree Open        : 16171   Other natural vegetation   : 32611  </span></span>
<span><span class="co">##  Sparse vegetation: 12247   Bare area/Sparse vegetation: 26904  </span></span>
<span><span class="co">##  Cropland         : 11658   Cropland                   : 17843  </span></span>
<span><span class="co">##  (Other)          : 66701   (Other)                    :  1945  </span></span>
<span><span class="co">##      trees          elevation     </span></span>
<span><span class="co">##  Min.   :  0.0    Min.   :-412    </span></span>
<span><span class="co">##  1st Qu.:  0.0    1st Qu.: 218    </span></span>
<span><span class="co">##  Median :  0.0    Median : 608    </span></span>
<span><span class="co">##  Mean   : 15.6    Mean   :1140    </span></span>
<span><span class="co">##  3rd Qu.: 19.0    3rd Qu.:1941    </span></span>
<span><span class="co">##  Max.   :100.0    Max.   :6410    </span></span>
<span><span class="co">##  NA's   :393060   NA's   :389580  </span></span>
<span><span class="co">## dimension(s):</span></span>
<span><span class="co">##   from   to offset.xmin delta.xmax                       refsys point values</span></span>
<span><span class="co">## x    1 1080        -180   0.333333 +proj=longlat +ellps=WGS8...  NULL   NULL</span></span>
<span><span class="co">## y    1  540          90  -0.333333 +proj=longlat +ellps=WGS8...  NULL   NULL</span></span>
<span><span class="co">##   x/y</span></span>
<span><span class="co">## x [x]</span></span>
<span><span class="co">## y [y]</span></span>
<span></span>
<span><span class="op">(</span><span class="va">cover</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_warp.html">st_warp</a></span><span class="op">(</span><span class="va">land</span><span class="op">[</span><span class="st">'cover'</span><span class="op">]</span>, <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">band</span>, <span class="fl">1</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">'near'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co">## attribute(s), summary of first 1e+05 cells:</span></span>
<span><span class="co">##                                   cover      </span></span>
<span><span class="co">##  Water bodies                        :98596  </span></span>
<span><span class="co">##  Snow / Ice                          :  996  </span></span>
<span><span class="co">##  Sparse vegetation                   :  400  </span></span>
<span><span class="co">##  Bare area,consolidated (gravel,rock):    8  </span></span>
<span><span class="co">##  Broadleaf Evergreen Forest          :    0  </span></span>
<span><span class="co">##  Broadleaf Deciduous Forest          :    0  </span></span>
<span><span class="co">##  (Other)                             :    0  </span></span>
<span><span class="co">## dimension(s):</span></span>
<span><span class="co">##   from   to offset     delta                       refsys point values x/y</span></span>
<span><span class="co">## x    1 2160   -180  0.166667 +proj=longlat +datum=WGS8...    NA   NULL [x]</span></span>
<span><span class="co">## y    1  900     90 -0.166667 +proj=longlat +datum=WGS8...    NA   NULL [y]</span></span>
<span><span class="co"># используем 'near', поскольку растр категориальный</span></span></code></pre></div>
<p>Для вычисления средней температуры за каждый месяц в пределах каждой зоны земельного покрова выполним следующую последовательность действий:</p>
<div class="sourceCode" id="cb720"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">months</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span></span>
<span><span class="va">cover_types</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">cover</span><span class="op">$</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="va">zonal_stats</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">cover_types</span>, <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">months</span>, <span class="kw">function</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">temp_month</span> <span class="op">=</span> <span class="va">temp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">band</span>, <span class="va">Y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">cover</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>masked <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">cover</span> <span class="op">==</span> <span class="va">X</span>, <span class="va">temp_month</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">masked</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">masked</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span><span class="op">(</span><span class="va">cover_types</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="va">months</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">month</span>, names_to <span class="op">=</span> <span class="st">'cover'</span>, values_to <span class="op">=</span> <span class="st">'tmean'</span><span class="op">)</span></span></code></pre></div>
<p>Визуализируем полученные результаты:</p>
<div class="sourceCode" id="cb721"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">zonal_stats</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">month</span>, y <span class="op">=</span> <span class="va">tmean</span>, color <span class="op">=</span> <span class="va">cover</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">pal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">months</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-13-1.png" width="100%"></div>
<p>Перед вычислением целесообразно разделить растр землепользования на северное и южное полушарие (т.к. ход температур в них противоположный):</p>
<div class="sourceCode" id="cb722"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cover_north</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">cover</span><span class="op">[</span><span class="st">'cover'</span><span class="op">]</span>, <span class="st">'Raster'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html">extent</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="fl">180</span>, <span class="fl">0</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cover_south</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">cover</span><span class="op">[</span><span class="st">'cover'</span><span class="op">]</span>, <span class="st">'Raster'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html">extent</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="fl">180</span>, <span class="op">-</span><span class="fl">60</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">temp_north</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">temp</span>, <span class="st">'Raster'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html">extent</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="fl">180</span>, <span class="fl">0</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">temp_south</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">temp</span>, <span class="st">'Raster'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/extent.html">extent</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="fl">180</span>, <span class="op">-</span><span class="fl">60</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtemp_north_tidy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/zonal.html">zonal</a></span><span class="op">(</span><span class="va">temp_north</span>, <span class="va">cover_north</span>, <span class="st">'mean'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">zone</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">'month'</span>, </span>
<span>               values_to <span class="op">=</span> <span class="st">'tmean'</span>, </span>
<span>               names_prefix <span class="op">=</span> <span class="st">'tmean'</span>,</span>
<span>               names_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>month <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hemisphere <span class="op">=</span> <span class="st">'north'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtemp_south_tidy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/zonal.html">zonal</a></span><span class="op">(</span><span class="va">temp_south</span>, <span class="va">cover_south</span>, <span class="st">'mean'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">zone</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">'month'</span>, </span>
<span>               values_to <span class="op">=</span> <span class="st">'tmean'</span>, </span>
<span>               names_prefix <span class="op">=</span> <span class="st">'tmean'</span>,</span>
<span>               names_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>month <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>hemisphere <span class="op">=</span> <span class="st">'south'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtemp_tidy2</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">mtemp_north_tidy</span>, <span class="va">mtemp_south_tidy</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cover <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">cover</span><span class="op">$</span><span class="va">cover</span><span class="op">)</span><span class="op">[</span><span class="va">zone</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mtemp_tidy2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">month</span>, y <span class="op">=</span> <span class="va">tmean</span>, color <span class="op">=</span> <span class="va">cover</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">pal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">hemisphere</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-14-1.png" width="100%"></div>
</div>
<div id="raster_global" class="section level3" number="15.2.4">
<h3>
<span class="header-section-number">15.2.4</span> Глобальные операции<a class="anchor" aria-label="anchor" href="#raster_global"><i class="fas fa-link"></i></a>
</h3>
<p>Глобальные операции охватывают все ячейки растра. По сути, можно говорить, что это частный случай зональной операции, когда зона одна и покрывает растр целиком. В пакете raster для расчета глобальных статистик можно использовать функцию <code><a href="https://rdrr.io/pkg/raster/man/cellStats.html">cellStats()</a></code>, передав ей название растра и агрегирующей функции:</p>
<div class="sourceCode" id="cb723"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/cellStats.html">cellStats</a></span><span class="op">(</span><span class="va">temp_north</span>, <span class="va">max</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/cellStats.html">cellStats</a></span><span class="op">(</span><span class="va">temp_south</span>, <span class="va">min</span><span class="op">)</span> </span></code></pre></div>
</div>
</div>
<div id="raster_extract" class="section level2" number="15.3">
<h2>
<span class="header-section-number">15.3</span> Извлечение данных<a class="anchor" aria-label="anchor" href="#raster_extract"><i class="fas fa-link"></i></a>
</h2>
<p>Растровая модель данных обеспечивает сплошное покрытие территории (с дискретностью, определяемой размером ячейки). В то же время, достаточно часто требуется получить значения растра в заданных местоположениях. Местоположения могут быть как конкретными объектами (например, точками почвенных разрезов), так и абстрактными географическими локациями, для которых известны координаты.</p>
<p>Для извлечения растровых данных можно воспользоваться функцией <code><a href="https://rdrr.io/pkg/terra/man/extract.html">extract()</a></code>. Получать данные можно как по координатам (записанным в фрейм данных), так и используя пространственные объекты класса <code>Spatial</code>. Например, узнаем мощность покровного оледенения в точке в центре Гренландии:</p>
<div class="sourceCode" id="cb724"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coords</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">-</span><span class="fl">45</span>, y <span class="op">=</span> <span class="fl">70</span><span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">ice.depth</span>, <span class="va">coords</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">bed</span>, </span>
<span>     breaks <span class="op">=</span> <span class="va">brks</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.colors.html">gray.colors</a></span><span class="op">(</span><span class="va">nclass</span><span class="op">)</span>,</span>
<span>     legend <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">ice.depth</span>, </span>
<span>     col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">cm.colors</a></span><span class="op">(</span><span class="fl">255</span><span class="op">)</span>,</span>
<span>     add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">coords</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">coords</span>, labels <span class="op">=</span> <span class="va">z</span>, pos <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-16-1.png" width="100%"></div>
<p>Одна из наиболее распространенных задач по извлечению растровых данных — это построение профиля вдоль заданной линии. Воспользуемся интерактивным редактором для проведения линии профиля</p>
<div class="sourceCode" id="cb725"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">tmean6</span><span class="op">)</span></span>
<span><span class="va">profile</span> <span class="op">=</span> <span class="fu">mapedit</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mapedit/man/drawFeatures.html">drawFeatures</a></span><span class="op">(</span><span class="va">mp</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="images/mapedit_profile.png" width="100%"></div>
<div class="sourceCode" id="cb726"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temprof</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">temp</span>, <span class="st">'Raster'</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">profile</span>, <span class="st">'Spatial'</span><span class="op">)</span>,</span>
<span>                          along <span class="op">=</span> <span class="cn">TRUE</span>, cellnumbers <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">temprof</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">##        cell tmean1 tmean2 tmean3 tmean4 tmean5 tmean6 tmean7 tmean8 tmean9</span></span>
<span><span class="co">## [1,] 252105  -26.1  -26.3  -22.4  -16.0   -7.3    1.8    8.0    7.8    2.6</span></span>
<span><span class="co">## [2,] 254265  -26.2  -26.4  -22.5  -16.1   -7.4    1.8    8.1    7.8    2.5</span></span>
<span><span class="co">## [3,] 256425  -26.2  -26.4  -22.4  -15.9   -7.2    1.9    8.3    8.0    2.7</span></span>
<span><span class="co">## [4,] 258585  -26.1  -26.4  -22.2  -15.7   -7.0    2.2    8.6    8.1    2.8</span></span>
<span><span class="co">## [5,] 260745  -26.2  -26.4  -22.1  -15.6   -7.0    2.3    8.8    8.2    2.9</span></span>
<span><span class="co">## [6,] 262905  -26.1  -26.3  -21.9  -15.4   -6.7    2.5    9.0    8.5    3.0</span></span>
<span><span class="co">##      tmean10 tmean11 tmean12</span></span>
<span><span class="co">## [1,]    -7.4   -17.9   -22.4</span></span>
<span><span class="co">## [2,]    -7.5   -18.0   -22.5</span></span>
<span><span class="co">## [3,]    -7.4   -18.0   -22.6</span></span>
<span><span class="co">## [4,]    -7.3   -17.9   -22.6</span></span>
<span><span class="co">## [5,]    -7.3   -17.9   -22.6</span></span>
<span><span class="co">## [6,]    -7.1   -17.9   -22.6</span></span></code></pre></div>
<p>Для построения линии профиля далее нам необходимо преобразовать идентификаторы ячеек растра в расстояние от начала профиля:</p>
<div class="sourceCode" id="cb727"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tempdf</span> <span class="op">=</span> <span class="va">temprof</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">[</span><span class="va">.</span><span class="op">$</span><span class="va">cell</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="fl">0.001</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                             <span class="fu">geosphere</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geosphere/man/distGeo.html">distGeo</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">cell</span>, <span class="va">band</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="va">tmean1</span><span class="op">:</span><span class="va">tmean12</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">'month'</span>, </span>
<span>               values_to <span class="op">=</span> <span class="st">'tmean'</span>, </span>
<span>               names_prefix <span class="op">=</span> <span class="st">'tmean'</span>,</span>
<span>               names_transform <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>month <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">x</span>,  ordered <span class="op">=</span> <span class="cn">TRUE</span>, levels <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pts</span> <span class="op">=</span> <span class="va">profile</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">'POINT'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'A'</span>, <span class="st">'B'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">band</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_raster.html">tm_raster</a></span><span class="op">(</span><span class="st">'tmean1'</span>, midpoint <span class="op">=</span> <span class="fl">0</span>, palette <span class="op">=</span> <span class="st">'-RdBu'</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">profile</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_lines.html">tm_lines</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_shape.html">tm_shape</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_symbols.html">tm_bubbles</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_text.html">tm_text</a></span><span class="op">(</span><span class="st">'label'</span>, remove.overlap <span class="op">=</span> <span class="cn">TRUE</span>, auto.placement <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/tmap/man/tm_layout.html">tm_layout</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'left'</span>, <span class="st">'bottom'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-21-1.png" width="100%"></div>
<div class="sourceCode" id="cb728"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">tempdf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># dplyr::filter(month == 7) %&gt;% </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dist</span>, y <span class="op">=</span> <span class="va">tmean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>span <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">'text'</span>, x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">10</span>, label <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">'text'</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">tempdf</span><span class="op">$</span><span class="va">dist</span><span class="op">)</span>, y <span class="op">=</span> <span class="fl">10</span>, label <span class="op">=</span> <span class="st">'B'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'Профиль среднемесячной температуры июня по линии A—B'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">month</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-21-2.png" width="100%"></div>
</div>
<div id="questions_tasks_raster" class="section level2" number="15.4">
<h2>
<span class="header-section-number">15.4</span> Контрольные вопросы и упражнения<a class="anchor" aria-label="anchor" href="#questions_tasks_raster"><i class="fas fa-link"></i></a>
</h2>
<div id="questions_raster" class="section level3" number="15.4.1">
<h3>
<span class="header-section-number">15.4.1</span> Вопросы<a class="anchor" aria-label="anchor" href="#questions_raster"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>Дайте описание локальных, фокальных, зональных и глобальных операций растровой алгебры. Приведите примеры использования данных типов операций.</li>
<li>Каким требованиям должна отвечать геометрия растров, участвующих в локальных и зональных операциях?</li>
<li>В чем заключается отличие фокальных операций с фиксированной и расширенной окрестностью?</li>
<li>Чем отличается геометрия растра до и после применения фокальной операции?</li>
<li>Какая функция пакета <strong>raster</strong> реализует возможности фокальной обработки растров?</li>
<li>Какой эффект оказывает сглаживающая фильтрация на значения растра?</li>
<li>Какие виды производных морфометрических величин позволяет получать функция <code><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain()</a></code> из пакета <strong>raster</strong>?</li>
<li>Какие два растра необходимо рассчитать для построения аналитической отмывки средствами функции <code><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain()</a></code>?</li>
<li>Опишите последовательность действий, которую необходимо выполнить для построения растра <strong>Евклидовых расстояний</strong> от заданных объектов?</li>
<li>Какой метод интерполяции необходимо использовать для передискретизации категориальных растров? В чем заключается принцип его действия?</li>
<li>Какая функция пакета <strong>raster</strong> используется для выполнения зональных операций? Какой тип результата она возвращает?</li>
<li>Опишите возможности функции <code><a href="https://rdrr.io/pkg/terra/man/extract.html">extract()</a></code> по извлечению информации из растровых данных. В какой формате можно задать анализируемые локации? Что будет результатом вызова этой функции в зависимости от формата входных данных?</li>
<li>Опишите последовательность действий, которую необходимо выполнить для построения профиля растровой поверхности средствами <strong>R</strong>.</li>
<li>Можно ли построить профиль по растру, имеющему привязку в географической системе координат (координаты выражены градусах)? Если да, то как добиться того, чтобы расстояния между точками профиля были посчитаны в метрических единицах?</li>
<li>Опишите способ, с помощью которого можно осуществить фильтрацию растра (превратить его в растр <code>TRUE</code>/<code>FALSE</code>) и маскирование растра (заменить ненужные ячейки на NA).</li>
</ol>
</div>
<div id="tasks_raster" class="section level3" number="15.4.2">
<h3>
<span class="header-section-number">15.4.2</span> Упражнения<a class="anchor" aria-label="anchor" href="#tasks_raster"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>В пакете <strong>tmap</strong> содержится растровый каталог <code>land</code>, включающий в себя растр <code>elevation</code>. Используя пакет <strong>mapedit</strong>, оцифруйте произвольную линию и постройте средствами <strong>ggplot</strong> профиль рельефа вдоль этой линии.</p></li>
<li>
<p><em>Индекс континентальности Хромова</em> рассчитывается по формуле <span class="math inline">\(K = (A - 5.4 \sin \phi)/A\)</span>, где <span class="math inline">\(A\)</span> — годовая амплитуда хода температуры, <span class="math inline">\(\phi\)</span> — широта точки. Используя данные <strong>WorldClim</strong>, рассчитайте растр индекса континентальности на территорию суши и нанесите его на карту средствами <strong>tmap</strong>.</p>
<blockquote>
<p><strong>Подсказка:</strong> используйте функцию <code><a href="https://rdrr.io/pkg/terra/man/xyCellFrom.html">xyFromCell()</a></code>, чтобы получить широты всех ячеек растра температур. Далее создайте новый растр и запишите в него широты в качестве значений. Растры минимальных и максимальных значений из стека растров можно получить, используя обычные статистические функции <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code> и <code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code>.</p>
</blockquote>
</li>
<li><p>Постройте растр, который содержит расстояние до береговой линии. Используйте данные <strong>Natural Earth</strong>. Задайте грубое разрешение растра, чтобы расчеты не производились долго (100 x 50 ячеек будет достаточно). Где находится самая удаленная от берега точка на суше? А самая удаленная точка на океане? Постройте карту, которая отображает полученный растр и береговую линию.</p></li>
<li><p>Рассчитайте морфометрические коэффициенты TPI, TRI и roughness для <a href="https://github.com/tsamsonov/r-geo-course/blob/master/data/dem_fergana.tif">цифровой модели рельефа Ферганской долины</a>, которая использовалась в текущей лекции. В чем их суть? Изучите справку к инструменту <code><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain()</a></code>.</p></li>
</ol>
<div class="inline-table"><table class="table table-sm"><tbody><tr class="odd">
<td>
<em>Самсонов Т.Е.</em> <strong>Визуализация и анализ географических данных на языке R.</strong> М.: Географический факультет МГУ, <code>lubridate::year(Sys.Date())</code>. DOI: <a href="https://doi.org/10.5281/zenodo.901911">10.5281/zenodo.901911</a>
</td>
</tr></tbody></table></div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="interp.html"><span class="header-section-number">14</span> Интерполяция геополей</a></div>
<div class="next"><a href="network.html"><span class="header-section-number">16</span> Анализ сетей и траекторий</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#raster"><span class="header-section-number">15</span> Растровый анализ</a></li>
<li><a class="nav-link" href="#%D0%BF%D1%80%D0%B5%D0%B4%D0%B2%D0%B0%D1%80%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%83%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D1%8F">Предварительные условия</a></li>
<li><a class="nav-link" href="#raster_intro"><span class="header-section-number">15.1</span> Введение</a></li>
<li>
<a class="nav-link" href="#%D1%80%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B2%D0%B0%D1%8F-%D0%B0%D0%BB%D0%B3%D0%B5%D0%B1%D1%80%D0%B0"><span class="header-section-number">15.2</span> Растровая алгебра</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#raster_local"><span class="header-section-number">15.2.1</span> Локальные операции</a></li>
<li><a class="nav-link" href="#raster_focal"><span class="header-section-number">15.2.2</span> Фокальные операции</a></li>
<li><a class="nav-link" href="#raster_zonal"><span class="header-section-number">15.2.3</span> Зональные операции</a></li>
<li><a class="nav-link" href="#raster_global"><span class="header-section-number">15.2.4</span> Глобальные операции</a></li>
</ul>
</li>
<li><a class="nav-link" href="#raster_extract"><span class="header-section-number">15.3</span> Извлечение данных</a></li>
<li>
<a class="nav-link" href="#questions_tasks_raster"><span class="header-section-number">15.4</span> Контрольные вопросы и упражнения</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#questions_raster"><span class="header-section-number">15.4.1</span> Вопросы</a></li>
<li><a class="nav-link" href="#tasks_raster"><span class="header-section-number">15.4.2</span> Упражнения</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/tsamsonov/r-geo-course/blob/master/15-RasterAnalysis.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/tsamsonov/r-geo-course/edit/master/15-RasterAnalysis.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Визуализация и анализ географических данных на языке R</strong>" was written by Тимофей Самсонов. It was last built on 2022-10-20.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
