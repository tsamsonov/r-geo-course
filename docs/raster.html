<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Глава 15 Растровый анализ | Визуализация и анализ географических данных на языке R</title>
<meta name="author" content="Тимофей Самсонов">
<meta name="description" content="Предварительные условия Для выполнения кода данной лекции вам понадобятся следующие пакеты: library(sf) library(stars) library(mapview) library(mapedit) library(classInt) library(geosphere)...">
<meta name="generator" content="bookdown 0.30 with bs4_book()">
<meta property="og:title" content="Глава 15 Растровый анализ | Визуализация и анализ географических данных на языке R">
<meta property="og:type" content="book">
<meta property="og:description" content="Предварительные условия Для выполнения кода данной лекции вам понадобятся следующие пакеты: library(sf) library(stars) library(mapview) library(mapedit) library(classInt) library(geosphere)...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Глава 15 Растровый анализ | Визуализация и анализ географических данных на языке R">
<meta name="twitter:site" content="@timofeysamsonov">
<meta name="twitter:description" content="Предварительные условия Для выполнения кода данной лекции вам понадобятся следующие пакеты: library(sf) library(stars) library(mapview) library(mapedit) library(classInt) library(geosphere)...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.1/transition.js"></script><script src="libs/bs3compat-0.4.1/tabs.js"></script><script src="libs/bs3compat-0.4.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.26/datatables.js"></script><link href="libs/dt-core-1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.12.1/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.12.1/js/jquery.dataTables.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/plotly-binding-4.10.1/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="default">
<link rel="stylesheet" href="custom.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Визуализация и анализ географических данных на языке R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Введение</a></li>
<li class="book-part">Основы языка R</li>
<li><a class="" href="basics.html"><span class="header-section-number">1</span> Типы данных</a></li>
<li><a class="" href="data-structures.html"><span class="header-section-number">2</span> Структуры данных</a></li>
<li><a class="" href="tables.html"><span class="header-section-number">3</span> Таблицы</a></li>
<li><a class="" href="controls.html"><span class="header-section-number">4</span> Функции</a></li>
<li class="book-part">Графика и статистика</li>
<li><a class="" href="graphics.html"><span class="header-section-number">5</span> Базовая графика</a></li>
<li><a class="" href="advgraphics.html"><span class="header-section-number">6</span> Продвинутая графика</a></li>
<li><a class="" href="stats.html"><span class="header-section-number">7</span> Основы статистики</a></li>
<li><a class="" href="temporal.html"><span class="header-section-number">8</span> Временные ряды</a></li>
<li class="book-part">Пространственные данные и карты</li>
<li><a class="" href="spatial.html"><span class="header-section-number">9</span> Пространственные данные</a></li>
<li><a class="" href="maps.html"><span class="header-section-number">10</span> Основы картографии</a></li>
<li><a class="" href="mapping.html"><span class="header-section-number">11</span> Тематические карты</a></li>
<li><a class="" href="three.html"><span class="header-section-number">12</span> Трехмерные модели</a></li>
<li class="book-part">Пространственный анализ</li>
<li><a class="" href="vector.html"><span class="header-section-number">13</span> Векторный анализ</a></li>
<li><a class="" href="interp.html"><span class="header-section-number">14</span> Интерполяция геополей</a></li>
<li><a class="active" href="raster.html"><span class="header-section-number">15</span> Растровый анализ</a></li>
<li><a class="" href="network.html"><span class="header-section-number">16</span> Анализ сетей и траекторий</a></li>
<li class="book-part">Решение проблем</li>
<li><a class="" href="package-troubles.html"><span class="header-section-number">A</span> Установка пакетов</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/tsamsonov/r-geo-course">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="raster" class="section level1" number="15">
<h1>
<span class="header-section-number">Глава 15</span> Растровый анализ<a class="anchor" aria-label="anchor" href="#raster"><i class="fas fa-link"></i></a>
</h1>
<div id="предварительные-условия" class="section level2 unnumbered">
<h2>Предварительные условия<a class="anchor" aria-label="anchor" href="#%D0%BF%D1%80%D0%B5%D0%B4%D0%B2%D0%B0%D1%80%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%83%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D1%8F"><i class="fas fa-link"></i></a>
</h2>
<p>Для выполнения кода данной лекции вам понадобятся следующие пакеты:</p>
<div class="sourceCode" id="cb723"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapview">mapview</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapedit">mapedit</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/classInt/">classInt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">geosphere</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dieghernan.github.io/tidyterra/">tidyterra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://eliocamp.github.io/ggnewscale/">ggnewscale</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div id="raster_intro" class="section level2" number="15.1">
<h2>
<span class="header-section-number">15.1</span> Введение<a class="anchor" aria-label="anchor" href="#raster_intro"><i class="fas fa-link"></i></a>
</h2>
<p>Растровая модель данных представляет собой мощный инструмент абстракции пространственных распределений и выполнения пространственного анализа. На первый взгляд, растр обладает целым рядом ограничений по сравнению с векторной моделью: не позволяет оперировать отдельными объектами, их границами и так далее. Растровые карты и снимки мы часто оцифровываем, выделяя объекты, чтобы на основе них можно было что-то посчитать. Самые первые ГИС были исключительно растровыми, что сейчас воспринимается как архаизм.</p>
<p>Однако за ширмой ограниченности растровой модели кроются огромные аналитические возможности. Растровая модель обладает внутренней топологией: ее ячейки соприкасаются друг с другом, что позволяет моделировать непрерывные в пространстве и динамические явления (при которых происходит перемещение вещества, энергии или информации в пространстве). Поскольку ячейки растра имеют одинаковый размер, к ним можно применять однотипные операции, которые будут давать предсказуемый результат вне зависимости от конкретной локации в пределах растра. Это также позволяет сделать обработку растра очень быстро.</p>
</div>
<div id="модель-растровых-данных-terra" class="section level2" number="15.2">
<h2>
<span class="header-section-number">15.2</span> Модель растровых данных terra<a class="anchor" aria-label="anchor" href="#%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C-%D1%80%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B2%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-terra"><i class="fas fa-link"></i></a>
</h2>
<p>Пакет terra содержит модели данных для растровых и векторных данных. Растровые данные создаются посредством функции <code>rast</code>:</p>
<div class="sourceCode" id="cb724"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Чтение данных</span></span>
<span><span class="op">(</span><span class="va">bed</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="st">'data/etopo1_bed.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 360, 720, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 0.5, 0.5  (x, y)</span></span>
<span><span class="co">## extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : lon/lat WGS 84 (EPSG:4326) </span></span>
<span><span class="co">## source      : etopo1_bed.tif </span></span>
<span><span class="co">## name        : etopo1_bed</span></span>
<span><span class="op">(</span><span class="va">ice</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="st">'data/etopo1_ice.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 360, 720, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 0.5, 0.5  (x, y)</span></span>
<span><span class="co">## extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : lon/lat WGS 84 (EPSG:4326) </span></span>
<span><span class="co">## source      : etopo1_ice.tif </span></span>
<span><span class="co">## name        : etopo1_ice</span></span></code></pre></div>
<div class="sourceCode" id="cb725"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bed</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_hypso.html">scale_fill_hypso_tint_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"gmt_globe"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'ETOPO Bedrock'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-3-1.png" width="100%"></div>
<div class="sourceCode" id="cb726"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ice</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_hypso.html">scale_fill_hypso_tint_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"gmt_globe"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'ETOPO Ice surface'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-3-2.png" width="100%"></div>
</div>
<div id="растровая-алгебра" class="section level2" number="15.3">
<h2>
<span class="header-section-number">15.3</span> Растровая алгебра<a class="anchor" aria-label="anchor" href="#%D1%80%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B2%D0%B0%D1%8F-%D0%B0%D0%BB%D0%B3%D0%B5%D0%B1%D1%80%D0%B0"><i class="fas fa-link"></i></a>
</h2>
<p>Существует классификация операций растрового анализа, введенная американским профессором Даной Томлином, которая объединяет их под общим названием “алгебра карт” или “растровая алгебра” <span class="citation">(<a href="package-troubles.html#ref-Tomlin2012" role="doc-biblioref">Tomlin 2012</a>)</span>. Предполагая, что обработке подвергается <em>каждая</em> ячейка растра, данная классификация разделяет все операции по охвату относительно текущей ячейки</p>
<ol style="list-style-type: decimal">
<li>
<em>Локальные</em> — анализируется одна ячейка растра или совпадающие в пространстве ячейки нескольких растров</li>
<li>
<em>Фокальные</em> — анализируются все ячейки в окрестности. Окрестность может быть как фиксированной, так и расширенной (expanded), когда ее размер управляется внешними факторами, например множеством объектов, до которых требуется вычислить расстояние. Информация по соседним ячейкам может быть как из исходного растра, так и из внешнего. Фокальные методы алгебры карт также называются <em>методами анализа соседства</em>.</li>
<li>
<em>Зональные</em> — анализируются все ячейки в пределах зон, определяемых извне (например, вторым растровым слоем).</li>
<li>
<em>Глобальные</em> — анализируются все ячейки растра.</li>
</ol>
<div id="raster_local" class="section level3" number="15.3.1">
<h3>
<span class="header-section-number">15.3.1</span> Локальные операции<a class="anchor" aria-label="anchor" href="#raster_local"><i class="fas fa-link"></i></a>
</h3>
<p>Локальные операции связаны с алгебраическими преобразованиями значений в ячейках. Например, цифровую модель высот в футах можно перевести в цифровую модель высот в метрах. Для этого нужно значение в каждой ячейке умножить на <span class="math inline">\(0.3048\)</span>. В локальных операциях могут участвовать несколько растров. Например, если у нас есть растровые поверхности плотности населения за разные года, мы можем вычесть одну поверхность из другой, чтобы получить поверхность изменений плотности, выяснить где она увеличилась, уменьшилась или осталось прежней. К локальным операциям относится также оверлей растров, при котором получается взвешенная сумма значений по нескольким растрам. И в том и в другом случае анализируются ячейки с нескольких растров, которые совпадают в пространстве.</p>
<p>В качестве примера определим мощность покровного оледенения в Антарктике и Гренландии, путем вычитание двух моделей <a href="https://www.ngdc.noaa.gov/mgg/global/">ETOPO1</a>, одна из которых показывает рельеф коренных пород (bedrock), а вторая — видимый рельеф поверхности (ice surface):</p>
<div class="sourceCode" id="cb727"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ЛОКАЛЬНЫЕ ОПЕРАЦИИ</span></span>
<span><span class="co"># Вычисление толщины покровного оледенения</span></span>
<span></span>
<span><span class="co">#  Береговая линия для ориентировки</span></span>
<span><span class="va">countries</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">'data/countries.gpkg'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># вычисление разности</span></span>
<span><span class="va">ice.depth</span> <span class="op">=</span> <span class="va">ice</span> <span class="op">-</span> <span class="va">bed</span></span>
<span><span class="va">ice.depth</span><span class="op">[</span><span class="va">ice.depth</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bed</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'black'</span>, high <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>                      guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://eliocamp.github.io/ggnewscale/reference/new_scale.html">new_scale_fill</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ice.depth</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'white'</span>, high <span class="op">=</span> <span class="st">'navyblue'</span>, </span>
<span>                      na.value <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">countries</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Мощность покровного оледенения'</span>,</span>
<span>         fill <span class="op">=</span> <span class="st">'[м]'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-4-1.png" width="100%"></div>
</div>
<div id="raster_focal" class="section level3" number="15.3.2">
<h3>
<span class="header-section-number">15.3.2</span> Фокальные операции<a class="anchor" aria-label="anchor" href="#raster_focal"><i class="fas fa-link"></i></a>
</h3>
<p>В фокальных операциях участвует не только сама ячейка или совпадающие с ней ячейки других растров, но также ячейки, находящиеся в некоторой окрестности (опять же, в одном или нескольких растрах одновременно). Данный вид анализа подразделяется на две категории: фокальный анализ с фиксированной окрестностью и с расширенной окрестностью.</p>
<div id="raster_focal_fixed" class="section level4" number="15.3.2.1">
<h4>
<span class="header-section-number">15.3.2.1</span> Фиксированная окрестность<a class="anchor" aria-label="anchor" href="#raster_focal_fixed"><i class="fas fa-link"></i></a>
</h4>
<p>В общем случае фиксированная окрестность может иметь различную форму, однако наиболее часто используется квадратная окрестность размером <span class="math inline">\(3\times3\)</span>:</p>
<div class="figure">
<span style="display:block;" id="fig:unnamed-chunk-5"></span>
<img src="images/raster_neighborhoods.png" alt="Виды растровых окрестностей. Темной точкой выделена анализируемая ячейка" width="100%"><p class="caption">
Рис. 15.1: Виды растровых окрестностей. Темной точкой выделена анализируемая ячейка
</p>
</div>
<p>Фокальные операции с фиксированной окрестностью — привычное дело в обработке изображений. Они работают по принципу “плавающего окна”. Выбранная окрестность (квадратная, круглая и т.д.) представляется в виде матрицы коэффициентов — так называемого ядра свёртки (convolution kernel). Далее эта матрица перемещается, позиционируясь последовательно над каждой ячейкой растра, и значение в этой ячейке заменяется на взвешенную сумму значений ячеек в окрестности, умноженных на соответствующие коэффициенты ядра свертки. Например, если ядро состоит из единиц, то будет посчитана обычная сумма.</p>
<p>С помощью фокального анализа можно выполнить сглаживание изображения, которое убирает из него мелкие детали (высокочастотные составляющие яркостного сигнала). В качестве такого изображения может быть цифровая модель рельефа или космический снимок. Чтобы выполнить сглаживание, коэффициенты должны быть такими, чтобы получаемая взвешенная сумма осредняла значения в соседних ячейках. Самый простой вариант — это рассчитать среднее арифметическое. В этом случае коэффициенты ядра свертки будут равны <span class="math inline">\(1/k\)</span>, где <span class="math inline">\(k\)</span> — количество ячеек в окрестности. Для матрицы <span class="math inline">\(3\times3\)</span> они будут равны, соответственно <span class="math inline">\(1/9\)</span>:</p>
<div class="sourceCode" id="cb728"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ФОКАЛЬНЫЕ ОПЕРАЦИИ</span></span>
<span></span>
<span><span class="co"># Вырежем кусок из ЦМР</span></span>
<span><span class="va">dem</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">ice</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html">ext</a></span><span class="op">(</span><span class="op">-</span><span class="fl">120</span>, <span class="op">-</span><span class="fl">75</span>, <span class="fl">10</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">dem</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-6-1.png" width="100%"></div>
<div class="sourceCode" id="cb729"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Среднее</span></span>
<span><span class="va">wgt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>               <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>               <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">9</span>, </span>
<span>              nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co"># на самом деле проще написать так:</span></span>
<span><span class="co"># wgt = matrix(1/9, 3, 3), но полная форма записана для наглядности</span></span>
<span></span>
<span><span class="co"># выполним обработку ЦМР с помощью фокального фильтра</span></span>
<span><span class="va">filtered</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/focal.html">focal</a></span><span class="op">(</span><span class="va">dem</span>, w <span class="op">=</span> <span class="va">wgt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">filtered</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_hypso.html">scale_fill_hypso_tint_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"etopo1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-6-2.png" width="100%"></div>
<p>Более мягким эффектом сглаживания, который к тому же не нарушает дифференцируемость поверхности, является гауссово сглаживание. Коэффициенты в матрице Гаусса убывают от центральной ячейки к краям матрицы по закону Гаусса-Лапласа, что позволяет придать центральной ячейке более высокий вес по сравнению с ячейками, располагающимися на краю анализируемой окрестности:</p>
<div class="sourceCode" id="cb730"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Гауссово (параметр 0.5 - это стандартное отклонение в единицах измерения растра)</span></span>
<span><span class="va">wgt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/focalMat.html">focalMat</a></span><span class="op">(</span><span class="va">dem</span>, <span class="fl">0.5</span>, <span class="st">"Gauss"</span><span class="op">)</span></span>
<span><span class="va">filtered</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/focal.html">focal</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">wgt</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">filtered</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_hypso.html">scale_fill_hypso_tint_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"etopo1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">lyr</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-7-1.png" width="100%"></div>
<p>Еще одна интересная область применения фильтрации — это обнаружение границ (change detection). Границы на изображении возникают в тех местах, где его яркость резко меняет свое значение (в одном или нескольких каналах). Например, на фотографии контур лица может быть распознан по перепаду яркости между его изображением и фоном (если он имеет существенно отличный цвет). Поскольку перепад яркости соответствует экстремальным значениям производной поверхности (отрицательным или положительным), его также можно определить путем фокального анализа, а затем отсечь ячейки растра, в которых значение этой производной по модулю превышает заданный порог (то есть, имеет необходимый контраст).</p>
<p>Рассмотрим, как можно выделить уступы континентального склона океана путем применения фильтра Собеля для выделения границ:</p>
<div class="sourceCode" id="cb731"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Матрица Собеля:</span></span>
<span><span class="va">wgt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span>,</span>
<span>                <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>,</span>
<span>               <span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">2</span>,<span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">4</span>, </span>
<span>              nrow<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">filtered</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/focal.html">focal</a></span><span class="op">(</span><span class="va">dem</span>, <span class="va">wgt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Это поверхность производных:</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">filtered</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'navyblue'</span>, high <span class="op">=</span> <span class="st">'darkred'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'Производная поверхности'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-8-1.png" width="100%"></div>
<div class="sourceCode" id="cb732"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Отберем все ячейки, обладающие высокими значениями производных</span></span>
<span><span class="va">faults</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">filtered</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1500</span></span>
<span><span class="va">faults</span><span class="op">[</span><span class="va">faults</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dem</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_hypso.html">scale_fill_hypso_tint_c</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"etopo1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggnewscale</span><span class="fu">::</span><span class="fu"><a href="https://eliocamp.github.io/ggnewscale/reference/new_scale.html">new_scale_fill</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">faults</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_fill_discrete</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">'black'</span>, na.value <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-8-2.png" width="100%"></div>
<p>Еще один распространенный случай использования фокальных операций — это морфометрический анализ поверхностей. Квадратная окрестность <span class="math inline">\(3\times3\)</span> вокруг каждой ячейки формирует локальную поверхность, производные которой дают представление об уклоне, экспозиции и прочих морфометрических параметрах. Их можно вычислить с помощью функции <code><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain()</a></code> из пакета <code>raster</code>:</p>
<div class="sourceCode" id="cb733"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Морфометрия рельефа — фиксированное соседство</span></span>
<span><span class="va">dem</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="st">'data/dem_fergana.tif'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dem</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/scale_hypso.html">scale_fill_hypso_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Ферганская долина'</span>, fill <span class="op">=</span> <span class="st">'Высота, [м]'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-9-1.png" width="100%"></div>
<div class="sourceCode" id="cb734"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># углы наклона</span></span>
<span><span class="va">slope</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain</a></span><span class="op">(</span><span class="va">dem</span>, <span class="st">'slope'</span>, unit <span class="op">=</span> <span class="st">'degrees'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">slope</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'lightcyan'</span>, high <span class="op">=</span> <span class="st">'darkred'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Углы наклона'</span>, fill <span class="op">=</span> <span class="st">'Градусы [°]'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-9-2.png" width="100%"></div>
<div class="sourceCode" id="cb735"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># экспозиция</span></span>
<span><span class="va">aspect</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain</a></span><span class="op">(</span><span class="va">dem</span>, <span class="st">'aspect'</span>, unit <span class="op">=</span> <span class="st">'degrees'</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">aspect</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span><span class="op">(</span>colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span>, values <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">8</span> <span class="op">/</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Экспозиция'</span>, fill <span class="op">=</span> <span class="st">'Градусы [°]'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-9-3.png" width="100%"></div>
<p>Вычисление производных поверхности позволяет не только исследовать рельеф, но также строить его изображения. Например, хорошо знакомую всем по картам аналитическую отмывку рельефа (<em>hillshade</em>). Яркость поверхности в этом способе изображения зависит от угла между направлением на источник освещения (откуда светит Солнце) и нормалью к поверхности. Нормаль можно вычислить как напрямую через производные поверхности, так и восстановить на основе значений угла наклона и экспозиции в точке, что и используется в пакете <strong>raster</strong>. Обратите внимание на то, что для того чтобы повысить наглядность (контрастность) изображения, мы умножаем высоты рельефа на 20. Это стандартная практика для мелкомасштабных карт:</p>
<div class="sourceCode" id="cb736"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># отмывка</span></span>
<span><span class="va">slope_rad10</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain</a></span><span class="op">(</span><span class="va">dem</span> <span class="op">*</span> <span class="fl">10</span>, <span class="st">'slope'</span>, </span>
<span>                 unit <span class="op">=</span> <span class="st">'radians'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope_rad5</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain</a></span><span class="op">(</span><span class="va">dem</span> <span class="op">*</span> <span class="fl">5</span>, <span class="st">'slope'</span>, </span>
<span>                 unit <span class="op">=</span> <span class="st">'radians'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">aspect_tad</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain</a></span><span class="op">(</span><span class="va">dem</span>, <span class="st">'aspect'</span>, </span>
<span>                  unit <span class="op">=</span> <span class="st">'radians'</span><span class="op">)</span></span>
<span>                 </span>
<span><span class="co"># параметры angle и direction функции hillShade определяют азимут и высоту источника освещения:</span></span>
<span></span>
<span><span class="va">hill</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/shade.html">shade</a></span><span class="op">(</span><span class="va">slope_rad10</span>, <span class="va">aspect_tad</span>, angle <span class="op">=</span> <span class="fl">45</span>, direction <span class="op">=</span> <span class="fl">315</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hill_vert</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/shade.html">shade</a></span><span class="op">(</span><span class="va">slope_rad5</span>, <span class="va">aspect_tad</span>, angle <span class="op">=</span> <span class="fl">90</span>, direction <span class="op">=</span> <span class="fl">315</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hill_comb</span> <span class="op">=</span> <span class="va">hill</span> <span class="op">*</span> <span class="va">hill_vert</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">hill</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'black'</span>, high <span class="op">=</span> <span class="st">'white'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'Отмывка классическая'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-10-1.png" width="100%"></div>
<div class="sourceCode" id="cb737"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">hill_vert</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'black'</span>, high <span class="op">=</span> <span class="st">'white'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'Отмывка отвесная'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-10-2.png" width="100%"></div>
<div class="sourceCode" id="cb738"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">hill_comb</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'black'</span>, high <span class="op">=</span> <span class="st">'white'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'Отмывка комбинированная'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-10-3.png" width="100%"></div>
</div>
<div id="raster_focal_extended" class="section level4" number="15.3.2.2">
<h4>
<span class="header-section-number">15.3.2.2</span> Расширенная окрестность<a class="anchor" aria-label="anchor" href="#raster_focal_extended"><i class="fas fa-link"></i></a>
</h4>
<p>Расширенность окрестности означает, что она определяется не фиксированным шаблоном, а условием, которое должно выполниться для того, чтобы анализ в ячейке считался выполненным. Типичный пример анализа на основе расширенной окрестности — это операции, основанные на вычислении расстояний на растровой матрице, такие как аллокация, определение кратчайшего пути на поверхности сопротивления, и собственно, само вычисление расстояние.</p>
<p>В мелкомасштабных тематических атласах часто можно встретить карты доступности той или иной географической локации, которые в форме изолиний показывают время движения до ближайшего населенного пункта. Эти изолинии можно построить по растровой поверхности, в каждой ячейке которой зафиксировано расстояние до ближайшего населенного пункта.</p>
<p>Рассмотрим построение аналогичной поверхности на примере доступности станций метро (по расстоянию). Для этого нам понадобится представить растр в виде матрицы точек, рассчитать для этих точек расстояния до ближайших станций метро и присвоить эти значения выходному растру:</p>
<div class="sourceCode" id="cb739"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Определение Евклидовых расстояний — расширенное соседство</span></span>
<span></span>
<span><span class="co"># Чтение данных</span></span>
<span><span class="va">roads</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/roads.gpkg"</span><span class="op">)</span> <span class="co"># Дороги</span></span>
<span><span class="va">poi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/poi_point.gpkg"</span><span class="op">)</span> <span class="co"># Точки интереса</span></span>
<span><span class="va">rayons</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/boundary_polygon.gpkg"</span><span class="op">)</span> <span class="co"># Границы районов</span></span>
<span><span class="va">stations</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/metro_stations.gpkg"</span><span class="op">)</span> <span class="co"># Станции метро</span></span>
<span><span class="va">water</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="st">"data/water_polygon.gpkg"</span><span class="op">)</span> <span class="co"># Водные объекты</span></span>
<span></span>
<span><span class="va">dist_grid</span> <span class="op">=</span> <span class="va">stations</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rasterize.html">rasterize</a></span><span class="op">(</span><span class="va">stations</span>, y <span class="op">=</span> <span class="va">_</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/gridDist.html">gridDist</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Визуализируем результат</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spat_contour.html">geom_spatraster_contour_filled</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dist_grid</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spat_contour.html">geom_spatraster_contour</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dist_grid</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span>, color <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">water</span>, linewidth <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">roads</span>, linewidth <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">stations</span>, color <span class="op">=</span> <span class="st">'darkviolet'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Расстояние до ближайшей станции метро'</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">'м'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-11-1.png" width="100%"></div>
</div>
</div>
<div id="raster_zonal" class="section level3" number="15.3.3">
<h3>
<span class="header-section-number">15.3.3</span> Зональные операции<a class="anchor" aria-label="anchor" href="#raster_zonal"><i class="fas fa-link"></i></a>
</h3>
<p><strong>Зональные операции</strong> связаны с агрегированием растровых данных по площадным зонам. В пределах каждой зоны вычисляется одна или несколько характеристик значений анализируемого растра: среднее, максимум и т.д. Как правило, зоны задаются в виде вспомогательного растрового или векторного набора данных. В случае растра каждая ячейка должна содержать идентификатор (номер) зоны, к которой она относится. Совокупность ячеек, имеющих одинаковый идентификатор, определяет территорию, которую покрывает зона с этим идентификатором. Если зоны представлены векторным набором пространственных объектов, то каждый объект (полигон) также должен иметь собственный идентификатор. Теоретически в одном наборе данных может быть несколько пространственно не связанных объектов, относящихся к одной зоне (например, зона экваториального климата состоит из трех ареалов). В этом случае агрегирование данных будет произведено сразу по трем полигонам. Таким образом, количество получаемых в результате зональной статистики значений определяется количеством зон, но может не совпадать с общим количеством полигонов, которыми эти зоны представлены.</p>
<p>В качестве примера рассмотрим вычисление среднеклиматических параметров <em>WorldClim</em> в пределах различных типов земельного покрова (Land Cover), которые доступны в пакете <strong>tmap</strong>:</p>
<div class="sourceCode" id="cb740"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp</span> <span class="op">=</span> <span class="fu">geodata</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geodata/man/worldclim.html">worldclim_global</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"tavg"</span>, res <span class="op">=</span> <span class="fl">10</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">land</span>, package <span class="op">=</span> <span class="st">'tmap'</span><span class="op">)</span></span>
<span><span class="va">terraland</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">land</span><span class="op">[</span><span class="st">'cover'</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pal</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#003200"</span>, <span class="st">"#3C9600"</span>, <span class="st">"#006E00"</span>, <span class="st">"#556E19"</span>, <span class="st">"#00C800"</span>, <span class="st">"#8CBE8C"</span>,</span>
<span>           <span class="st">"#467864"</span>, <span class="st">"#B4E664"</span>, <span class="st">"#9BC832"</span>, <span class="st">"#EBFF64"</span>, <span class="st">"#F06432"</span>, <span class="st">"#9132E6"</span>,</span>
<span>           <span class="st">"#E664E6"</span>, <span class="st">"#9B82E6"</span>, <span class="st">"#B4FEF0"</span>, <span class="st">"#646464"</span>, <span class="st">"#C8C8C8"</span>, <span class="st">"#FF0000"</span>,</span>
<span>           <span class="st">"#FFFFFF"</span>, <span class="st">"#5ADCDC"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">terraland</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">pal</span>, guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, name <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-12-1.png" width="100%"></div>
<p>Предварительно необходимо убедиться, что оба растра имеют совпадающий охват (экстент) и пространственное разрешение. Обратите внимание на то, что, поскольку растр земельного покрова категориальный, для его передискретизации необходимо использовать метод ближайшего соседа (<em>Nearest Neighbor</em>), который для каждого пиксела нового растра берет значение в ближайшем к нему пикселе исходного растра:</p>
<div class="sourceCode" id="cb741"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp</span></span>
<span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 1080, 2160, 12  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 0.1666667, 0.1666667  (x, y)</span></span>
<span><span class="co">## extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : lon/lat WGS 84 (EPSG:4326) </span></span>
<span><span class="co">## sources     : wc2.1_10m_tavg_01.tif  </span></span>
<span><span class="co">##               wc2.1_10m_tavg_02.tif  </span></span>
<span><span class="co">##               wc2.1_10m_tavg_03.tif  </span></span>
<span><span class="co">##               ... and 9 more source(s)</span></span>
<span><span class="co">## names       : wc2.1~vg_01, wc2.1~vg_02, wc2.1~vg_03, wc2.1~vg_04, wc2.1~vg_05, wc2.1~vg_06, ... </span></span>
<span><span class="co">## min values  :    -45.8840,   -44.80000,   -57.92575,   -64.19250,   -64.81150,   -64.35825, ... </span></span>
<span><span class="co">## max values  :     34.0095,    32.82425,    32.90950,    34.19375,    36.25325,    38.35550, ...</span></span>
<span><span class="va">terraland</span></span>
<span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 540, 1080, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 0.3333333, 0.3333333  (x, y)</span></span>
<span><span class="co">## extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : +proj=longlat +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +no_defs </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## categories  : label </span></span>
<span><span class="co">## name        :                      lyr.1 </span></span>
<span><span class="co">## min value   : Broadleaf Evergreen Forest </span></span>
<span><span class="co">## max value   :               Water bodies</span></span>
<span></span>
<span><span class="op">(</span><span class="va">cover</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/project.html">project</a></span><span class="op">(</span><span class="va">terraland</span>, <span class="va">temp</span>, method <span class="op">=</span> <span class="st">'near'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## class       : SpatRaster </span></span>
<span><span class="co">## dimensions  : 1080, 2160, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co">## resolution  : 0.1666667, 0.1666667  (x, y)</span></span>
<span><span class="co">## extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">## coord. ref. : lon/lat WGS 84 (EPSG:4326) </span></span>
<span><span class="co">## source(s)   : memory</span></span>
<span><span class="co">## categories  : label </span></span>
<span><span class="co">## name        :                      lyr.1 </span></span>
<span><span class="co">## min value   : Broadleaf Evergreen Forest </span></span>
<span><span class="co">## max value   :               Water bodies</span></span>
<span><span class="co"># используем 'near', поскольку растр категориальный</span></span></code></pre></div>
<p>Для вычисления средней температуры за каждый месяц в пределах каждой зоны земельного покрова выполним следующую последовательность действий:</p>
<div class="sourceCode" id="cb742"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stats</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/zonal.html">zonal</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">cover</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html">head</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span>
<span><span class="co">##                         lyr.1 wc2.1_10m_tavg_01 wc2.1_10m_tavg_02</span></span>
<span><span class="co">## 1  Broadleaf Evergreen Forest        23.5782137        23.8492299</span></span>
<span><span class="co">## 2  Broadleaf Deciduous Forest         0.5019552         2.0665998</span></span>
<span><span class="co">## 3 Needleleaf Evergreen Forest       -11.7157410        -9.8924234</span></span>
<span><span class="co">## 4 Needleleaf Deciduous Forest       -25.9428218       -22.8029979</span></span>
<span><span class="co">## 5                Mixed Forest       -14.7891522       -12.3889821</span></span>
<span><span class="co">## 6                   Tree Open        -0.7002717         0.8318519</span></span>
<span><span class="co">##   wc2.1_10m_tavg_03 wc2.1_10m_tavg_04 wc2.1_10m_tavg_05 wc2.1_10m_tavg_06</span></span>
<span><span class="co">## 1         24.162432         24.232968         23.998414          23.42082</span></span>
<span><span class="co">## 2          6.017629         11.021756         15.056588          17.97374</span></span>
<span><span class="co">## 3         -4.084735          2.387608          8.726566          14.34026</span></span>
<span><span class="co">## 4        -15.169831         -5.111337          4.186215          11.81849</span></span>
<span><span class="co">## 5         -6.124290          1.950279          8.925499          14.36811</span></span>
<span><span class="co">## 6          4.560077          9.107631         13.256367          16.56003</span></span>
<span><span class="co">##   wc2.1_10m_tavg_07 wc2.1_10m_tavg_08 wc2.1_10m_tavg_09 wc2.1_10m_tavg_10</span></span>
<span><span class="co">## 1          23.12427          23.55343         23.934943         24.119599</span></span>
<span><span class="co">## 2          19.47548          18.93909         16.137864         11.575879</span></span>
<span><span class="co">## 3          17.06335          15.17327         10.227151          3.330671</span></span>
<span><span class="co">## 4          14.99470          12.45082          5.860229         -4.079028</span></span>
<span><span class="co">## 5          16.84991          15.02540          9.722261          2.786417</span></span>
<span><span class="co">## 6          18.08441          17.22145         14.473682          9.889385</span></span>
<span><span class="co">##   wc2.1_10m_tavg_11 wc2.1_10m_tavg_12</span></span>
<span><span class="co">## 1         23.943348        23.6360025</span></span>
<span><span class="co">## 2          5.903911         1.9374914</span></span>
<span><span class="co">## 3         -4.505279        -9.4876591</span></span>
<span><span class="co">## 4        -16.345332       -23.2874576</span></span>
<span><span class="co">## 5         -5.693239       -12.0065982</span></span>
<span><span class="co">## 6          4.082941         0.6377923</span></span>
<span></span>
<span><span class="va">zonal_stats</span> <span class="op">=</span> <span class="va">stats</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cover <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">cover</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">'month'</span>, values_to <span class="op">=</span> <span class="st">'tavg'</span>, </span>
<span>               names_prefix <span class="op">=</span> <span class="st">'wc2.1_10m_tavg_'</span>, </span>
<span>               names_transform <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">ordered</a></span><span class="op">(</span><span class="va">month</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="va">month.abb</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html">head</a></span><span class="op">(</span><span class="va">zonal_stats</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 6 × 3</span></span>
<span><span class="co">##   cover                      month  tavg</span></span>
<span><span class="co">##   &lt;chr&gt;                      &lt;ord&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1 Broadleaf Evergreen Forest Jan    23.6</span></span>
<span><span class="co">## 2 Broadleaf Evergreen Forest Feb    23.8</span></span>
<span><span class="co">## 3 Broadleaf Evergreen Forest Mar    24.2</span></span>
<span><span class="co">## 4 Broadleaf Evergreen Forest Apr    24.2</span></span>
<span><span class="co">## 5 Broadleaf Evergreen Forest May    24.0</span></span>
<span><span class="co">## 6 Broadleaf Evergreen Forest Jun    23.4</span></span></code></pre></div>
<p>Визуализируем полученные результаты:</p>
<div class="sourceCode" id="cb743"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">zonal_stats</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">month</span>, y <span class="op">=</span> <span class="va">tavg</span>, </span>
<span>                color <span class="op">=</span> <span class="va">cover</span>, group <span class="op">=</span> <span class="va">cover</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">pal</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-15-1.png" width="100%"></div>
<p>Перед вычислением целесообразно разделить растр землепользования на северное и южное полушарие (т.к. ход температур в них противоположный):</p>
<div class="sourceCode" id="cb744"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">cover_north</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">cover</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html">ext</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="fl">180</span>, <span class="fl">0</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cover_south</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">cover</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html">ext</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="fl">180</span>, <span class="op">-</span><span class="fl">60</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">temp_north</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">temp</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html">ext</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="fl">180</span>, <span class="fl">0</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">temp_south</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html">crop</a></span><span class="op">(</span><span class="va">temp</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/ext.html">ext</a></span><span class="op">(</span><span class="op">-</span><span class="fl">180</span>, <span class="fl">180</span>, <span class="op">-</span><span class="fl">60</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtemp_north_tidy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/zonal.html">zonal</a></span><span class="op">(</span><span class="va">temp_north</span>, <span class="va">cover_north</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cover <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">cover</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">'month'</span>, values_to <span class="op">=</span> <span class="st">'tavg'</span>, </span>
<span>               names_prefix <span class="op">=</span> <span class="st">'wc2.1_10m_tavg_'</span>, </span>
<span>               names_transform <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">ordered</a></span><span class="op">(</span><span class="va">month</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="va">month.abb</span><span class="op">)</span>,</span>
<span>         hemisphere <span class="op">=</span> <span class="st">'north'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtemp_south_tidy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/zonal.html">zonal</a></span><span class="op">(</span><span class="va">temp_south</span>, <span class="va">cover_south</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>cover <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">cover</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">'month'</span>, values_to <span class="op">=</span> <span class="st">'tavg'</span>, </span>
<span>               names_prefix <span class="op">=</span> <span class="st">'wc2.1_10m_tavg_'</span>, </span>
<span>               names_transform <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">ordered</a></span><span class="op">(</span><span class="va">month</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="va">month.abb</span><span class="op">)</span>,</span>
<span>         hemisphere <span class="op">=</span> <span class="st">'south'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtemp_tidy2</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">mtemp_north_tidy</span>, <span class="va">mtemp_south_tidy</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mtemp_tidy2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">month</span>, y <span class="op">=</span> <span class="va">tavg</span>, </span>
<span>                color <span class="op">=</span> <span class="va">cover</span>, group <span class="op">=</span> <span class="va">cover</span><span class="op">)</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">pal</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">hemisphere</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-16-1.png" width="100%"></div>
</div>
<div id="raster_global" class="section level3" number="15.3.4">
<h3>
<span class="header-section-number">15.3.4</span> Глобальные операции<a class="anchor" aria-label="anchor" href="#raster_global"><i class="fas fa-link"></i></a>
</h3>
<p>Глобальные операции охватывают все ячейки растра. По сути, можно говорить, что это частный случай зональной операции, когда зона одна и покрывает растр целиком. В пакете raster для расчета глобальных статистик можно использовать функцию <code><a href="https://rdrr.io/pkg/terra/man/global.html">global()</a></code>, передав ей название растра и агрегирующей функции:</p>
<div class="sourceCode" id="cb745"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/global.html">global</a></span><span class="op">(</span><span class="va">temp_north</span>, <span class="va">max</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/global.html">global</a></span><span class="op">(</span><span class="va">temp_south</span>, <span class="va">min</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> </span></code></pre></div>
</div>
</div>
<div id="raster_extract" class="section level2" number="15.4">
<h2>
<span class="header-section-number">15.4</span> Извлечение данных<a class="anchor" aria-label="anchor" href="#raster_extract"><i class="fas fa-link"></i></a>
</h2>
<p>Растровая модель данных обеспечивает сплошное покрытие территории (с дискретностью, определяемой размером ячейки). В то же время, достаточно часто требуется получить значения растра в заданных местоположениях. Местоположения могут быть как конкретными объектами (например, точками почвенных разрезов), так и абстрактными географическими локациями, для которых известны координаты.</p>
<p>Для извлечения растровых данных можно воспользоваться функцией <code><a href="https://tidyr.tidyverse.org/reference/extract.html">extract()</a></code>. Получать данные можно как по координатам (записанным в фрейм данных), так и используя пространственные объекты класса <code>Spatial</code>. Например, узнаем мощность покровного оледенения в точке в центре Гренландии:</p>
<div class="sourceCode" id="cb746"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pnt</span> <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="op">-</span><span class="fl">45</span>, y <span class="op">=</span> <span class="fl">70</span>,</span>
<span>  z <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">ice.depth</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">bed</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'black'</span>, high <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>                      guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://eliocamp.github.io/ggnewscale/reference/new_scale.html">new_scale_fill</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ice.depth</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'white'</span>, high <span class="op">=</span> <span class="st">'navyblue'</span>, </span>
<span>                      na.value <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, <span class="va">pnt</span>, size <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, label <span class="op">=</span> <span class="va">z</span><span class="op">)</span>, <span class="va">pnt</span>, fontface <span class="op">=</span> <span class="st">'bold'</span>,</span>
<span>            vjust <span class="op">=</span> <span class="st">'bottom'</span>, hjust <span class="op">=</span> <span class="st">'left'</span>,</span>
<span>            nudge_x <span class="op">=</span> <span class="fl">3</span>, nudge_y <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Мощность покровного оледенения'</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">'[м]'</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure">
<img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-18-1.png" width="100%">
Одна из наиболее распространенных задач по извлечению растровых данных — это построение профиля вдоль заданной линии. Воспользуемся интерактивным редактором для проведения линии профиля</div>
<div class="sourceCode" id="cb747"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">tmean6</span><span class="op">)</span></span>
<span><span class="va">profile</span> <span class="op">=</span> <span class="fu">mapedit</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mapedit/man/drawFeatures.html">drawFeatures</a></span><span class="op">(</span><span class="va">mp</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="images/mapedit_profile.png" width="100%"></div>
<div class="sourceCode" id="cb748"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temprof</span> <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">temp</span>, <span class="va">profile</span>, cells <span class="op">=</span> <span class="cn">TRUE</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Для построения линии профиля далее нам необходимо преобразовать идентификаторы ячеек растра в расстояние от начала профиля:</p>
<div class="sourceCode" id="cb749"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tempdf</span> <span class="op">=</span> <span class="va">temprof</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="fl">0.001</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>                             <span class="fu">geosphere</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geosphere/man/distGeo.html">distGeo</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>                             <span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html">head</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">cell</span>, <span class="va">ID</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">dist</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">'month'</span>, values_to <span class="op">=</span> <span class="st">'tavg'</span>, </span>
<span>               names_prefix <span class="op">=</span> <span class="st">'wc2.1_10m_tavg_'</span>, </span>
<span>               names_transform <span class="op">=</span> <span class="va">as.integer</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pts</span> <span class="op">=</span> <span class="va">profile</span> <span class="op">|&gt;</span>   </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="st">'POINT'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'A'</span>, <span class="st">'B'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://dieghernan.github.io/tidyterra/reference/geom_spatraster.html">geom_spatraster</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">temp</span><span class="op">$</span><span class="va">wc2.1_10m_tavg_07</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">'navyblue'</span>, </span>
<span>                       mid <span class="op">=</span> <span class="st">'khaki'</span>, </span>
<span>                       high <span class="op">=</span> <span class="st">'orangered'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">profile</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pts</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_text_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, label <span class="op">=</span> <span class="va">label</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-23-1.png" width="100%"></div>
<div class="sourceCode" id="cb750"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">tempdf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dist</span>, y <span class="op">=</span> <span class="va">tavg</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>span <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">'text'</span>, x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">10</span>, label <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">'text'</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">tempdf</span><span class="op">$</span><span class="va">dist</span><span class="op">)</span>, y <span class="op">=</span> <span class="fl">10</span>, label <span class="op">=</span> <span class="st">'B'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">'Профиль среднемесячной температуры июня по линии A—B'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">month</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="15-RasterAnalysis_files/figure-html/unnamed-chunk-23-2.png" width="100%"></div>
</div>
<div id="temporal_review" class="section level2" number="15.5">
<h2>
<span class="header-section-number">15.5</span> Краткий обзор<a class="anchor" aria-label="anchor" href="#temporal_review"><i class="fas fa-link"></i></a>
</h2>
<p>Для просмотра презентации щелкните на ней один раз левой кнопкой мыши и листайте, используя кнопки на клавиатуре:
<iframe src="https://tsamsonov.github.io/r-geo-course-slides/15_Raster.html#1" width="100%" height="390px" data-external="1"></iframe></p>
<blockquote>
<p>Презентацию можно открыть в отдельном окне или вкладке браузере. Для этого щелкните по ней правой кнопкой мыши и выберите соответствующую команду.</p>
</blockquote>
</div>
<div id="questions_tasks_raster" class="section level2" number="15.6">
<h2>
<span class="header-section-number">15.6</span> Контрольные вопросы и упражнения<a class="anchor" aria-label="anchor" href="#questions_tasks_raster"><i class="fas fa-link"></i></a>
</h2>
<div id="questions_raster" class="section level3" number="15.6.1">
<h3>
<span class="header-section-number">15.6.1</span> Вопросы<a class="anchor" aria-label="anchor" href="#questions_raster"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>Дайте описание локальных, фокальных, зональных и глобальных операций растровой алгебры. Приведите примеры использования данных типов операций.</li>
<li>Каким требованиям должна отвечать геометрия растров, участвующих в локальных и зональных операциях?</li>
<li>В чем заключается отличие фокальных операций с фиксированной и расширенной окрестностью?</li>
<li>Чем отличается геометрия растра до и после применения фокальной операции?</li>
<li>Какая функция пакета <strong>raster</strong> реализует возможности фокальной обработки растров?</li>
<li>Какой эффект оказывает сглаживающая фильтрация на значения растра?</li>
<li>Какие виды производных морфометрических величин позволяет получать функция <code><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain()</a></code> из пакета <strong>raster</strong>?</li>
<li>Какие два растра необходимо рассчитать для построения аналитической отмывки средствами функции <code><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain()</a></code>?</li>
<li>Опишите последовательность действий, которую необходимо выполнить для построения растра <strong>Евклидовых расстояний</strong> от заданных объектов?</li>
<li>Какой метод интерполяции необходимо использовать для передискретизации категориальных растров? В чем заключается принцип его действия?</li>
<li>Какая функция пакета <strong>raster</strong> используется для выполнения зональных операций? Какой тип результата она возвращает?</li>
<li>Опишите возможности функции <code><a href="https://tidyr.tidyverse.org/reference/extract.html">extract()</a></code> по извлечению информации из растровых данных. В какой формате можно задать анализируемые локации? Что будет результатом вызова этой функции в зависимости от формата входных данных?</li>
<li>Опишите последовательность действий, которую необходимо выполнить для построения профиля растровой поверхности средствами <strong>R</strong>.</li>
<li>Можно ли построить профиль по растру, имеющему привязку в географической системе координат (координаты выражены градусах)? Если да, то как добиться того, чтобы расстояния между точками профиля были посчитаны в метрических единицах?</li>
<li>Опишите способ, с помощью которого можно осуществить фильтрацию растра (превратить его в растр <code>TRUE</code>/<code>FALSE</code>) и маскирование растра (заменить ненужные ячейки на NA).</li>
</ol>
</div>
<div id="tasks_raster" class="section level3" number="15.6.2">
<h3>
<span class="header-section-number">15.6.2</span> Упражнения<a class="anchor" aria-label="anchor" href="#tasks_raster"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p><em>Индекс континентальности Хромова</em> рассчитывается по формуле <span class="math inline">\(K = (A - 5.4 \sin \phi)/A\)</span>, где <span class="math inline">\(A\)</span> — годовая амплитуда хода температуры, <span class="math inline">\(\phi\)</span> — широта точки. Используя данные <strong>WorldClim</strong>, рассчитайте растр индекса континентальности на территорию суши и нанесите его на карту средствами <strong>tmap</strong>.</p>
<blockquote>
<p><strong>Подсказка:</strong> используйте функцию <code><a href="https://rdrr.io/pkg/terra/man/xyCellFrom.html">xyFromCell()</a></code>, чтобы получить широты всех ячеек растра температур. Далее создайте новый растр и запишите в него широты в качестве значений. Растры минимальных и максимальных значений из стека растров можно получить, используя обычные статистические функции <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code> и <code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code>.</p>
</blockquote>
</li>
<li><p>Постройте растр, который содержит расстояние до береговой линии. Используйте данные <strong>Natural Earth</strong>. Задайте грубое разрешение растра, чтобы расчеты не производились долго (100 x 50 ячеек будет достаточно). Где находится самая удаленная от берега точка на суше? А самая удаленная точка на океане? Постройте карту, которая отображает полученный растр и береговую линию.</p></li>
<li><p>Рассчитайте морфометрические коэффициенты TPI, TRI и roughness для <a href="https://github.com/tsamsonov/r-geo-course/blob/master/data/dem_fergana.tif">цифровой модели рельефа Ферганской долины</a>, которая использовалась в текущей лекции. В чем их суть? Изучите справку к инструменту <code><a href="https://rdrr.io/pkg/terra/man/terrain.html">terrain()</a></code>.</p></li>
<li><p>В пакете <strong>tmap</strong> содержится растровый каталог <code>land</code>, включающий в себя растр <code>elevation</code>. Используя пакет <strong>mapedit</strong>, оцифруйте произвольную линию и постройте средствами <strong>ggplot</strong> профиль рельефа вдоль этой линии.</p></li>
</ol>
<div class="inline-table"><table class="table table-sm"><tbody><tr class="odd">
<td>
<em>Самсонов Т.Е.</em> <strong>Визуализация и анализ географических данных на языке R.</strong> М.: Географический факультет МГУ, <code>lubridate::year(Sys.Date())</code>. DOI: <a href="https://doi.org/10.5281/zenodo.901911">10.5281/zenodo.901911</a>
</td>
</tr></tbody></table></div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="interp.html"><span class="header-section-number">14</span> Интерполяция геополей</a></div>
<div class="next"><a href="network.html"><span class="header-section-number">16</span> Анализ сетей и траекторий</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#raster"><span class="header-section-number">15</span> Растровый анализ</a></li>
<li><a class="nav-link" href="#%D0%BF%D1%80%D0%B5%D0%B4%D0%B2%D0%B0%D1%80%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%83%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D1%8F">Предварительные условия</a></li>
<li><a class="nav-link" href="#raster_intro"><span class="header-section-number">15.1</span> Введение</a></li>
<li><a class="nav-link" href="#%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C-%D1%80%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B2%D1%8B%D1%85-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-terra"><span class="header-section-number">15.2</span> Модель растровых данных terra</a></li>
<li>
<a class="nav-link" href="#%D1%80%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B2%D0%B0%D1%8F-%D0%B0%D0%BB%D0%B3%D0%B5%D0%B1%D1%80%D0%B0"><span class="header-section-number">15.3</span> Растровая алгебра</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#raster_local"><span class="header-section-number">15.3.1</span> Локальные операции</a></li>
<li><a class="nav-link" href="#raster_focal"><span class="header-section-number">15.3.2</span> Фокальные операции</a></li>
<li><a class="nav-link" href="#raster_zonal"><span class="header-section-number">15.3.3</span> Зональные операции</a></li>
<li><a class="nav-link" href="#raster_global"><span class="header-section-number">15.3.4</span> Глобальные операции</a></li>
</ul>
</li>
<li><a class="nav-link" href="#raster_extract"><span class="header-section-number">15.4</span> Извлечение данных</a></li>
<li><a class="nav-link" href="#temporal_review"><span class="header-section-number">15.5</span> Краткий обзор</a></li>
<li>
<a class="nav-link" href="#questions_tasks_raster"><span class="header-section-number">15.6</span> Контрольные вопросы и упражнения</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#questions_raster"><span class="header-section-number">15.6.1</span> Вопросы</a></li>
<li><a class="nav-link" href="#tasks_raster"><span class="header-section-number">15.6.2</span> Упражнения</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/tsamsonov/r-geo-course/blob/master/15-RasterAnalysis.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/tsamsonov/r-geo-course/edit/master/15-RasterAnalysis.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Визуализация и анализ географических данных на языке R</strong>" was written by Тимофей Самсонов. It was last built on 2022-12-13.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
